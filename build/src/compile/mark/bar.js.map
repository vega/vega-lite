{"version":3,"file":"bar.js","sourceRoot":"","sources":["../../../../src/compile/mark/bar.ts"],"names":[],"mappings":"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","sourcesContent":["import {isNumber} from 'vega-util';\nimport {X, Y} from '../../channel';\nimport {Config} from '../../config';\nimport {isFieldDef} from '../../fielddef';\nimport * as log from '../../log';\nimport {MarkDef} from '../../mark';\nimport {hasDiscreteDomain, ScaleType} from '../../scale';\nimport {isVgRangeStep, VgEncodeEntry} from '../../vega.schema';\nimport {VgValueRef} from '../../vega.schema';\nimport {ScaleComponent} from '../scale/component';\nimport {UnitModel} from '../unit';\nimport {MarkCompiler} from './base';\nimport * as mixins from './mixins';\nimport * as ref from './valueref';\n\n\nexport const bar: MarkCompiler = {\n  vgMark: 'rect',\n  encodeEntry: (model: UnitModel) => {\n    return {\n      ...mixins.baseEncodeEntry(model, {size: 'ignore', orient: 'ignore'}),\n      ...x(model),\n      ...y(model),\n    };\n  }\n};\n\nfunction x(model: UnitModel): VgEncodeEntry {\n  const {config, encoding, markDef, width} = model;\n  const orient = markDef.orient;\n  const sizeDef = encoding.size;\n\n  const xDef = encoding.x;\n  const x2Def = encoding.x2;\n  const xScaleName = model.scaleName(X);\n  const xScale = model.getScaleComponent(X);\n  // x, x2, and width -- we must specify two of these in all conditions\n  if (orient === 'horizontal' || x2Def) {\n    return {\n      ...mixins.pointPosition('x', model, 'zeroOrMin'),\n      ...mixins.pointPosition2(model, 'zeroOrMin', 'x2'),\n    };\n  } else { // vertical\n    if (isFieldDef(xDef)) {\n      const xScaleType = xScale.get('type');\n      if (xDef.bin && !sizeDef && !hasDiscreteDomain(xScaleType)) {\n        return mixins.binnedPosition(\n          xDef, 'x', model.scaleName('x'), markDef.binSpacing === undefined ? config.bar.binSpacing : markDef.binSpacing,\n          xScale.get('reverse')\n        );\n      } else {\n        if (xScaleType === ScaleType.BAND) {\n          return mixins.bandPosition(xDef, 'x', model);\n        }\n      }\n    }\n    // sized bin, normal point-ordinal axis, quantitative x-axis, or no x\n\n    return mixins.centeredBandPosition('x', model,\n      {...ref.mid(width)},\n      defaultSizeRef(markDef, xScaleName, xScale, config)\n    );\n  }\n}\n\nfunction y(model: UnitModel) {\n  const {config, encoding, height, markDef} = model;\n  const orient = markDef.orient;\n  const sizeDef = encoding.size;\n\n  const yDef = encoding.y;\n  const y2Def = encoding.y2;\n  const yScaleName = model.scaleName(Y);\n  const yScale = model.getScaleComponent(Y);\n\n  // y, y2 & height -- we must specify two of these in all conditions\n  if (orient === 'vertical' || y2Def) {\n    return {\n      ...mixins.pointPosition('y', model, 'zeroOrMin'),\n      ...mixins.pointPosition2(model, 'zeroOrMin', 'y2'),\n    };\n  } else {\n    if (isFieldDef(yDef)) {\n      const yScaleType = yScale.get('type');\n      if (yDef.bin && !sizeDef && !hasDiscreteDomain(yScaleType)) {\n        return mixins.binnedPosition(\n          yDef, 'y', model.scaleName('y'),\n          markDef.binSpacing === undefined ? config.bar.binSpacing : markDef.binSpacing,\n          yScale.get('reverse')\n        );\n      } else if (yScaleType === ScaleType.BAND) {\n        return mixins.bandPosition(yDef, 'y', model);\n      }\n    }\n    return mixins.centeredBandPosition('y', model, ref.mid(height),\n      defaultSizeRef(markDef, yScaleName, yScale, config)\n    );\n  }\n}\n\nfunction defaultSizeRef(markDef: MarkDef, scaleName: string, scale: ScaleComponent, config: Config): VgValueRef {\n  if (markDef.size !== undefined) {\n    return {value: markDef.size};\n  } else if (config.bar.discreteBandSize) {\n    return {value: config.bar.discreteBandSize};\n  } else if (scale) {\n    const scaleType = scale.get('type');\n    if (scaleType === ScaleType.POINT) {\n      const scaleRange = scale.get('range');\n      if (isVgRangeStep(scaleRange) && isNumber(scaleRange.step)) {\n        return {value: scaleRange.step - 1};\n      }\n      log.warn(log.message.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL);\n    } else if (scaleType === ScaleType.BAND) {\n      return ref.bandRef(scaleName);\n    } else { // non-ordinal scale\n      return {value: config.bar.continuousBandSize};\n    }\n  } else if (config.scale.rangeStep && config.scale.rangeStep !== null) {\n    return {value: config.scale.rangeStep - 1};\n  }\n  return {value: 20};\n}\n\n"]}