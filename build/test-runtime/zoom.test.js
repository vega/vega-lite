"use strict";
var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var util_1 = require("./util");
var hits = {
    zoom: [9, 23],
    bins: [8, 2]
};
function zoom(key, idx, direction, parent, targetBrush) {
    var delta = direction === 'out' ? 200 : -200;
    return "return zoom(" + hits[key][idx] + ", " + delta + ", " + parent + ", " + targetBrush + ")";
}
var cmp = function (a, b) { return a - b; };
[util_1.bound, util_1.unbound].forEach(function (bind) {
    describe("Zoom " + bind + " interval selections at runtime", function () {
        var type = 'interval';
        var embed = util_1.embedFn(browser);
        var testRender = util_1.testRenderFn(browser, "interval/zoom/" + bind);
        var binding = bind === util_1.bound ? { bind: 'scales' } : {};
        var assertExtent = {
            in: ['isAtLeast', 'isAtMost'], out: ['isAtMost', 'isAtLeast']
        };
        function setup(brushKey, idx, encodings, parent) {
            var inOut = idx % 2 ? 'out' : 'in';
            var xold;
            var yold;
            if (bind === util_1.unbound) {
                var drag = browser.execute(util_1.brush(brushKey, idx, parent)).value[0];
                xold = drag.intervals[0].extent.sort(cmp);
                yold = encodings.indexOf('y') >= 0 ? drag.intervals[encodings.indexOf('x') + 1].extent.sort(cmp) : null;
            }
            else {
                xold = JSON.parse(browser.execute('return JSON.stringify(view._runtime.scales.x.value.domain())').value);
                yold = browser.execute('return view._runtime.scales.y.value.domain()').value;
            }
            return { inOut: inOut, xold: xold, yold: yold };
        }
        it('should zoom in and out', function () {
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding)));
                var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                testRender(inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                var ynew = zoomed.intervals[1].extent.sort(cmp);
                testRender(inOut + "-1");
                chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
            }
        });
        it('should work with binned domains', function () {
            for (var i = 0; i < hits.bins.length; i++) {
                var encodings = ['y'];
                embed(util_1.spec('unit', 1, __assign({ type: type }, binding, { encodings: encodings }), {
                    x: { aggregate: 'count', field: '*', type: 'quantitative' },
                    y: { bin: true },
                    color: { value: 'steelblue', field: null, type: null }
                }));
                var _a = setup('bins', i, encodings), inOut = _a.inOut, yold = _a.yold;
                testRender("bins_" + inOut + "-0");
                var zoomed = browser.execute(zoom('bins', i, inOut, null, bind === util_1.unbound)).value[0];
                var ynew = zoomed.intervals[0].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                testRender("bins_" + inOut + "-1");
            }
        });
        it('should work with temporal domains', function () {
            var values = util_1.tuples.map(function (d) { return (__assign({}, d, { a: new Date(2017, d.a) })); });
            var encodings = ['x'];
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding, { encodings: encodings }), { values: values, x: { type: 'temporal' } }));
                var _a = setup('drag', i, encodings), inOut = _a.inOut, xold = _a.xold;
                testRender("temporal_" + inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](+xnew[0], +(new Date(xold[0])));
                chai_1.assert[assertExtent[inOut][1]](+xnew[1], +(new Date(xold[1])));
                testRender("temporal_" + inOut + "-1");
            }
        });
        it('should work with log/pow scales', function () {
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding), {
                    x: { scale: { type: 'pow', exponent: 1.5 } },
                    y: { scale: { type: 'log' } }
                }));
                var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                testRender("logpow_" + inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                var ynew = zoomed.intervals[1].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                testRender("logpow_" + inOut + "-1");
            }
        });
        if (bind === util_1.unbound) {
            it('should work with ordinal/nominal domains', function () {
                for (var i = 0; i < hits.zoom.length; i++) {
                    embed(util_1.spec('unit', i, __assign({ type: type }, binding), {
                        x: { type: 'ordinal' }, y: { type: 'nominal' }
                    }));
                    var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                    testRender("ord_" + inOut + "-0");
                    var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                    var xnew = zoomed.intervals[0].extent.sort(cmp);
                    var ynew = zoomed.intervals[1].extent.sort(cmp);
                    if (inOut === 'in') {
                        chai_1.assert.isAtMost(xnew.length, xold.length);
                        chai_1.assert.isAtMost(ynew.length, yold.length);
                    }
                    else {
                        chai_1.assert.isAtLeast(xnew.length, xold.length);
                        chai_1.assert.isAtLeast(ynew.length, yold.length);
                    }
                    testRender("ord_" + inOut + "-1");
                }
            });
        }
        else {
            util_1.compositeTypes.forEach(function (specType) {
                it("should work with shared scales in " + specType + " views", function () {
                    for (var i = 0; i < hits.bins.length; i++) {
                        embed(util_1.spec(specType, 0, __assign({ type: type }, binding), { resolve: { scale: { x: 'shared', y: 'shared' } } }));
                        var parent_1 = util_1.parentSelector(specType, i);
                        var _a = setup(specType, i, ['x', 'y'], parent_1), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                        var zoomed = browser.execute(zoom('bins', i, inOut, null, bind === util_1.unbound)).value[0];
                        var xnew = zoomed.intervals[0].extent.sort(cmp);
                        var ynew = zoomed.intervals[1].extent.sort(cmp);
                        chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                        chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                        chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                        chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                        testRender(specType + "_" + inOut);
                    }
                });
            });
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem9vbS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdGVzdC1ydW50aW1lL3pvb20udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQVVnQjtBQUVoQixJQUFNLElBQUksR0FBRztJQUNYLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDYixJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ2IsQ0FBQztBQUlGLGNBQWMsR0FBVyxFQUFFLEdBQVcsRUFBRSxTQUFnQixFQUFFLE1BQWUsRUFBRSxXQUFxQjtJQUM5RixJQUFNLEtBQUssR0FBRyxTQUFTLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQy9DLE9BQU8saUJBQWUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFLLEtBQUssVUFBSyxNQUFNLFVBQUssV0FBVyxNQUFHLENBQUM7QUFDL0UsQ0FBQztBQUVELElBQU0sR0FBRyxHQUFHLFVBQUMsQ0FBUyxFQUFFLENBQVMsSUFBSyxPQUFBLENBQUMsR0FBRyxDQUFDLEVBQUwsQ0FBSyxDQUFDO0FBRTVDLENBQUMsWUFBSyxFQUFFLGNBQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFTLElBQUk7SUFDcEMsUUFBUSxDQUFDLFVBQVEsSUFBSSxvQ0FBaUMsRUFBRTtRQUN0RCxJQUFNLElBQUksR0FBRyxVQUFVLENBQUM7UUFDeEIsSUFBTSxLQUFLLEdBQUcsY0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9CLElBQU0sVUFBVSxHQUFHLG1CQUFZLENBQUMsT0FBTyxFQUFFLG1CQUFpQixJQUFNLENBQUMsQ0FBQztRQUNsRSxJQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssWUFBSyxDQUFDLENBQUMsQ0FBQyxFQUFDLElBQUksRUFBRSxRQUFRLEVB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Q0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNqRCxVQUFVLENBQUksUUFBUSxTQUFJLEtBQU8sQ0FBQyxDQUFDO3FCQUNwQztnQkFDSCxDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHthc3NlcnR9IGZyb20gJ2NoYWknO1xuaW1wb3J0IHtcbiAgYm91bmQsXG4gIGJydXNoLFxuICBjb21wb3NpdGVUeXBlcyxcbiAgZW1iZWRGbixcbiAgcGFyZW50U2VsZWN0b3IsXG4gIHNwZWMsXG4gIHRlc3RSZW5kZXJGbixcbiAgdHVwbGVzLFxuICB1bmJvdW5kLFxufSBmcm9tICcuL3V0aWwnO1xuXG5jb25zdCBoaXRzID0ge1xuICB6b29tOiBbOSwgMjNdLFxuICBiaW5zOiBbOCwgMl1cbn07XG5cbnR5cGUgSW5PdXQgPSAnaW4nIHwgJ291dCc7XG5cbmZ1bmN0aW9uIHpvb20oa2V5OiBzdHJpbmcsIGlkeDogbnVtYmVyLCBkaXJlY3Rpb246IEluT3V0LCBwYXJlbnQ/OiBzdHJpbmcsIHRhcmdldEJydXNoPzogYm9vbGVhbikge1xuICBjb25zdCBkZWx0YSA9IGRpcmVjdGlvbiA9PT0gJ291dCcgPyAyMDAgOiAtMjAwO1xuICByZXR1cm4gYHJldHVybiB6b29tKCR7aGl0c1trZXldW2lkeF19LCAke2RlbHRhfSwgJHtwYXJlbnR9LCAke3RhcmdldEJydXNofSlgO1xufVxuXG5jb25zdCBjbXAgPSAoYTogbnVtYmVyLCBiOiBudW1iZXIpID0+IGEgLSBiO1xuXG5bYm91bmQsIHVuYm91bmRdLmZvckVhY2goZnVuY3Rpb24oYmluZCkge1xuICBkZXNjcmliZShgWm9vbSAke2JpbmR9IGludGVydmFsIHNlbGVjdGlvbnMgYXQgcnVudGltZWAsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHR5cGUgPSAnaW50ZXJ2YWwnO1xuICAgIGNvbnN0IGVtYmVkID0gZW1iZWRGbihicm93c2VyKTtcbiAgICBjb25zdCB0ZXN0UmVuZGVyID0gdGVzdFJlbmRlckZuKGJyb3dzZXIsIGBpbnRlcnZhbC96b29tLyR7YmluZH1gKTtcbiAgICBjb25zdCBiaW5kaW5nID0gYmluZCA9PT0gYm91bmQgPyB7YmluZDogJ3NjYWxlcyd9IDoge307XG5cbiAgICBjb25zdCBhc3NlcnRFeHRlbnQgPSB7XG4gICAgICBpbjogWydpc0F0TGVhc3QnLCAnaXNBdE1vc3QnXSwgb3V0OiBbJ2lzQXRNb3N0JywgJ2lzQXRMZWFzdCddXG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIHNldHVwKGJydXNoS2V5OiBzdHJpbmcsIGlkeDogbnVtYmVyLCBlbmNvZGluZ3M6IHN0cmluZ1tdLCBwYXJlbnQ/OiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IGluT3V0OiBJbk91dCA9IGlkeCAlIDIgPyAnb3V0JyA6ICdpbic7XG4gICAgICBsZXQgeG9sZDogbnVtYmVyW107XG4gICAgICBsZXQgeW9sZDogbnVtYmVyW107XG5cbiAgICAgIGlmIChiaW5kID09PSB1bmJvdW5kKSB7XG4gICAgICAgIGNvbnN0IGRyYWcgPSBicm93c2VyLmV4ZWN1dGUoYnJ1c2goYnJ1c2hLZXksIGlkeCwgcGFyZW50KSkudmFsdWVbMF07XG4gICAgICAgIHhvbGQgPSBkcmFnLmludGVydmFsc1swXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICB5b2xkID0gZW5jb2RpbmdzLmluZGV4T2YoJ3knKSA+PSAwID8gZHJhZy5pbnRlcnZhbHNbZW5jb2RpbmdzLmluZGV4T2YoJ3gnKSArIDFdLmV4dGVudC5zb3J0KGNtcCkgOiBudWxsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgeG9sZCA9IEpTT04ucGFyc2UoYnJvd3Nlci5leGVjdXRlKCdyZXR1cm4gSlNPTi5zdHJpbmdpZnkodmlldy5fcnVudGltZS5zY2FsZXMueC52YWx1ZS5kb21haW4oKSknKS52YWx1ZSk7XG4gICAgICAgIHlvbGQgPSBicm93c2VyLmV4ZWN1dGUoJ3JldHVybiB2aWV3Ll9ydW50aW1lLnNjYWxlcy55LnZhbHVlLmRvbWFpbigpJykudmFsdWU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7aW5PdXQsIHhvbGQsIHlvbGR9O1xuICAgIH1cblxuICAgIGl0KCdzaG91bGQgem9vbSBpbiBhbmQgb3V0JywgZnVuY3Rpb24oKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhpdHMuem9vbS5sZW5ndGg7IGkrKykge1xuICAgICAgICBlbWJlZChzcGVjKCd1bml0JywgaSwge3R5cGUsIC4uLmJpbmRpbmd9KSk7XG4gICAgICAgIGNvbnN0IHtpbk91dCwgeG9sZCwgeW9sZH0gPSBzZXR1cCgnZHJhZycsIGksIFsneCcsICd5J10pO1xuICAgICAgICB0ZXN0UmVuZGVyKGAke2luT3V0fS0wYCk7XG5cbiAgICAgICAgY29uc3Qgem9vbWVkID0gYnJvd3Nlci5leGVjdXRlKHpvb20oJ3pvb20nLCBpLCBpbk91dCwgbnVsbCwgYmluZCA9PT0gdW5ib3VuZCkpLnZhbHVlWzBdO1xuICAgICAgICBjb25zdCB4bmV3ID0gem9vbWVkLmludGVydmFsc1swXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICBjb25zdCB5bmV3ID0gem9vbWVkLmludGVydmFsc1sxXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICB0ZXN0UmVuZGVyKGAke2luT3V0fS0xYCk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzBdXSh4bmV3WzBdLCB4b2xkWzBdKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMV1dKHhuZXdbMV0sIHhvbGRbMV0pO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeW5ld1swXSwgeW9sZFswXSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzFdXSh5bmV3WzFdLCB5b2xkWzFdKTtcblxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggYmlubmVkIGRvbWFpbnMnLCBmdW5jdGlvbigpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGl0cy5iaW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGVuY29kaW5ncyA9IFsneSddO1xuICAgICAgICBlbWJlZChzcGVjKCd1bml0JywgMSwge3R5cGUsIC4uLmJpbmRpbmcsIGVuY29kaW5nc30sIHtcbiAgICAgICAgICB4OiB7YWdncmVnYXRlOiAnY291bnQnLCBmaWVsZDogJyonLCB0eXBlOiAncXVhbnRpdGF0aXZlJ30sXG4gICAgICAgICAgeToge2JpbjogdHJ1ZX0sXG4gICAgICAgICAgY29sb3I6IHt2YWx1ZTogJ3N0ZWVsYmx1ZScsIGZpZWxkOiBudWxsLCB0eXBlOiBudWxsfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgY29uc3Qge2luT3V0LCB5b2xkfSA9IHNldHVwKCdiaW5zJywgaSwgZW5jb2RpbmdzKTtcbiAgICAgICAgdGVzdFJlbmRlcihgYmluc18ke2luT3V0fS0wYCk7XG5cbiAgICAgICAgY29uc3Qgem9vbWVkID0gYnJvd3Nlci5leGVjdXRlKHpvb20oJ2JpbnMnLCBpLCBpbk91dCwgbnVsbCwgYmluZCA9PT0gdW5ib3VuZCkpLnZhbHVlWzBdO1xuICAgICAgICBjb25zdCB5bmV3ID0gem9vbWVkLmludGVydmFsc1swXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeW5ld1swXSwgeW9sZFswXSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzFdXSh5bmV3WzFdLCB5b2xkWzFdKTtcbiAgICAgICAgdGVzdFJlbmRlcihgYmluc18ke2luT3V0fS0xYCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCB0ZW1wb3JhbCBkb21haW5zJywgZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCB2YWx1ZXMgPSB0dXBsZXMubWFwKChkKSA9PiAoey4uLmQsIGE6IG5ldyBEYXRlKDIwMTcsIGQuYSl9KSk7XG4gICAgICBjb25zdCBlbmNvZGluZ3MgPSBbJ3gnXTtcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXRzLnpvb20ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgZW1iZWQoc3BlYygndW5pdCcsIGksIHt0eXBlLCAuLi5iaW5kaW5nLCBlbmNvZGluZ3N9LFxuICAgICAgICAgIHt2YWx1ZXMsIHg6IHt0eXBlOiAndGVtcG9yYWwnfX0pKTtcbiAgICAgICAgY29uc3Qge2luT3V0LCB4b2xkfSA9IHNldHVwKCdkcmFnJywgaSwgZW5jb2RpbmdzKTtcbiAgICAgICAgdGVzdFJlbmRlcihgdGVtcG9yYWxfJHtpbk91dH0tMGApO1xuXG4gICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCd6b29tJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgY29uc3QgeG5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKCt4bmV3WzBdLCArKG5ldyBEYXRlKHhvbGRbMF0pKSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzFdXSgreG5ld1sxXSwgKyhuZXcgRGF0ZSh4b2xkWzFdKSkpO1xuICAgICAgICB0ZXN0UmVuZGVyKGB0ZW1wb3JhbF8ke2luT3V0fS0xYCk7XG4gICAgICB9XG5cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIGxvZy9wb3cgc2NhbGVzJywgZnVuY3Rpb24oKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhpdHMuem9vbS5sZW5ndGg7IGkrKykge1xuICAgICAgICBlbWJlZChzcGVjKCd1bml0JywgaSwge3R5cGUsIC4uLmJpbmRpbmd9LCB7XG4gICAgICAgICAgeDoge3NjYWxlOiB7dHlwZTogJ3BvdycsIGV4cG9uZW50OiAxLjV9fSxcbiAgICAgICAgICB5OiB7c2NhbGU6IHt0eXBlOiAnbG9nJ319XG4gICAgICAgIH0pKTtcbiAgICAgICAgY29uc3Qge2luT3V0LCB4b2xkLCB5b2xkfSA9IHNldHVwKCdkcmFnJywgaSwgWyd4JywgJ3knXSk7XG4gICAgICAgIHRlc3RSZW5kZXIoYGxvZ3Bvd18ke2luT3V0fS0wYCk7XG5cbiAgICAgICAgY29uc3Qgem9vbWVkID0gYnJvd3Nlci5leGVjdXRlKHpvb20oJ3pvb20nLCBpLCBpbk91dCwgbnVsbCwgYmluZCA9PT0gdW5ib3VuZCkpLnZhbHVlWzBdO1xuICAgICAgICBjb25zdCB4bmV3ID0gem9vbWVkLmludGVydmFsc1swXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICBjb25zdCB5bmV3ID0gem9vbWVkLmludGVydmFsc1sxXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeG5ld1swXSwgeG9sZFswXSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzFdXSh4bmV3WzFdLCB4b2xkWzFdKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHluZXdbMF0sIHlvbGRbMF0pO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeW5ld1sxXSwgeW9sZFsxXSk7XG4gICAgICAgIHRlc3RSZW5kZXIoYGxvZ3Bvd18ke2luT3V0fS0xYCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoYmluZCA9PT0gdW5ib3VuZCkge1xuICAgICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggb3JkaW5hbC9ub21pbmFsIGRvbWFpbnMnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXRzLnpvb20ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBlbWJlZChzcGVjKCd1bml0JywgaSwge3R5cGUsIC4uLmJpbmRpbmd9LCB7XG4gICAgICAgICAgICB4OiB7dHlwZTogJ29yZGluYWwnfSwgeToge3R5cGU6ICdub21pbmFsJ31cbiAgICAgICAgICB9KSk7XG4gICAgICAgICAgY29uc3Qge2luT3V0LCB4b2xkLCB5b2xkfSA9IHNldHVwKCdkcmFnJywgaSwgWyd4JywgJ3knXSk7XG4gICAgICAgICAgdGVzdFJlbmRlcihgb3JkXyR7aW5PdXR9LTBgKTtcblxuICAgICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCd6b29tJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgICBjb25zdCB4bmV3ID0gem9vbWVkLmludGVydmFsc1swXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICAgIGNvbnN0IHluZXcgPSB6b29tZWQuaW50ZXJ2YWxzWzFdLmV4dGVudC5zb3J0KGNtcCk7XG5cbiAgICAgICAgICBpZiAoaW5PdXQgPT09ICdpbicpIHtcbiAgICAgICAgICAgIGFzc2VydC5pc0F0TW9zdCh4bmV3Lmxlbmd0aCwgeG9sZC5sZW5ndGgpO1xuICAgICAgICAgICAgYXNzZXJ0LmlzQXRNb3N0KHluZXcubGVuZ3RoLCB5b2xkLmxlbmd0aCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydC5pc0F0TGVhc3QoeG5ldy5sZW5ndGgsIHhvbGQubGVuZ3RoKTtcbiAgICAgICAgICAgIGFzc2VydC5pc0F0TGVhc3QoeW5ldy5sZW5ndGgsIHlvbGQubGVuZ3RoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0ZXN0UmVuZGVyKGBvcmRfJHtpbk91dH0tMWApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29tcG9zaXRlVHlwZXMuZm9yRWFjaChmdW5jdGlvbihzcGVjVHlwZSkge1xuICAgICAgICBpdChgc2hvdWxkIHdvcmsgd2l0aCBzaGFyZWQgc2NhbGVzIGluICR7c3BlY1R5cGV9IHZpZXdzYCwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXRzLmJpbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGVtYmVkKHNwZWMoc3BlY1R5cGUsIDAsIHt0eXBlLCAuLi5iaW5kaW5nfSxcbiAgICAgICAgICAgICAge3Jlc29sdmU6IHtzY2FsZToge3g6ICdzaGFyZWQnLCB5OiAnc2hhcmVkJ319fSkpO1xuICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gcGFyZW50U2VsZWN0b3Ioc3BlY1R5cGUsIGkpO1xuICAgICAgICAgICAgY29uc3Qge2luT3V0LCB4b2xkLCB5b2xkfSA9IHNldHVwKHNwZWNUeXBlLCBpLCBbJ3gnLCAneSddLCBwYXJlbnQpO1xuICAgICAgICAgICAgY29uc3Qgem9vbWVkID0gYnJvd3Nlci5leGVjdXRlKHpvb20oJ2JpbnMnLCBpLCBpbk91dCwgbnVsbCwgYmluZCA9PT0gdW5ib3VuZCkpLnZhbHVlWzBdO1xuICAgICAgICAgICAgY29uc3QgeG5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgICAgIGNvbnN0IHluZXcgPSB6b29tZWQuaW50ZXJ2YWxzWzFdLmV4dGVudC5zb3J0KGNtcCk7XG4gICAgICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeG5ld1swXSwgeG9sZFswXSk7XG4gICAgICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeG5ld1sxXSwgeG9sZFsxXSk7XG4gICAgICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeW5ld1swXSwgeW9sZFswXSk7XG4gICAgICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeW5ld1sxXSwgeW9sZFsxXSk7XG4gICAgICAgICAgICB0ZXN0UmVuZGVyKGAke3NwZWNUeXBlfV8ke2luT3V0fWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufSk7XG4iXX0=