!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).vl={})}(this,function(t){"use strict";var e="3.0.0-rc12";function n(t,e,n){return t.fields=e||[],t.fname=n,t}function r(t){throw Error(t)}function i(t){var e,n,i,s=[],o=null,a=0,c=t.length,u="";function l(){s.push(u+t.substring(e,n)),u="",e=n+1}for(t+="",e=n=0;n<c;++n)if("\\"===(i=t[n]))u+=t.substring(e,n),e=++n;else if(i===o)l(),o=null,a=-1;else{if(o)continue;e===a&&'"'===i?(e=n+1,o=i):e===a&&"'"===i?(e=n+1,o=i):"."!==i||a?"["===i?(n>e&&l(),a=e=n+1):"]"===i&&(a||r("Access path missing open bracket: "+t),a>0&&l(),a=0,e=n+1):n>e?l():e=n+1}return a&&r("Access path missing closing bracket: "+t),o&&r("Access path missing closing quote: "+t),n>e&&(n++,l()),s}var s=Array.isArray;function o(t){return t===Object(t)}function a(t){return"string"==typeof t}function c(t){return s(t)?"["+t.map(c)+"]":o(t)||a(t)?JSON.stringify(t).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):t}var u=[];(function(t,e){var r=i(t),s="return _["+r.map(c).join("][")+"];";n(Function("_",s),[t=1===r.length?r[0]:t],e||t)})("id"),n(function(t){return t},u,"identity"),n(function(){return 0},u,"zero"),n(function(){return 1},u,"one"),n(function(){return!0},u,"true"),n(function(){return!1},u,"false");function l(t,e,n){var r=[e].concat([].slice.call(n));console[t].apply(console,r)}var f=0,d=1,p=2,m=3,h=4;function g(t){return"boolean"==typeof t}function b(t){return"number"==typeof t}function v(t){for(var e={},n=0,r=t.length;n<r;++n)e[t[n]]=!0;return e}var x,y=(function(t){var e=function(){function t(t,e){return null!=e&&t instanceof e}var e,n,r;try{e=Map}catch(t){e=function(){}}try{n=Set}catch(t){n=function(){}}try{r=Promise}catch(t){r=function(){}}function i(s,a,c,u,l){"object"==typeof a&&(c=a.depth,u=a.prototype,l=a.includeNonEnumerable,a=a.circular);var f=[],d=[],p="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===c&&(c=1/0),function s(c,m){if(null===c)return null;if(0===m)return c;var h,g;if("object"!=typeof c)return c;if(t(c,e))h=new e;else if(t(c,n))h=new n;else if(t(c,r))h=new r(function(t,e){c.then(function(e){t(s(e,m-1))},function(t){e(s(t,m-1))})});else if(i.__isArray(c))h=[];else if(i.__isRegExp(c))h=new RegExp(c.source,o(c)),c.lastIndex&&(h.lastIndex=c.lastIndex);else if(i.__isDate(c))h=new Date(c.getTime());else{if(p&&Buffer.isBuffer(c))return h=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(h),h;t(c,Error)?h=Object.create(c):void 0===u?(g=Object.getPrototypeOf(c),h=Object.create(g)):(h=Object.create(u),g=u)}if(a){var b=f.indexOf(c);if(-1!=b)return d[b];f.push(c),d.push(h)}for(var v in t(c,e)&&c.forEach(function(t,e){var n=s(e,m-1),r=s(t,m-1);h.set(n,r)}),t(c,n)&&c.forEach(function(t){var e=s(t,m-1);h.add(e)}),c){var x;g&&(x=Object.getOwnPropertyDescriptor(g,v)),x&&null==x.set||(h[v]=s(c[v],m-1))}if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(c);for(v=0;v<y.length;v++){var S=y[v];(!(k=Object.getOwnPropertyDescriptor(c,S))||k.enumerable||l)&&(h[S]=s(c[S],m-1),k.enumerable||Object.defineProperty(h,S,{enumerable:!1}))}}if(l){var O=Object.getOwnPropertyNames(c);for(v=0;v<O.length;v++){var k,E=O[v];(k=Object.getOwnPropertyDescriptor(c,E))&&k.enumerable||(h[E]=s(c[E],m-1),Object.defineProperty(h,E,{enumerable:!1}))}}return h}(s,c)}function s(t){return Object.prototype.toString.call(t)}function o(t){var e="";return t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),e}return i.clonePrototype=function(t){if(null===t)return null;var e=function(){};return e.prototype=t,new e},i.__objToStr=s,i.__isDate=function(t){return"object"==typeof t&&"[object Date]"===s(t)},i.__isArray=function(t){return"object"==typeof t&&"[object Array]"===s(t)},i.__isRegExp=function(t){return"object"==typeof t&&"[object RegExp]"===s(t)},i.__getRegExpFlags=o,i}();t.exports&&(t.exports=e)}(x={exports:{}},x.exports),x.exports),S=Array.isArray,O=Object.keys,k=Object.prototype.hasOwnProperty,E=function(t,e){e||(e={}),"function"==typeof e&&(e={cmp:e});var n,r="boolean"==typeof e.cycles&&e.cycles,i=e.cmp&&(n=e.cmp,function(t){return function(e,r){var i={key:e,value:t[e]},s={key:r,value:t[r]};return n(i,s)}}),s=[];return function t(e){if(e&&e.toJSON&&"function"==typeof e.toJSON&&(e=e.toJSON()),void 0!==e){if("number"==typeof e)return isFinite(e)?""+e:"null";if("object"!=typeof e)return JSON.stringify(e);var n,o;if(Array.isArray(e)){for(o="[",n=0;n<e.length;n++)n&&(o+=","),o+=t(e[n])||"null";return o+"]"}if(null===e)return"null";if(-1!==s.indexOf(e)){if(r)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var a=s.push(e)-1,c=Object.keys(e).sort(i&&i(e));for(o="",n=0;n<c.length;n++){var u=c[n],l=t(e[u]);l&&(o&&(o+=","),o+=JSON.stringify(u)+":"+l)}return s.splice(a,1),"{"+o+"}"}}(t)};function j(t){return!!t.or}function _(t){return!!t.and}function A(t){return!!t.not}function w(t,e){return A(t)?{not:w(t.not,e)}:_(t)?{and:t.and.map(t=>w(t,e))}:j(t)?{or:t.or.map(t=>w(t,e))}:e(t)}const z=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){var r,i,s,o=S(e),a=S(n);if(o&&a){if((i=e.length)!=n.length)return!1;for(r=i;0!=r--;)if(!t(e[r],n[r]))return!1;return!0}if(o!=a)return!1;var c=e instanceof Date,u=n instanceof Date;if(c!=u)return!1;if(c&&u)return e.getTime()==n.getTime();var l=e instanceof RegExp,f=n instanceof RegExp;if(l!=f)return!1;if(l&&f)return e.toString()==n.toString();var d=O(e);if((i=d.length)!==O(n).length)return!1;for(r=i;0!=r--;)if(!k.call(n,d[r]))return!1;for(r=i;0!=r--;)if(!t(e[s=d[r]],n[s]))return!1;return!0}return e!=e&&n!=n},L=y;function I(t){return new RegExp(`\\b${t}\\b`,"g")}function T(t,e){const n={};for(const r of e)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function R(t,e){const n=Object.assign({},t);for(const t of e)delete n[t];return n}Set.prototype.toJSON=function(){return`Set(${[...this].map(E).join(",")})`};const U=E;function M(t){if(b(t))return t;const e=a(t)?t:E(t);if(e.length<250)return e;let n=0;for(let t=0;t<e.length;t++){n=(n<<5)-n+e.charCodeAt(t),n&=n}return n}function N(t,e){return t.indexOf(e)>-1}function P(t,e){return t.filter(t=>!N(e,t))}function C(t,e){let n=0;for(let r=0;r<t.length;r++)if(e(t[r],r,n++))return!0;return!1}function H(t,e){let n=0;for(let r=0;r<t.length;r++)if(!e(t[r],r,n++))return!1;return!0}function q(t){return[].concat(...t)}function W(t,...e){for(const n of e)t=$(t,n);return t}function $(t,e){if("object"!=typeof e||null===e)return t;for(const n in e)e.hasOwnProperty(n)&&void 0!==e[n]&&("object"!=typeof e[n]||s(e[n])||null===e[n]?t[n]=e[n]:"object"!=typeof t[n]||null===t[n]?t[n]=W(s(e[n].constructor)?[]:{},e[n]):W(t[n],e[n]));return t}function Y(t,e){const n=[],r={};let i;for(const s of t)(i=e(s))in r||(r[i]=1,n.push(s));return n}function G(t,e){if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;return!0}function B(t,e){for(const n of t)if(e.has(n))return!0;return!1}function V(t){const e=new Set;for(const n of t){const t=i(n).map((t,e)=>0===e?t:`[${t}]`);t.map((e,n)=>t.slice(0,n+1).join("")).forEach(t=>e.add(t))}return e}function Q(t,e){return B(V(t),V(e))}const K=Object.keys;function J(t){const e=[];for(const n in t)t.hasOwnProperty(n)&&e.push(t[n]);return e}function X(t){return K(t)}function Z(t){return!0===t||!1===t}function D(t){const e=t.replace(/\W/g,"_");return(t.match(/^\d+/)?"_":"")+e}function F(t,e){return A(t)?"!("+F(t.not,e)+")":_(t)?"("+t.and.map(t=>F(t,e)).join(") && (")+")":j(t)?"("+t.or.map(t=>F(t,e)).join(") || (")+")":e(t)}function tt(t,e){if(0===e.length)return!0;const n=e.shift();return tt(t[n],e)&&delete t[n],0===K(t).length}function et(t){return t.charAt(0).toUpperCase()+t.substr(1)}function nt(t,e="datum"){const n=i(t),r=[];for(let t=1;t<=n.length;t++){const i=`[${n.slice(0,t).map(c).join("][")}]`;r.push(`${e}${i}`)}return r.join(" && ")}function rt(t,e="datum"){return`${e}[${c(i(t).join("."))}]`}function it(t){return`${i(t).map(t=>t.replace(".","\\.")).join("\\.")}`}function st(t){return`${i(t).join(".")}`}function ot(t){return t?i(t).length:0}function at(...t){for(const e of t)if(void 0!==e)return e}let ct=42;function ut(t){const e=++ct;return t?String(t)+e:e}var lt=Object.freeze({deepEqual:z,duplicate:L,globalWholeWordRegExp:I,pick:T,omit:R,stringify:U,hash:M,contains:N,without:P,union:function(t,e){return t.concat(P(e,t))},some:C,every:H,flatten:q,fill:function(t,e){const n=new Array(e);for(let r=0;r<e;++r)n[r]=t;return n},mergeDeep:W,unique:Y,isEqual:function(t,e){const n=K(t),r=K(e);if(n.length!==r.length)return!1;for(const r of n)if(t[r]!==e[r])return!1;return!0},setEqual:G,hasIntersection:B,prefixGenerator:V,fieldIntersection:Q,isNumeric:function(t){return!isNaN(t)},differArray:function(t,e){if(t.length!==e.length)return!0;t.sort(),e.sort();for(let n=0;n<t.length;n++)if(e[n]!==t[n])return!0;return!1},keys:K,vals:J,entries:function(t){const e=[];for(const n in t)t.hasOwnProperty(n)&&e.push({key:n,value:t[n]});return e},flagKeys:X,isBoolean:Z,varName:D,logicalExpr:F,deleteNestedProperty:tt,titlecase:et,accessPathWithDatum:nt,flatAccessWithDatum:rt,replacePathInField:it,removePathFromField:st,accessPathDepth:ot,getFirstDefined:at,uniqueId:ut,resetIdCounter:function(){ct=42}});const ft={argmax:1,argmin:1,average:1,count:1,distinct:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},dt=X(ft);function pt(t){return!!ft[t]}const mt=["count","valid","missing","distinct"];function ht(t){return t&&N(mt,t)}function gt(t){return t&&N(["min","max"],t)}const bt=["count","sum","distinct","valid","missing"],vt=["mean","average","median","q1","q3","min","max"],xt=v(vt);var yt=Object.freeze({AGGREGATE_OPS:dt,isAggregateOp:pt,COUNTING_OPS:mt,isCountingAggregateOp:ht,isMinMaxOp:gt,SUM_OPS:bt,SHARED_DOMAIN_OPS:vt,SHARED_DOMAIN_OP_INDEX:xt});const St=["domain","grid","labels","ticks","title"],Ot={grid:"grid",gridColor:"grid",gridDash:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"both",domain:"main",domainColor:"main",domainOpacity:"main",domainWidth:"main",format:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontWeight:"main",labelLimit:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",maxExtent:"main",minExtent:"main",offset:"main",position:"main",tickColor:"main",tickExtra:"main",tickOffset:"both",tickOpacity:"main",tickRound:"main",ticks:"main",tickSize:"main",title:"main",titleAlign:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontWeight:"main",titleLimit:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",tickWidth:"both",tickCount:"both",values:"both",scale:"both",zindex:"both"},kt={orient:1,bandPosition:1,domain:1,domainColor:1,domainOpacity:1,domainWidth:1,format:1,grid:1,gridColor:1,gridDash:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,maxExtent:1,minExtent:1,offset:1,position:1,tickColor:1,tickCount:1,tickExtra:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,values:1,zindex:1},Et=Object.assign({},kt,{encoding:1,labelAngle:1,tickStep:1});function jt(t){return!!Et[t]}const _t=X(Object.assign({gridScale:1,scale:1},kt,{encode:1})),At=X(Et);var wt,zt=Object.freeze({AXIS_PARTS:St,AXIS_PROPERTY_TYPE:Ot,isAxisProperty:jt,VG_AXIS_PROPERTIES:_t,AXIS_PROPERTIES:At});function Lt(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}!function(t){t.ROW="row",t.COLUMN="column",t.X="x",t.Y="y",t.X2="x2",t.Y2="y2",t.XERROR="xError",t.YERROR="yError",t.XERROR2="xError2",t.YERROR2="yError2",t.LATITUDE="latitude",t.LONGITUDE="longitude",t.LATITUDE2="latitude2",t.LONGITUDE2="longitude2",t.COLOR="color",t.FILL="fill",t.STROKE="stroke",t.SHAPE="shape",t.SIZE="size",t.OPACITY="opacity",t.FILLOPACITY="fillOpacity",t.STROKEOPACITY="strokeOpacity",t.STROKEWIDTH="strokeWidth",t.TEXT="text",t.ORDER="order",t.DETAIL="detail",t.KEY="key",t.TOOLTIP="tooltip",t.HREF="href"}(wt||(wt={}));const It=wt.X,Tt=wt.Y,Rt=wt.X2,Ut=wt.Y2,Mt=wt.XERROR,Nt=wt.YERROR,Pt=wt.XERROR2,Ct=wt.YERROR2,Ht=wt.LATITUDE,qt=wt.LATITUDE2,Wt=wt.LONGITUDE,$t=wt.LONGITUDE2,Yt=wt.ROW,Gt=wt.COLUMN,Bt=wt.SHAPE,Vt=wt.SIZE,Qt=wt.COLOR,Kt=wt.FILL,Jt=wt.STROKE,Xt=wt.TEXT,Zt=wt.DETAIL,Dt=wt.KEY,Ft=wt.ORDER,te=wt.OPACITY,ee=wt.FILLOPACITY,ne=wt.STROKEOPACITY,re=wt.STROKEWIDTH,ie=wt.TOOLTIP,se=wt.HREF,oe={longitude:1,longitude2:1,latitude:1,latitude2:1},ae=X(oe),ce=Object.assign({x:1,y:1,x2:1,y2:1,xError:1,yError:1,xError2:1,yError2:1},oe,{color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,size:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1});function ue(t){return"color"===t||"fill"===t||"stroke"===t}const le=Object.assign({},ce,{row:1,column:1}),fe=X(le),de=X(Lt(le,["order","detail"]));function pe(t){return!!le[t]}function me(t){return he(t)!==t}function he(t){switch(t){case"x2":return"x";case"y2":return"y";case"latitude2":return"latitude";case"longitude2":return"longitude"}return t}const ge=X(ce),be=Lt(ce,["x","y","x2","y2","xError","yError","xError2","yError2","latitude","longitude","latitude2","longitude2"]),ve=X(be),xe={x:1,y:1},ye=X(xe),Se=Lt(be,["text","tooltip","href","detail","key","order"]),Oe=X(Se);function ke(t){return!!be[t]}const Ee=Object.assign({},xe,Se),je=X(Ee);function _e(t){return!!Ee[t]}function Ae(t,e){return function(t){switch(t){case Qt:case Kt:case Jt:case Zt:case Dt:case ie:case se:case Ft:case te:case ee:case ne:case re:case Yt:case Gt:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",rect:"always",line:"always",trail:"always",area:"always",text:"always",geoshape:"always"};case It:case Tt:case Ht:case Wt:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",rect:"always",line:"always",trail:"always",area:"always",text:"always"};case Rt:case Ut:case qt:case $t:return{rule:"always",bar:"always",rect:"always",area:"always",circle:"binned",point:"binned",square:"binned",tick:"binned"};case Vt:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case Bt:return{point:"always",geoshape:"always"};case Xt:return{text:"always"};case Mt:case Nt:case Pt:case Ct:return{}}}(t)[e]}function we(t){switch(t){case It:case Tt:case Vt:case re:case te:case ee:case ne:case Rt:case Ut:case Mt:case Nt:case Pt:case Ct:return;case Yt:case Gt:case Bt:case Xt:case ie:case se:return"discrete";case Qt:case Kt:case Jt:return"flexible";case Ht:case Wt:case qt:case $t:case Zt:case Dt:case Ft:return}throw new Error("rangeType not implemented for "+t)}var ze=Object.freeze({get Channel(){return wt},X:It,Y:Tt,X2:Rt,Y2:Ut,XERROR:Mt,YERROR:Nt,XERROR2:Pt,YERROR2:Ct,LATITUDE:Ht,LATITUDE2:qt,LONGITUDE:Wt,LONGITUDE2:$t,ROW:Yt,COLUMN:Gt,SHAPE:Bt,SIZE:Vt,COLOR:Qt,FILL:Kt,STROKE:Jt,TEXT:Xt,DETAIL:Zt,KEY:Dt,ORDER:Ft,OPACITY:te,FILLOPACITY:ee,STROKEOPACITY:ne,STROKEWIDTH:re,TOOLTIP:ie,HREF:se,GEOPOSITION_CHANNEL_INDEX:oe,GEOPOSITION_CHANNELS:ae,isColorChannel:ue,CHANNELS:fe,SINGLE_DEF_CHANNELS:de,isChannel:pe,isSecondaryRangeChannel:me,getMainRangeChannel:he,UNIT_CHANNELS:ge,NONPOSITION_CHANNELS:ve,POSITION_SCALE_CHANNELS:ye,NONPOSITION_SCALE_CHANNELS:Oe,isNonPositionScaleChannel:ke,SCALE_CHANNELS:je,isScaleChannel:_e,supportMark:Ae,rangeType:we});function Le(t){return g(t)?"bin":"bin"+K(t).map(e=>D(`_${e}_${t[e]}`)).join("")}function Ie(t){return!0===t||Re(t)}function Te(t){return"binned"===t}function Re(t){return o(t)}function Ue(t){switch(t){case Yt:case Gt:case Vt:case Qt:case Kt:case Jt:case re:case te:case ee:case ne:case Bt:return 6;default:return 10}}var Me,Ne=Object.freeze({binToString:Le,isBinning:Ie,isBinned:Te,isBinParams:Re,autoMaxBins:Ue});!function(t){t.AREA="area",t.BAR="bar",t.LINE="line",t.POINT="point",t.RECT="rect",t.RULE="rule",t.TEXT="text",t.TICK="tick",t.TRAIL="trail",t.CIRCLE="circle",t.SQUARE="square",t.GEOSHAPE="geoshape"}(Me||(Me={}));const Pe=Me.AREA,Ce=Me.BAR,He=Me.LINE,qe=Me.POINT,We=Me.TEXT,$e=Me.TICK,Ye=Me.TRAIL,Ge=Me.RECT,Be=Me.RULE,Ve=Me.GEOSHAPE,Qe=Me.CIRCLE,Ke=Me.SQUARE,Je={area:1,bar:1,line:1,point:1,text:1,tick:1,trail:1,rect:1,geoshape:1,rule:1,circle:1,square:1};function Xe(t){return N(["line","area","trail"],t)}const Ze=X(Je);function De(t){return t.type}const Fe=v(Ze);function tn(t){return(De(t)?t.type:t)in Fe}const en=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],nn=["fill","fillOpacity"],rn=[].concat(en,nn),sn=["filled","color","tooltip"],on={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],text:["shortTimeLabels"],tick:["bandSize","thickness"]},an={color:"#4c78a8",tooltip:{content:"encoding"}},cn={binSpacing:1,continuousBandSize:5},un={thickness:1};var ln=Object.freeze({get Mark(){return Me},AREA:Pe,BAR:Ce,LINE:He,POINT:qe,TEXT:We,TICK:$e,TRAIL:Ye,RECT:Ge,RULE:Be,GEOSHAPE:Ve,CIRCLE:Qe,SQUARE:Ke,isMark:function(t){return!!Je[t]},isPathMark:Xe,PRIMITIVE_MARKS:Ze,isMarkDef:De,isPrimitiveMark:tn,STROKE_CONFIG:en,FILL_CONFIG:nn,FILL_STROKE_CONFIG:rn,VL_ONLY_MARK_CONFIG_PROPERTIES:sn,VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX:on,defaultMarkConfig:an,defaultBarConfig:cn,defaultTickConfig:un});const fn=(dn=p||f,{level:function(t){return arguments.length?(dn=+t,this):dn},error:function(){return dn>=d&&l("error","ERROR",arguments),this},warn:function(){return dn>=p&&l("warn","WARN",arguments),this},info:function(){return dn>=m&&l("log","INFO",arguments),this},debug:function(){return dn>=h&&l("log","DEBUG",arguments),this}});var dn;let pn=fn;function mn(...t){pn.warn.apply(pn,arguments)}var hn;!function(t){t.INVALID_SPEC="Invalid spec",t.FIT_NON_SINGLE='Autosize "fit" only works for single views and layered views.',t.CANNOT_FIX_RANGE_STEP_WITH_FIT='Cannot use a fixed value of "rangeStep" when "autosize" is "fit".',t.cannotProjectOnChannelWithoutField=function(t){return`Cannot project a selection on encoding channel "${t}", which has no field.`},t.nearestNotSupportForContinuous=function(t){return`The "nearest" transform is not supported for ${t} marks.`},t.selectionNotSupported=function(t){return`Selection not supported for ${t} yet`},t.selectionNotFound=function(t){return`Cannot find a selection named "${t}"`},t.SCALE_BINDINGS_CONTINUOUS="Scale bindings are currently only supported for scales with unbinned, continuous domains.",t.noSuchRepeatedValue=function(t){return`Unknown repeated value "${t}".`},t.CONCAT_CANNOT_SHARE_AXIS="Axes cannot be shared in concatenated views.",t.REPEAT_CANNOT_SHARE_AXIS="Axes cannot be shared in repeated views.",t.cannotSetTitleAnchor=function(t){return`Cannot set title "anchor" for a ${t} spec`},t.unrecognizedParse=function(t){return`Unrecognized parse "${t}".`},t.differentParse=function(t,e,n){return`An ancestor parsed field "${t}" as ${n} but a child wants to parse the field as ${e}.`},t.invalidTransformIgnored=function(t){return`Ignoring an invalid transform: ${U(t)}.`},t.NO_FIELDS_NEEDS_AS='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.',t.encodingOverridden=function(t){return`Layer's shared ${t.join(",")} channel ${1===t.length?"is":"are"} overriden`},t.projectionOverridden=function(t){const{parentProjection:e,projection:n}=t;return`Layer's shared projection ${U(e)} is overridden by a child projection ${U(n)}.`},t.primitiveChannelDef=function(t,e,n){return`Channel ${t} is a ${e}. Converted to {value: ${U(n)}}.`},t.invalidFieldType=function(t){return`Invalid field type "${t}"`},t.nonZeroScaleUsedWithLengthMark=function(t,e,n){return`A ${n.scaleType?`${n.scaleType} scale`:n.zeroFalse?"scale with zero=false":"scale with custom domain that excludes zero"} is used to encode ${t}'s ${e}. This can be misleading as the ${"x"===e?"width":"height"} of the ${t} can be arbitrary based on the scale domain. You may want to use point mark instead.`},t.invalidFieldTypeForCountAggregate=function(t,e){return`Invalid field type "${t}" for aggregate: "${e}", using "quantitative" instead.`},t.invalidAggregate=function(t){return`Invalid aggregation operator "${t}"`},t.missingFieldType=function(t,e){return`Missing type for channel "${t}", using "${e}" instead.`},t.droppingColor=function(t,e){const{fill:n,stroke:r}=e;return`Dropping color ${t} as the plot also has `+(n&&r?"fill and stroke":n?"fill":"stroke")},t.emptyFieldDef=function(t,e){return`Dropping ${U(t)} from channel "${e}" since it does not contain data field or value.`},t.latLongDeprecated=function(t,e,n){return`${t}-encoding with type ${e} is deprecated. Replacing with ${n}-encoding.`},t.LINE_WITH_VARYING_SIZE="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.",t.incompatibleChannel=function(t,e,n){return`${t} dropped as it is incompatible with "${e}"${n?` when ${n}`:""}.`},t.invalidEncodingChannel=function(t){return`${t}-encoding is dropped as ${t} is not a valid encoding channel.`},t.facetChannelShouldBeDiscrete=function(t){return`${t} encoding should be discrete (ordinal / nominal / binned).`},t.discreteChannelCannotEncode=function(t,e){return`Using discrete channel "${t}" to encode "${e}" field can be misleading as it does not encode ${"ordinal"===e?"order":"magnitude"}.`},t.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL="Bar mark should not be used with point scale when rangeStep is null. Please use band scale instead.",t.lineWithRange=function(t,e){return`Line mark is for continuous lines and thus cannot be used with ${t&&e?"x2 and y2":t?"x2":"y2"}. We will use the rule mark (line segments) instead.`},t.orientOverridden=function(t,e){return`Specified orient "${t}" overridden with "${e}"`},t.CANNOT_UNION_CUSTOM_DOMAIN_WITH_FIELD_DOMAIN="custom domain scale cannot be unioned with default field-based domain",t.cannotUseScalePropertyWithNonColor=function(t){return`Cannot use the scale property "${t}" with non-color channel.`},t.unaggregateDomainHasNoEffectForRawField=function(t){return`Using unaggregated domain with raw field has no effect (${U(t)}).`},t.unaggregateDomainWithNonSharedDomainOp=function(t){return`Unaggregated domain not applicable for "${t}" since it produces values outside the origin domain of the source data.`},t.unaggregatedDomainWithLogScale=function(t){return`Unaggregated domain is currently unsupported for log scale (${U(t)}).`},t.cannotApplySizeToNonOrientedMark=function(t){return`Cannot apply size to non-oriented mark "${t}".`},t.rangeStepDropped=function(t){return`rangeStep for "${t}" is dropped as top-level ${"x"===t?"width":"height"} is provided.`},t.scaleTypeNotWorkWithChannel=function(t,e,n){return`Channel "${t}" does not work with "${e}" scale. We are using "${n}" scale instead.`},t.scaleTypeNotWorkWithFieldDef=function(t,e){return`FieldDef does not work with "${t}" scale. We are using "${e}" scale instead.`},t.scalePropertyNotWorkWithScaleType=function(t,e,n){return`${n}-scale's "${e}" is dropped as it does not work with ${t} scale.`},t.scaleTypeNotWorkWithMark=function(t,e){return`Scale type "${e}" does not work with mark "${t}".`},t.mergeConflictingProperty=function(t,e,n,r){return`Conflicting ${e.toString()} property "${t.toString()}" (${U(n)} and ${U(r)}).  Using ${U(n)}.`},t.independentScaleMeansIndependentGuide=function(t){return`Setting the scale to be independent for "${t}" means we also have to set the guide (axis or legend) to be independent.`},t.domainSortDropped=function(t){return`Dropping sort property ${U(t)} as unioned domains only support boolean or op 'count'.`},t.UNABLE_TO_MERGE_DOMAINS="Unable to merge domains",t.MORE_THAN_ONE_SORT="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",t.INVALID_CHANNEL_FOR_AXIS="Invalid channel for axis.",t.cannotStackRangedMark=function(t){return`Cannot stack "${t}" if there is already "${t}2"`},t.cannotStackNonLinearScale=function(t){return`Cannot stack non-linear scale (${t})`},t.stackNonSummativeAggregate=function(t){return`Stacking is applied even though the aggregate function is non-summative ("${t}")`},t.invalidTimeUnit=function(t,e){return`Invalid ${t}: ${U(e)}`},t.dayReplacedWithDate=function(t){return`Time unit "${t}" is not supported. We are replacing it with ${t.replace("day","date")}.`},t.droppedDay=function(t){return`Dropping day from datetime ${U(t)} as day cannot be combined with other units.`},t.errorBarCenterAndExtentAreNotNeeded=function(t,e){return`${e?"extent ":""}${e&&t?"and ":""}${t?"center ":""}${e&&t?"are ":"is "}not needed when data are aggregated.`},t.errorBarCenterIsUsedWithWrongExtent=function(t,e,n){return`${t} is not usually used with ${e} for ${n}.`},t.errorBarContinuousAxisHasCustomizedAggregate=function(t,e){return`Continuous axis should not have customized aggregation function ${t}; ${e} already agregates the axis.`},t.errorBarCenterIsNotNeeded=function(t,e){return`Center is not needed to be specified in ${e} when extent is ${t}.`},t.errorBand1DNotSupport=function(t){return`1D error band does not support ${t}`},t.channelRequiredForBinned=function(t){return`Channel ${t} is required for "binned" bin`},t.domainRequiredForThresholdScale=function(t){return`Domain for ${t} is required for threshold scale`}}(hn||(hn={}));const gn=2006;function bn(t){return!!(t&&(t.year||t.quarter||t.month||t.date||t.day||t.hours||t.minutes||t.seconds||t.milliseconds))}const vn=["january","february","march","april","may","june","july","august","september","october","november","december"],xn=vn.map(t=>t.substr(0,3)),yn=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],Sn=yn.map(t=>t.substr(0,3));function On(t,e=!1){const n=[];if(e&&void 0!==t.day&&K(t).length>1&&(mn(hn.droppedDay(t)),delete(t=L(t)).day),void 0!==t.year?n.push(t.year):void 0!==t.day?n.push(gn):n.push(0),void 0!==t.month){const r=e?function(t){if(b(t))return(t-1).toString();{const e=t.toLowerCase(),n=vn.indexOf(e);if(-1!==n)return n+"";const r=e.substr(0,3),i=xn.indexOf(r);if(-1!==i)return i+"";throw new Error(hn.invalidTimeUnit("month",t))}}(t.month):t.month;n.push(r)}else if(void 0!==t.quarter){const r=e?function(t){if(b(t))return t>4&&mn(hn.invalidTimeUnit("quarter",t)),(t-1).toString();throw new Error(hn.invalidTimeUnit("quarter",t))}(t.quarter):t.quarter;n.push(r+"*3")}else n.push(0);if(void 0!==t.date)n.push(t.date);else if(void 0!==t.day){const r=e?function(t){if(b(t))return t%7+"";{const e=t.toLowerCase(),n=yn.indexOf(e);if(-1!==n)return n+"";const r=e.substr(0,3),i=Sn.indexOf(r);if(-1!==i)return i+"";throw new Error(hn.invalidTimeUnit("day",t))}}(t.day):t.day;n.push(r+"+1")}else n.push(1);for(const e of["hours","minutes","seconds","milliseconds"])void 0!==t[e]?n.push(t[e]):n.push(0);return t.utc?`utc(${n.join(", ")})`:`datetime(${n.join(", ")})`}var kn,En=Object.freeze({isDateTime:bn,MONTHS:vn,SHORT_MONTHS:xn,DAYS:yn,SHORT_DAYS:Sn,dateTimeExpr:On});function jn(t){return void 0!==t.facet}!function(t){t.YEAR="year",t.MONTH="month",t.DAY="day",t.DATE="date",t.HOURS="hours",t.MINUTES="minutes",t.SECONDS="seconds",t.MILLISECONDS="milliseconds",t.YEARMONTH="yearmonth",t.YEARMONTHDATE="yearmonthdate",t.YEARMONTHDATEHOURS="yearmonthdatehours",t.YEARMONTHDATEHOURSMINUTES="yearmonthdatehoursminutes",t.YEARMONTHDATEHOURSMINUTESSECONDS="yearmonthdatehoursminutesseconds",t.MONTHDATE="monthdate",t.MONTHDATEHOURS="monthdatehours",t.HOURSMINUTES="hoursminutes",t.HOURSMINUTESSECONDS="hoursminutesseconds",t.MINUTESSECONDS="minutesseconds",t.SECONDSMILLISECONDS="secondsmilliseconds",t.QUARTER="quarter",t.YEARQUARTER="yearquarter",t.QUARTERMONTH="quartermonth",t.YEARQUARTERMONTH="yearquartermonth",t.UTCYEAR="utcyear",t.UTCMONTH="utcmonth",t.UTCDAY="utcday",t.UTCDATE="utcdate",t.UTCHOURS="utchours",t.UTCMINUTES="utcminutes",t.UTCSECONDS="utcseconds",t.UTCMILLISECONDS="utcmilliseconds",t.UTCYEARMONTH="utcyearmonth",t.UTCYEARMONTHDATE="utcyearmonthdate",t.UTCYEARMONTHDATEHOURS="utcyearmonthdatehours",t.UTCYEARMONTHDATEHOURSMINUTES="utcyearmonthdatehoursminutes",t.UTCYEARMONTHDATEHOURSMINUTESSECONDS="utcyearmonthdatehoursminutesseconds",t.UTCMONTHDATE="utcmonthdate",t.UTCMONTHDATEHOURS="utcmonthdatehours",t.UTCHOURSMINUTES="utchoursminutes",t.UTCHOURSMINUTESSECONDS="utchoursminutesseconds",t.UTCMINUTESSECONDS="utcminutesseconds",t.UTCSECONDSMILLISECONDS="utcsecondsmilliseconds",t.UTCQUARTER="utcquarter",t.UTCYEARQUARTER="utcyearquarter",t.UTCQUARTERMONTH="utcquartermonth",t.UTCYEARQUARTERMONTH="utcyearquartermonth"}(kn||(kn={}));const _n={year:1,quarter:1,month:1,day:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},An=X(_n);function wn(t){return!!_n[t]}const zn={utcyear:1,utcquarter:1,utcmonth:1,utcday:1,utcdate:1,utchours:1,utcminutes:1,utcseconds:1,utcmilliseconds:1};function Ln(t){return!!zn[t]}const In={utcyearquarter:1,utcyearquartermonth:1,utcyearmonth:1,utcyearmonthdate:1,utcyearmonthdatehours:1,utcyearmonthdatehoursminutes:1,utcyearmonthdatehoursminutesseconds:1,utcquartermonth:1,utcmonthdate:1,utcmonthdatehours:1,utchoursminutes:1,utchoursminutesseconds:1,utcminutesseconds:1,utcsecondsmilliseconds:1},Tn=Object.assign({},zn,In);function Rn(t){return!!Tn[t]}function Un(t){return t.substr(3)}const Mn=Object.assign({},_n,zn,{yearquarter:1,yearquartermonth:1,yearmonth:1,yearmonthdate:1,yearmonthdatehours:1,yearmonthdatehoursminutes:1,yearmonthdatehoursminutesseconds:1,quartermonth:1,monthdate:1,monthdatehours:1,hoursminutes:1,hoursminutesseconds:1,minutesseconds:1,secondsmilliseconds:1},In),Nn=X(Mn);const Pn={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",quarter:null,day:null};function Cn(t,e){const n=Pn[t];return{setDateMethod:e?"setUTC"+n.substr(3):n,getDateMethod:"get"+(e?"UTC":"")+n.substr(3)}}function Hn(t){return An.reduce((e,n)=>qn(t,n)?e.concat(n):e,[])}function qn(t,e){const n=t.indexOf(e);return n>-1&&(e!==kn.SECONDS||0===n||"i"!==t.charAt(n-1))}function Wn(t,e){const n=nt(e),r=Rn(t)?"utc":"";return On(An.reduce((e,i)=>(qn(t,i)&&(e[i]=function(t){return t===kn.QUARTER?`(${r}quarter(${n})-1)`:`${r}${t}(${n})`}(i)),e),{}))}function $n(t,e){if(!t)return;const n=[],r=qn(t,kn.YEAR);qn(t,kn.MONTH)&&n.push(!1!==e?"%b":"%B"),qn(t,kn.DAY)?n.push(e?"%a":"%A"):qn(t,kn.DATE)&&n.push("%d"+(r?",":"")),r&&n.push(e?"%y":"%Y");const i=[];qn(t,kn.HOURS)&&i.push("%H"),qn(t,kn.MINUTES)&&i.push("%M"),qn(t,kn.SECONDS)&&i.push("%S"),qn(t,kn.MILLISECONDS)&&i.push("%L");const s=[];return n.length>0&&s.push(n.join(" ")),i.length>0&&s.push(i.join(":")),s}function Yn(t,e,n,r){if(!t)return;const i=$n(t,n);let s="";return qn(t,kn.QUARTER)&&(s=`'Q' + quarter(${e})`),i.length>0&&(s&&(s+=" + ' ' + "),s+=r?`utcFormat(${e}, '${i.join(" ")}')`:`timeFormat(${e}, '${i.join(" ")}')`),s||void 0}function Gn(t){return"day"!==t&&t.indexOf("day")>=0?(mn(hn.dayReplacedWithDate(t)),t.replace("day","date")):t}var Bn,Vn=Object.freeze({get TimeUnit(){return kn},TIMEUNIT_PARTS:An,isLocalSingleTimeUnit:wn,isUtcSingleTimeUnit:Ln,isUTCTimeUnit:Rn,getLocalTimeUnit:Un,TIMEUNITS:Nn,isTimeUnit:function(t){return!!Mn[t]},convert:function(t,e){const n=Rn(t),r=n?new Date(Date.UTC(1972,0,1,0,0,0,0)):new Date(1972,0,1,0,0,0,0);for(const i of An)if(qn(t,i))switch(i){case kn.DAY:throw new Error("Cannot convert to TimeUnits containing 'day'");case kn.QUARTER:{const{getDateMethod:t,setDateMethod:i}=Cn("month",n);r[i](3*Math.floor(e[t]()/3));break}default:const{getDateMethod:t,setDateMethod:s}=Cn(i,n);r[s](e[t]())}return r},getTimeUnitParts:Hn,containsTimeUnit:qn,fieldExpr:Wn,getDateTimeComponents:$n,formatExpression:Yn,normalizeTimeUnit:Gn});!function(t){t.QUANTITATIVE="quantitative",t.ORDINAL="ordinal",t.TEMPORAL="temporal",t.NOMINAL="nominal",t.GEOJSON="geojson"}(Bn||(Bn={}));const Qn={quantitative:1,ordinal:1,temporal:1,nominal:1,geojson:1};const Kn=Bn.QUANTITATIVE,Jn=Bn.ORDINAL,Xn=Bn.TEMPORAL,Zn=Bn.NOMINAL,Dn=Bn.GEOJSON;function Fn(t){if(t)switch(t=t.toLowerCase()){case"q":case Kn:return"quantitative";case"t":case Xn:return"temporal";case"o":case Jn:return"ordinal";case"n":case Zn:return"nominal";case Dn:return"geojson"}}var tr=Object.freeze({get Type(){return Bn},TYPE_INDEX:Qn,isType:function(t){return!!Qn[t]},QUANTITATIVE:Kn,ORDINAL:Jn,TEMPORAL:Xn,NOMINAL:Zn,GEOJSON:Dn,getFullName:Fn});function er(t){return t.selection}function nr(t){return t&&!a(t)&&"repeat"in t}function rr(t){const{field:e,timeUnit:n,bin:r,aggregate:i}=t;return Object.assign({},n?{timeUnit:n}:{},r?{bin:r}:{},i?{aggregate:i}:{},{field:e})}function ir(t){return ur(t)&&!!t.sort}function sr(t){return!!t&&!!t.condition}function or(t){return!!t&&!!t.condition&&!s(t.condition)&&cr(t.condition)}function ar(t){return!!t&&!!t.condition&&(s(t.condition)||fr(t.condition))}function cr(t){return!(!t||!t.field&&"count"!==t.aggregate)}function ur(t){return!!t&&(!!t.field&&!!t.type||"count"===t.aggregate)}function lr(t){return cr(t)&&a(t.field)}function fr(t){return t&&"value"in t&&void 0!==t.value}function dr(t){return!(!t||!t.scale&&!t.sort)}function pr(t){return!(!t||!t.axis&&!t.stack&&!t.impute)}function mr(t){return!!t&&!!t.legend}function hr(t){return!!t&&!!t.format}function gr(t,e={}){let n=t.field;const r=e.prefix;let i=e.suffix;if(xr(t))n="count_*";else{let r;e.nofn||(!function(t){return!!t.op}(t)?Ie(t.bin)?(r=Le(t.bin),i=(e.binSuffix||"")+(e.suffix||"")):t.aggregate?r=String(t.aggregate):t.timeUnit&&(r=String(t.timeUnit)):r=t.op),r&&(n=n?`${r}_${n}`:r)}return i&&(n=`${n}_${i}`),r&&(n=`${r}_${n}`),e.forAs?n:e.expr?rt(n,e.expr):it(n)}function br(t){switch(t.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return!!t.bin;case"temporal":return!1}throw new Error(hn.invalidFieldType(t.type))}function vr(t){return!br(t)}function xr(t){return"count"===t.aggregate}function yr(t,e){const{field:n,bin:r,timeUnit:i,aggregate:s}=t;if("count"===s)return e.countTitle;if(Ie(r))return`${n} (binned)`;if(i){return`${n} (${Hn(i).join("-")})`}return s?`${et(s)} of ${n}`:n}function Sr(t,e){const n=t.aggregate||t.timeUnit||Ie(t.bin)&&"bin";return n?n.toUpperCase()+"("+t.field+")":t.field}const Or=(t,e)=>{switch(e.fieldTitle){case"plain":return t.field;case"functional":return Sr(t);default:return yr(t,e)}};let kr=Or;function Er(t){kr=t}function jr(){Er(Or)}function _r(t,e,{allowDisabling:n}){const r=(Ar(t)||{}).title;return n?at(r,t.title,wr(t,e)):r||t.title||wr(t,e)}function Ar(t){return pr(t)&&t.axis?t.axis:mr(t)&&t.legend?t.legend:(e=t)&&e.header&&t.header?t.header:void 0;var e}function wr(t,e){return kr(t,e)}function zr(t){if(hr(t)&&t.format)return t.format;return(Ar(t)||{}).format}function Lr(t,e){if(t.timeUnit)return"temporal";if(Ie(t.bin))return"quantitative";switch(we(e)){case"continuous":return"quantitative";case"discrete":case"flexible":return"nominal";default:return"quantitative"}}function Ir(t){return cr(t)?t:or(t)?t.condition:void 0}function Tr(t){return cr(t)?t:or(t)?t.condition:void 0}function Rr(t,e){if(a(t)||b(t)||g(t)){const n=a(t)?"string":b(t)?"number":"boolean";return mn(hn.primitiveChannelDef(e,n,t)),{value:t}}return cr(t)?Ur(t,e):or(t)?Object.assign({},t,{condition:Ur(t.condition,e)}):t}function Ur(t,e){if(t.aggregate&&!pt(t.aggregate)){const e=Lt(t,["aggregate"]);mn(hn.invalidAggregate(t.aggregate)),t=e}if(t.timeUnit&&(t=Object.assign({},t,{timeUnit:Gn(t.timeUnit)})),Ie(t.bin)&&(t=Object.assign({},t,{bin:Mr(t.bin,e)})),Te(t.bin)&&!N(ye,e)&&mn(`Channel ${e} should not be used with "binned" bin`),ur(t)){const e=Fn(t.type);t.type!==e&&(t=Object.assign({},t,{type:e})),"quantitative"!==t.type&&ht(t.aggregate)&&(mn(hn.invalidFieldTypeForCountAggregate(t.type,t.aggregate)),t=Object.assign({},t,{type:"quantitative"}))}else if(!me(e)){const n=Lr(t,e);mn(hn.missingFieldType(e,n)),t=Object.assign({},t,{type:n})}if(ur(t)){const{compatible:n,warning:r}=Pr(t,e);n||mn(r)}return t}function Mr(t,e){return g(t)?{maxbins:Ue(e)}:t.maxbins||t.step?t:Object.assign({},t,{maxbins:Ue(e)})}const Nr={compatible:!0};function Pr(t,e){const n=t.type;if("geojson"===n&&"shape"!==e)return{compatible:!1,warning:`Channel ${e} should not be used with a geojson data.`};switch(e){case"row":case"column":return vr(t)?{compatible:!1,warning:hn.facetChannelShouldBeDiscrete(e)}:Nr;case"x":case"y":case"color":case"fill":case"stroke":case"text":case"detail":case"key":case"tooltip":case"href":return Nr;case"longitude":case"longitude2":case"latitude":case"latitude2":return n!==Kn?{compatible:!1,warning:`Channel ${e} should be used with a quantitative field only, not ${t.type} field.`}:Nr;case"opacity":case"fillOpacity":case"strokeOpacity":case"strokeWidth":case"size":case"x2":case"y2":return"nominal"!==n||t.sort?Nr:{compatible:!1,warning:`Channel ${e} should not be used with an unsorted discrete field.`};case"shape":return N(["ordinal","nominal","geojson"],t.type)?Nr:{compatible:!1,warning:"Shape channel should be used with only either discrete or geojson data."};case"order":return"nominal"!==t.type||"sort"in t?Nr:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}throw new Error("channelCompatability not implemented for channel "+e)}function Cr(t){return"quantitative"===t.type||Ie(t.bin)}function Hr(t){return"temporal"===t.type||!!t.timeUnit}function qr(t,{timeUnit:e,type:n,time:r,undefinedIfExprNotRequired:i}){let s;return bn(t)?s=On(t,!0):(a(t)||b(t))&&(e||"temporal"===n)&&(s=wn(e)?On({[e]:t},!0):Ln(e)?qr(t,{timeUnit:Un(e)}):`datetime(${JSON.stringify(t)})`),s?r?`time(${s})`:s:i?void 0:JSON.stringify(t)}function Wr(t,e){const{timeUnit:n,type:r}=t;return e.map(t=>{const e=qr(t,{timeUnit:n,type:r,undefinedIfExprNotRequired:!0});return void 0!==e?{signal:e}:t})}function $r(t,e){return Ie(t.bin)?_e(e)&&N(["ordinal","nominal"],t.type):(console.warn("Only use this method with binned field defs"),!1)}var Yr=Object.freeze({isConditionalSelection:er,isRepeatRef:nr,toFieldDefBase:rr,isSortableFieldDef:ir,isConditionalDef:sr,hasConditionalFieldDef:or,hasConditionalValueDef:ar,isFieldDef:cr,isTypedFieldDef:ur,isStringFieldDef:lr,isValueDef:fr,isScaleFieldDef:dr,isPositionFieldDef:pr,isMarkPropFieldDef:mr,isTextFieldDef:hr,vgField:gr,isDiscrete:br,isContinuous:vr,isCount:xr,verbalTitleFormatter:yr,functionalTitleFormatter:Sr,defaultTitleFormatter:Or,setTitleFormatter:Er,resetTitleFormatter:jr,title:_r,getGuide:Ar,defaultTitle:wr,format:zr,defaultType:Lr,getFieldDef:Ir,getTypedFieldDef:Tr,normalize:Rr,normalizeFieldDef:Ur,normalizeBin:Mr,channelCompatibility:Pr,isNumberFieldDef:Cr,isTimeFieldDef:Hr,valueExpr:qr,valueArray:Wr,binRequiresRange:$r});function Gr(t,e){const n=t&&t[e];return!!n&&(s(n)?C(n,t=>!!t.field):cr(n)||or(n))}function Br(t){return C(fe,e=>{if(Gr(t,e)){const n=t[e];if(s(n))return C(n,t=>!!t.aggregate);{const t=Ir(n);return t&&!!t.aggregate}}return!1})}function Vr(t,e){const n=[],r=[],i=[],s=[],o={};return Xr(t,(a,c)=>{if(cr(a)){const{field:u,aggregate:l,timeUnit:f,bin:d}=a,p=Lt(a,["field","aggregate","timeUnit","bin"]);if(l||f||d){const t=Ar(a),m=t&&t.title,h=gr(a,{forAs:!0}),g=Object.assign({},m?[]:{title:_r(a,e,{allowDisabling:!0})},p,{field:h}),b=c===wt.X||c===wt.Y;if(l&&pt(l)){const t={op:l,as:h};u&&(t.field=u),s.push(t)}else if(ur(a)&&Ie(d)){if(r.push({bin:d,field:u,as:h}),n.push(gr(a,{binSuffix:"end"})),$r(a,c)&&n.push(gr(a,{binSuffix:"range"})),b){const t={field:h+"_end",type:Bn.QUANTITATIVE};o[c+"2"]=t}g.bin="binned",me(c)||(g.type=Bn.QUANTITATIVE)}else if(f){i.push({timeUnit:f,field:u,as:h});const t=$n(f,e.axis.shortTimeLabels).join(" ");ke(c)?g.legend=Object.assign({format:t},g.legend):b?g.axis=Object.assign({format:t},g.axis):"text"!==c&&"tooltip"!==c||(g.format=g.format||t)}l||n.push(h),o[c]=g}else n.push(u),o[c]=t[c]}else o[c]=t[c]}),{bins:r,timeUnits:i,aggregate:s,groupby:n,encoding:o}}function Qr(t,e,n){const r=Ae(e,n);if(!r)return!1;if("binned"===r){const n=t["x2"===e?"x":"y"];return!(!cr(n)||!cr(t[e])||"binned"!==n.bin)}return!0}function Kr(t,e){return K(t).reduce((n,r)=>{if(!pe(r))return mn(hn.invalidEncodingChannel(r)),n;if(!Qr(t,r,e))return mn(hn.incompatibleChannel(r,e)),n;if("size"===r&&"line"===e){const e=Tr(t[r]);if(e&&e.aggregate)return mn(hn.LINE_WITH_VARYING_SIZE),n}if("color"===r&&("fill"in t||"stroke"in t))return mn(hn.droppingColor("encoding",{fill:"fill"in t,stroke:"stroke"in t})),n;const i=t[r];if("detail"===r||"order"===r&&!s(i)&&!fr(i)||"tooltip"===r&&s(i))i&&(n[r]=(s(i)?i:[i]).reduce((t,e)=>(cr(e)?t.push(Ur(e,r)):mn(hn.emptyFieldDef(e,r)),t),[]));else{if("tooltip"===r&&null===i)n[r]=null;else if(!cr(i)&&!fr(i)&&!sr(i))return mn(hn.emptyFieldDef(i,r)),n;n[r]=Rr(i,r)}return n},{})}function Jr(t){const e=[];for(const n of K(t))if(Gr(t,n)){const r=t[n];(s(r)?r:[r]).forEach(t=>{cr(t)?e.push(t):or(t)&&e.push(t.condition)})}return e}function Xr(t,e,n){if(t)for(const r of K(t))s(t[r])?t[r].forEach(t=>{e.call(n,t,r)}):e.call(n,t[r],r)}function Zr(t,e,n,r){return t?K(t).reduce((n,i)=>{const o=t[i];return s(o)?o.reduce((t,n)=>e.call(r,t,n,i),n):e.call(r,n,o,i)},n):n}var Dr=Object.freeze({channelHasField:Gr,isAggregate:Br,extractTransformsFromEncoding:Vr,markChannelCompatible:Qr,normalizeEncoding:Kr,isRanged:function(t){return t&&(!!t.x&&!!t.x2||!!t.y&&!!t.y2)},fieldDefs:Jr,forEach:Xr,reduce:Zr});function Fr(t,e,n,r=!0){return{tooltip:[...t.map(({fieldPrefix:t,titlePrefix:n})=>({field:t+e.field,type:e.type,title:n+(r?" of "+e.field:"")})),...Jr(n)]}}function ti(t,e,n,r,i){const{scale:s,axis:o}=n;return({partName:c,mark:u,positionPrefix:l,endPositionPrefix:f,extraEncoding:d={}})=>{const p=o&&void 0!==o.title?void 0:void 0!==n.title?n.title:n.field;return ei(t,c,i,{mark:u,encoding:Object.assign({[e]:Object.assign({field:l+"_"+n.field,type:n.type},p?{title:p}:{},s?{scale:s}:{},o?{axis:o}:{})},a(f)?{[e+"2"]:{field:f+"_"+n.field,type:n.type}}:{},r,d)})}}function ei(t,e,n,r){const{clip:i,color:s,opacity:o}=t,a=t.type;return t[e]||void 0===t[e]&&n[e]?[Object.assign({},r,{mark:Object.assign({},n[e],i?{clip:i}:{},s?{color:s}:{},o?{opacity:o}:{},De(r.mark)?r.mark:{type:r.mark},{style:`${a}-${e}`},g(t[e])?{}:t[e])})]:[]}function ni(t,e,n){const{encoding:r}=t,i="vertical"===e?"y":"x",s=r[i],o=r[i+"2"],a=r[i+"Error"],c=r[i+"Error2"];return{continuousAxisChannelDef:ri(s,n),continuousAxisChannelDef2:ri(o,n),continuousAxisChannelDefError:ri(a,n),continuousAxisChannelDefError2:ri(c,n),continuousAxis:i}}function ri(t,e){if(cr(t)&&t&&t.aggregate){const{aggregate:n}=t,r=Lt(t,["aggregate"]);return n!==e&&mn(hn.errorBarContinuousAxisHasCustomizedAggregate(n,e)),r}return t}function ii(t,e){const{mark:n,encoding:r}=t;if(cr(r.x)&&vr(r.x)){if(cr(r.y)&&vr(r.y)){if(void 0===r.x.aggregate&&r.y.aggregate===e)return"vertical";if(void 0===r.y.aggregate&&r.x.aggregate===e)return"horizontal";if(r.x.aggregate===e&&r.y.aggregate===e)throw new Error("Both x and y cannot have aggregate");return De(n)&&n.orient?n.orient:"vertical"}return"horizontal"}if(cr(r.y)&&vr(r.y))return"vertical";throw new Error("Need a valid continuous axis for "+e+"s")}function si(t,e,n){return Object.assign({},t,{encoding:Zr(t.encoding,(t,r,i)=>(e.indexOf(i)>-1?t[i]=r:mn(hn.incompatibleChannel(i,n)),t),{})})}const oi="boxplot",ai=K({box:1,median:1,outliers:1,rule:1,ticks:1}),ci=["x","y","color","detail","opacity","size"];function ui(t){return[{op:"q1",field:t,as:"lower_box_"+t},{op:"q3",field:t,as:"upper_box_"+t}]}const li="errorbar",fi=K({ticks:1,rule:1});function di(t,e){const{encoding:n}=t;if(function(t){return(cr(t.x)||cr(t.y))&&!cr(t.x2)&&!cr(t.y2)&&!cr(t.xError)&&!cr(t.xError2)&&!cr(t.yError)&&!cr(t.yError2)}(n))return{orient:ii(t,e),inputType:"raw"};const r=function(t){return cr(t.x2)||cr(t.y2)}(n),i=function(t){return cr(t.xError)||cr(t.xError2)||cr(t.yError)||cr(t.yError2)}(n),s=n.x,o=n.y;if(r){if(i)throw new Error(e+" cannot be both type aggregated-upper-lower and aggregated-error");const t=n.x2,r=n.y2;if(cr(t)&&cr(r))throw new Error(e+" cannot have both x2 and y2");if(cr(t)){if(cr(s)&&vr(s))return{orient:"horizontal",inputType:"aggregated-upper-lower"};throw new Error("Both x and x2 have to be quantitative in "+e)}if(cr(r)){if(cr(o)&&vr(o))return{orient:"vertical",inputType:"aggregated-upper-lower"};throw new Error("Both y and y2 have to be quantitative in "+e)}throw new Error("No ranged axis")}{const t=n.xError,r=n.xError2,i=n.yError,a=n.yError2;if(cr(r)&&!cr(t))throw new Error(e+" cannot have xError2 without xError");if(cr(a)&&!cr(i))throw new Error(e+" cannot have yError2 without yError");if(cr(t)&&cr(i))throw new Error(e+" cannot have both xError and yError with both are quantiative");if(cr(t)){if(cr(s)&&vr(s))return{orient:"horizontal",inputType:"aggregated-error"};throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}if(cr(i)){if(cr(o)&&vr(o))return{orient:"vertical",inputType:"aggregated-error"};throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}throw new Error("No ranged axis")}}const pi=["x","y","x2","y2","xError","yError","xError2","yError2","color","detail","opacity"];function mi(t,e,n){t=si(t,pi,e);const{mark:r,encoding:i,selection:s,projection:o}=t,a=Lt(t,["mark","encoding","selection","projection"]),c=De(r)?r:{type:r};s&&mn(hn.selectionNotSupported(e));const{orient:u,inputType:l}=di(t,e),{continuousAxisChannelDef:f,continuousAxisChannelDef2:d,continuousAxisChannelDefError:p,continuousAxisChannelDefError2:m,continuousAxis:h}=ni(t,u,e),{errorBarSpecificAggregate:g,postAggregateCalculates:b,tooltipSummary:v,tooltipTitleWithFieldName:x}=function(t,e,n,r,i,s,o,a){let c=[],u=[];const l=e.field;let f,d=!1;if("raw"===s){const e=t.center?t.center:t.extent?"iqr"===t.extent?"median":"mean":a.errorbar.center,n=t.extent?t.extent:"mean"===e?"stderr":"iqr";if("median"===e!=("iqr"===n)&&mn(hn.errorBarCenterIsUsedWithWrongExtent(e,n,o)),"stderr"===n||"stdev"===n)c=[{op:n,field:l,as:"extent_"+l},{op:e,field:l,as:"center_"+l}],u=[{calculate:`datum.center_${l} + datum.extent_${l}`,as:"upper_"+l},{calculate:`datum.center_${l} - datum.extent_${l}`,as:"lower_"+l}],f=[{fieldPrefix:"center_",titlePrefix:et(e)},{fieldPrefix:"upper_",titlePrefix:hi(e,n,"+")},{fieldPrefix:"lower_",titlePrefix:hi(e,n,"-")}],d=!0;else{let e,r,i;t.center&&t.extent&&mn(hn.errorBarCenterIsNotNeeded(t.extent,o)),"ci"===n?(e="mean",r="ci0",i="ci1"):(e="median",r="q1",i="q3"),c=[{op:r,field:l,as:"lower_"+l},{op:i,field:l,as:"upper_"+l},{op:e,field:l,as:"center_"+l}],f=[{fieldPrefix:"upper_",titlePrefix:_r({field:l,aggregate:i,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"lower_",titlePrefix:_r({field:l,aggregate:r,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"center_",titlePrefix:_r({field:l,aggregate:e,type:"quantitative"},a,{allowDisabling:!1})}]}}else{(t.center||t.extent)&&mn(hn.errorBarCenterAndExtentAreNotNeeded(t.center,t.extent)),"aggregated-upper-lower"===s?(f=[],u=[{calculate:`datum.${n.field}`,as:"upper_"+l},{calculate:`datum.${l}`,as:"lower_"+l}]):"aggregated-error"===s&&(f=[{fieldPrefix:"",titlePrefix:l}],u=[{calculate:`datum.${l} + datum.${r.field}`,as:"upper_"+l}],i?u.push({calculate:`datum.${l} + datum.${i.field}`,as:"lower_"+l}):u.push({calculate:`datum.${l} - datum.${r.field}`,as:"lower_"+l}));for(const t of u)f.push({fieldPrefix:t.as.substring(0,6),titlePrefix:t.calculate.replace(new RegExp("datum.","g"),"")})}return{postAggregateCalculates:u,errorBarSpecificAggregate:c,tooltipSummary:f,tooltipTitleWithFieldName:d}}(c,f,d,p,m,l,e,n),y=h,S=(i[y],"x"===h?"x2":"y2"),O=(i[S],"x"===h?"xError":"yError"),k=(i[O],"x"===h?"xError2":"yError2"),E=(i[k],Lt(i,["symbol"==typeof y?y:y+"","symbol"==typeof S?S:S+"","symbol"==typeof O?O:O+"","symbol"==typeof k?k:k+""])),{bins:j,timeUnits:_,aggregate:A,groupby:w,encoding:z}=Vr(E,n),L=[...A,...g],I="raw"!==l?[]:w,T=Fr(v,f,z,x);return{transform:[...a.transform||[],...j,..._,...L.length?[{aggregate:L,groupby:I}]:[],...b],groupby:I,continuousAxisChannelDef:f,continuousAxis:h,encodingWithoutContinuousAxis:z,ticksOrient:"vertical"===u?"horizontal":"vertical",markDef:c,outerSpec:a,tooltipEncoding:T}}function hi(t,e,n){return et(t)+" "+n+" "+e}const gi="errorband",bi=K({band:1,borders:1});const vi={};function xi(t,e,n){vi[t]={normalizer:e,parts:n}}function yi(){return K(vi)}function Si(t,e){const n=De(t.mark)?t.mark.type:t.mark;if(n in vi){const{normalizer:r}=vi[n];return r(t,e)}throw new Error(`Invalid mark type "${n}"`)}xi(oi,function(t,e){t=si(t,ci,oi);const{mark:n,encoding:r,selection:i,projection:s}=t,a=Lt(t,["mark","encoding","selection","projection"]),c=De(n)?n:{type:n};i&&mn(hn.selectionNotSupported("boxplot"));const u=c.extent||e.boxplot.extent,l=at(c.size,e.boxplot.size),f=!b(u),{transform:d,continuousAxisChannelDef:p,continuousAxis:m,groupby:h,encodingWithoutContinuousAxis:g,ticksOrient:v,tooltipEncoding:x}=function(t,e,n){const r=ii(t,oi),{continuousAxisChannelDef:i,continuousAxis:s}=ni(t,r,oi),o=i.field,a=!b(e),c=[...ui(o),{op:"median",field:o,as:"mid_box_"+o},{op:"min",field:o,as:(a?"lower_whisker_":"min_")+o},{op:"max",field:o,as:(a?"upper_whisker_":"max_")+o}],u=a?[]:[{calculate:`datum.upper_box_${o} - datum.lower_box_${o}`,as:"iqr_"+o},{calculate:`min(datum.upper_box_${o} + datum.iqr_${o} * ${e}, datum.max_${o})`,as:"upper_whisker_"+o},{calculate:`max(datum.lower_box_${o} - datum.iqr_${o} * ${e}, datum.min_${o})`,as:"lower_whisker_"+o}],l=t.encoding,f=s,d=(l[f],Lt(l,["symbol"==typeof f?f:f+""])),{bins:p,timeUnits:m,aggregate:h,groupby:g,encoding:v}=Vr(d,n),x="vertical"===r?"horizontal":"vertical",y=Fr([{fieldPrefix:"upper_whisker_",titlePrefix:a?"Max":"Upper Whisker"},{fieldPrefix:"upper_box_",titlePrefix:"Q3"},{fieldPrefix:"mid_box_",titlePrefix:"Median"},{fieldPrefix:"lower_box_",titlePrefix:"Q1"},{fieldPrefix:"lower_whisker_",titlePrefix:a?"Min":"Lower Whisker"}],i,v);return{transform:[...p,...m,{aggregate:[...h,...c],groupby:g},...u],groupby:g,continuousAxisChannelDef:i,continuousAxis:s,encodingWithoutContinuousAxis:v,ticksOrient:x,tooltipEncoding:y}}(t,u,e),{color:y,size:S}=g,O=Lt(g,["color","size"]),k=t=>ti(c,m,p,t,e.boxplot),E=k(O),j=k(g),_=k(Object.assign({},O,S?{size:S}:{})),A={type:"tick",color:"black",opacity:1,orient:v},w=Object.assign({type:"bar"},l?{size:l}:{}),z=Object.assign({type:"tick"},o(e.boxplot.median)&&e.boxplot.median.color?{color:e.boxplot.median.color}:{},l?{size:l}:{},{orient:v}),L=[...E({partName:"rule",mark:"rule",positionPrefix:"lower_whisker",endPositionPrefix:"lower_box",extraEncoding:x}),...E({partName:"rule",mark:"rule",positionPrefix:"upper_box",endPositionPrefix:"upper_whisker",extraEncoding:x}),...E({partName:"ticks",mark:A,positionPrefix:"lower_whisker",extraEncoding:x}),...E({partName:"ticks",mark:A,positionPrefix:"upper_whisker",extraEncoding:x}),...j({partName:"box",mark:w,positionPrefix:"lower_box",endPositionPrefix:"upper_box",extraEncoding:x}),..._({partName:"median",mark:z,positionPrefix:"mid_box",extraEncoding:x})];let I=[];if(!f){const t="datum.lower_box_"+p.field,n="datum.upper_box_"+p.field,r=`(${n} - ${t})`,i=`${t} - ${u} * ${r}`,s=`${n} + ${u} * ${r}`,o=`datum.${p.field}`;I=ei(c,"outliers",e.boxplot,{transform:[{window:ui(p.field),frame:[null,null],groupby:h},{filter:`(${o} < ${i}) || (${o} > ${s})`}],mark:"point",encoding:Object.assign({[m]:{field:p.field,type:p.type}},O)})}return I.length>0?Object.assign({},a,{layer:[{transform:d,layer:L},...I]}):Object.assign({},a,{transform:(a.transform||[]).concat(d),layer:L})},ai),xi(li,function(t,e){const{transform:n,continuousAxisChannelDef:r,continuousAxis:i,encodingWithoutContinuousAxis:s,ticksOrient:o,markDef:a,outerSpec:c,tooltipEncoding:u}=mi(t,li,e),l=ti(a,i,r,s,e.errorbar),f={type:"tick",orient:o};return Object.assign({},c,{transform:n,layer:[...l({partName:"ticks",mark:f,positionPrefix:"lower",extraEncoding:u}),...l({partName:"ticks",mark:f,positionPrefix:"upper",extraEncoding:u}),...l({partName:"rule",mark:"rule",positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:u})]})},fi),xi(gi,function(t,e){const{transform:n,continuousAxisChannelDef:r,continuousAxis:i,encodingWithoutContinuousAxis:s,markDef:o,outerSpec:a,tooltipEncoding:c}=mi(t,gi,e),u=ti(o,i,r,s,e.errorband),l=void 0!==t.encoding.x&&void 0!==t.encoding.y;let f={type:l?"area":"rect"},d={type:l?"line":"rule"};const p=Object.assign({},o.interpolate?{interpolate:o.interpolate}:{},o.tension&&o.interpolate?{interpolate:o.tension}:{});return l?(f=Object.assign({},f,p),d=Object.assign({},d,p)):o.interpolate?mn(hn.errorBand1DNotSupport("interpolate")):o.tension&&mn(hn.errorBand1DNotSupport("tension")),Object.assign({},a,{transform:n,layer:[...u({partName:"band",mark:f,positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:c}),...u({partName:"borders",mark:d,positionPrefix:"lower",extraEncoding:c}),...u({partName:"borders",mark:d,positionPrefix:"upper",extraEncoding:c})]})},bi);var Oi=Object.freeze({add:xi,remove:function(t){delete vi[t]},getAllCompositeMarks:yi,getCompositeMarkParts:function(t){if(t in vi)return vi[t].parts;throw new Error(`Unregistered composite mark ${t}`)},normalize:Si});const ki=["shortTimeLabels"],Ei=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength"],ji={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64},_i={clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,direction:1,fillColor:1,format:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,strokeWidth:1,symbolFillColor:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,title:1,titleAlign:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,type:1,values:1,zindex:1},Ai=Object.assign({},_i,{opacity:1,shape:1,stroke:1,fill:1,size:1,encode:1}),wi=X(_i),zi=X(Ai);var Li,Ii=Object.freeze({defaultLegendConfig:ji,LEGEND_PROPERTIES:wi,VG_LEGEND_PROPERTIES:zi});!function(t){t.LINEAR="linear",t.BIN_LINEAR="bin-linear",t.LOG="log",t.POW="pow",t.SQRT="sqrt",t.TIME="time",t.UTC="utc",t.SEQUENTIAL="sequential",t.QUANTILE="quantile",t.QUANTIZE="quantize",t.THRESHOLD="threshold",t.ORDINAL="ordinal",t.BIN_ORDINAL="bin-ordinal",t.POINT="point",t.BAND="band"}(Li||(Li={}));const Ti={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric","bin-linear":"bin-linear",time:"time",utc:"time",sequential:"sequential",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"},Ri=K(Ti);function Ui(t,e){const n=Ti[t],r=Ti[e];return n===r||"ordinal-position"===n&&"time"===r||"ordinal-position"===r&&"time"===n}const Mi={linear:0,log:1,pow:1,sqrt:1,time:0,utc:0,point:10,band:11,"bin-linear":0,sequential:0,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function Ni(t){return Mi[t]}const Pi=["linear","bin-linear","log","pow","sqrt","time","utc"],Ci=v(Pi),Hi=["quantile","quantize","threshold"],qi=v(Hi),Wi=Pi.concat(["sequential","quantile","quantize","threshold"]),$i=v(Wi),Yi=["ordinal","bin-ordinal","point","band"],Gi=v(Yi),Bi=v(["bin-linear","bin-ordinal"]);function Vi(t){return t in Gi}function Qi(t){return t in Bi}function Ki(t){return t in $i}function Ji(t){return t in Ci}function Xi(t){return t in qi}const Zi={textXRangeStep:90,rangeStep:20,pointPadding:.5,barBandPaddingInner:.1,rectBandPaddingInner:0,facetSpacing:16,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4};function Di(t){return t&&!!t.name}function Fi(t){return t&&t.selection}const ts={type:1,domain:1,range:1,rangeStep:1,scheme:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},es=X(ts),ns=X(Lt(ts,["type","domain","range","rangeStep","scheme"])),rs=function(){const t={};for(const e of fe)for(const n of K(Qn))for(const r of Ri)for(const i of[!1,!0]){const s=cs(e,n,i);as(e,r)&&os(r,n,i)&&(t[s]=t[s]||[],t[s].push(r))}return t}();function is(t,e){switch(e){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":return N(["sequential","ordinal","bin-ordinal","quantile","quantize","threshold"],t);case"interpolate":return N(["linear","bin-linear","pow","log","sqrt","utc","time"],t);case"round":return Ji(t)||"band"===t||"point"===t;case"padding":return Ji(t)||N(["point","band"],t);case"paddingOuter":case"rangeStep":return N(["point","band"],t);case"paddingInner":return"band"===t;case"clamp":return Ji(t)||"sequential"===t;case"nice":return Ji(t)||"sequential"===t||"quantize"===t;case"exponent":return"pow"===t;case"base":return"log"===t;case"zero":return Ki(t)&&!N(["log","time","utc","bin-linear","threshold","quantile"],t)}throw new Error(`Invalid scale property ${e}.`)}function ss(t,e){switch(e){case"interpolate":case"scheme":return ue(t)?void 0:hn.cannotUseScalePropertyWithNonColor(t);case"type":case"domain":case"range":case"base":case"exponent":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeStep":case"reverse":case"round":case"clamp":case"zero":return}throw new Error(`Invalid scale property "${e}".`)}function os(t,e,n){return N([Bn.ORDINAL,Bn.NOMINAL],e)?void 0===t||Vi(t):e===Bn.TEMPORAL?N([Li.TIME,Li.UTC,Li.SEQUENTIAL,void 0],t):e!==Bn.QUANTITATIVE||N(n?[Li.BIN_LINEAR,Li.BIN_ORDINAL,Li.LINEAR]:[Li.LOG,Li.POW,Li.SQRT,Li.QUANTILE,Li.QUANTIZE,Li.THRESHOLD,Li.LINEAR,Li.SEQUENTIAL,void 0],t)}function as(t,e){switch(t){case wt.X:case wt.Y:return Ji(e)||N(["band","point"],e);case wt.SIZE:case wt.STROKEWIDTH:case wt.OPACITY:case wt.FILLOPACITY:case wt.STROKEOPACITY:return Ji(e)||Xi(e)||N(["band","point"],e);case wt.COLOR:case wt.FILL:case wt.STROKE:return"band"!==e;case wt.SHAPE:return"ordinal"===e}return!1}function cs(t,e,n){const r=t+"_"+e;return n?r+"_bin":r}var us=Object.freeze({get ScaleType(){return Li},SCALE_TYPES:Ri,scaleCompatible:Ui,scaleTypePrecedence:Ni,CONTINUOUS_TO_CONTINUOUS_SCALES:Pi,CONTINUOUS_TO_DISCRETE_SCALES:Hi,CONTINUOUS_DOMAIN_SCALES:Wi,DISCRETE_DOMAIN_SCALES:Yi,TIME_SCALE_TYPES:["time","utc"],hasDiscreteDomain:Vi,isBinScale:Qi,hasContinuousDomain:Ki,isContinuousToContinuous:Ji,isContinuousToDiscrete:Xi,defaultScaleConfig:Zi,isExtendedScheme:Di,isSelectionDomain:Fi,SCALE_PROPERTIES:es,NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES:ns,SCALE_TYPE_INDEX:rs,scaleTypeSupportProperty:is,channelScalePropertyIncompatability:ss,scaleTypeSupportDataType:os,channelSupportScaleType:as,getSupportedScaleType:function(t,e,n){return rs[cs(t,e,n)]}});const ls="_vgsid_";function fs(t){const{anchor:e,frame:n,offset:r,orient:i,color:s}=t,o=Lt(t,["anchor","frame","offset","orient","color"]);return{mark:Object.assign({},o,s?{fill:s}:{}),nonMark:Object.assign({},e?{anchor:e}:{},r?{offset:r}:{},i?{orient:i}:{})}}const ds={width:200,height:200};function ps(t){return t&&!!t.scheme}const ms={padding:5,timeFormat:"%b %d, %Y",countTitle:"Count of Records",invalidValues:"filter",view:ds,mark:an,area:{},bar:cn,circle:{},geoshape:{},line:{},point:{},rect:{},rule:{color:"black"},square:{},text:{color:"black"},tick:un,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:Zi,projection:{},axis:{},axisX:{},axisY:{minExtent:30},axisLeft:{},axisRight:{},axisTop:{},axisBottom:{},axisBand:{},legend:ji,selection:{single:{on:"click",fields:[ls],resolve:"global",empty:"all"},multi:{on:"click",fields:[ls],toggle:"event.shiftKey",resolve:"global",empty:"all"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global"}},style:{},title:{}};function hs(t){return W(L(ms),t)}const gs=["view",...Ze],bs=["padding","numberFormat","timeFormat","countTitle","stack","scale","selection","invalidValues","overlay"],vs=Object.assign({view:["width","height"]},on);function xs(t){t=L(t);for(const e of bs)delete t[e];if(t.axis)for(const e of ki)delete t.axis[e];if(t.legend){for(const e of ki)delete t.legend[e];for(const e of Ei)delete t.legend[e]}if(t.mark)for(const e of sn)delete t.mark[e];for(const e of gs){for(const n of sn)delete t[e][n];const n=vs[e];if(n)for(const r of n)delete t[e][r];ys(t,e)}for(const e of yi())delete t[e];ys(t,"title","group-title");for(const e in t)o(t[e])&&0===K(t[e]).length&&delete t[e];return K(t).length>0?t:void 0}function ys(t,e,n,r){const i="title"===e?fs(t.title).mark:r?t[e][r]:t[e];"view"===e&&(n="cell");const s=Object.assign({},i,t.style[e]);K(s).length>0&&(t.style[n||e]=s),r||delete t[e]}var Ss=Object.freeze({defaultViewConfig:ds,isVgScheme:ps,defaultConfig:ms,initConfig:hs,stripAndRedirectConfig:xs});function Os(t){return!!t.url}function ks(t){return!!t.values}function Es(t){return!!t.name&&!Os(t)&&!ks(t)}const js="main",_s="raw";var As=Object.freeze({isUrlData:Os,isInlineData:ks,isNamedData:Es,MAIN:js,RAW:_s});const ws={titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontWeight:"fontWeight",titleLimit:"limit",titlePadding:"offset"},zs={labelAngle:"angle",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelLimit:"limit",labelPadding:"offset"},Ls=K(ws),Is=K(zs);var Ts=Object.freeze({HEADER_TITLE_PROPERTIES_MAP:ws,HEADER_LABEL_PROPERTIES_MAP:zs,HEADER_TITLE_PROPERTIES:Ls,HEADER_LABEL_PROPERTIES:Is});function Rs(t){return!(!t||"count"!==t.op&&!t.field||!t.op)}function Us(t){return!!t&&s(t)}var Ms=Object.freeze({isSortField:Rs,isSortArray:Us});const Ns={zero:1,center:1,normalize:1};function Ps(t){return!!Ns[t]}const Cs=[Ce,Pe,Be,qe,Qe,Ke,He,We,$e],Hs=[Ce,Pe];function qs(t,e,n){const r=De(t)?t.type:t;if(!N(Cs,r))return null;const i=function(t){const e=t.x,n=t.y;if(cr(e)&&cr(n))if("quantitative"===e.type&&"quantitative"===n.type){if(e.stack)return"x";if(n.stack)return"y";if(!!e.aggregate!=!!n.aggregate)return e.aggregate?"x":"y"}else{if("quantitative"===e.type)return"x";if("quantitative"===n.type)return"y"}else{if(cr(e)&&"quantitative"===e.type)return"x";if(cr(n)&&"quantitative"===n.type)return"y"}}(e);if(!i)return null;const o=e[i],a=lr(o)?gr(o,{}):void 0,c="x"===i?"y":"x",u=e[c],l=lr(u)?gr(u,{}):void 0,f=ve.reduce((t,n)=>{if(Gr(e,n)){const r=e[n];(s(r)?r:[r]).forEach(e=>{const r=Tr(e);if(r.aggregate)return;const i=lr(r)?gr(r,{}):void 0;(!i||i!==l&&i!==a)&&t.push({channel:n,fieldDef:r})})}return t},[]);if(0===f.length)return null;let d;return(d=void 0!==o.stack?o.stack:N(Hs,r)?at(n,"zero"):n)&&Ps(d)?(o.scale&&o.scale.type&&o.scale.type!==Li.LINEAR&&mn(hn.cannotStackNonLinearScale(o.scale.type)),Gr(e,i===It?Rt:Ut)?(void 0!==o.stack&&mn(hn.cannotStackRangedMark(i)),null):(o.aggregate&&!N(bt,o.aggregate)&&mn(hn.stackNonSummativeAggregate(o.aggregate)),{groupbyChannel:u?c:void 0,fieldChannel:i,impute:Xe(r),stackBy:f,offset:d})):null}var Ws=Object.freeze({isStackOffset:Ps,STACKABLE_MARKS:Cs,STACK_BY_DEFAULT_MARKS:Hs,stack:qs});function $s(t){return Ys(t)||Gs(t)}function Ys(t){return void 0!==t.vconcat}function Gs(t){return void 0!==t.hconcat}function Bs(t){return void 0!==t.layer}function Vs(t){return void 0!==t.repeat}function Qs(t,e){return Ks(t,e)}function Ks(t,e){if(jn(t))return function(t,e){const{spec:n}=t,r=Lt(t,["spec"]);return Object.assign({},r,{spec:Ks(n,e)})}(t,e);if(Bs(t))return function t(e,n,r,i){const{layer:s,encoding:o,projection:a}=e,c=Lt(e,["layer","encoding","projection"]);const u=Js({parentEncoding:r,encoding:o});const l=Xs({parentProjection:i,projection:a});return Object.assign({},c,{layer:s.map(e=>Bs(e)?t(e,n,u,l):Zs(e,n,u,l))})}(t,e);if(Vs(t))return function(t,e){const{spec:n}=t,r=Lt(t,["spec"]);return Object.assign({},r,{spec:Ks(n,e)})}(t,e);if(Ys(t))return function(t,e){const{vconcat:n}=t,r=Lt(t,["vconcat"]);return Object.assign({},r,{vconcat:n.map(t=>Ks(t,e))})}(t,e);if(Gs(t))return function(t,e){const{hconcat:n}=t,r=Lt(t,["hconcat"]);return Object.assign({},r,{hconcat:n.map(t=>Ks(t,e))})}(t,e);if(Fs(t)){const n=Gr(t.encoding,Yt),r=Gr(t.encoding,Gt);return n||r?function(t,e){const n=t.encoding,{row:r,column:i}=n,s=Lt(n,["row","column"]),{mark:o,width:a,projection:c,height:u,selection:l,encoding:f}=t,d=Lt(t,["mark","width","projection","height","selection","encoding"]);return Object.assign({},d,{facet:Object.assign({},r?{row:r}:{},i?{column:i}:{}),spec:Zs(Object.assign({},c?{projection:c}:{},{mark:o},a?{width:a}:{},u?{height:u}:{},{encoding:s},l?{selection:l}:{}),e)})}(t,e):Zs(t,e)}throw new Error(hn.INVALID_SPEC)}function Js(t){const{parentEncoding:e,encoding:n}=t;if(e&&n){const t=K(e).reduce((t,e)=>(n[e]&&t.push(e),t),[]);t.length>0&&mn(hn.encodingOverridden(t))}const r=Object.assign({},e||{},n||{});return K(r).length>0?r:void 0}function Xs(t){const{parentProjection:e,projection:n}=t;return e&&n&&mn(hn.projectionOverridden({parentProjection:e,projection:n})),n||e}function Zs(t,e,n,r){const{encoding:i,projection:s}=t,a=De(t.mark)?t.mark.type:t.mark;if(n||r){const o=Xs({parentProjection:r,projection:s}),a=Js({parentEncoding:n,encoding:i});return Zs(Object.assign({},t,o?{projection:o}:{},a?{encoding:a}:{}),e)}return function(t){return tn(t.mark)}(t)?"line"===a&&(i.x2||i.y2)?(mn(hn.lineWithRange(!!i.x2,!!i.y2)),Zs(Object.assign({mark:"rule"},t),e,n,r)):Xe(a)?function(t,e={}){const{selection:n,projection:r,encoding:i,mark:s}=t,a=Lt(t,["selection","projection","encoding","mark"]),c=De(s)?s:{type:s},u=function(t,e,n){return"transparent"===t.point?{opacity:0}:t.point?o(t.point)?t.point:{}:void 0!==t.point?null:e.point||n.shape?o(e.point)?e.point:{}:null}(c,e[c.type],i),l="area"===c.type&&function(t,e){return t.line?!0===t.line?{}:t.line:void 0!==t.line?null:e.line?!0===e.line?{}:e.line:null}(c,e[c.type]);if(!u&&!l)return Object.assign({},t,{mark:Ds(c)});const f=[Object.assign({},n?{selection:n}:{},{mark:Ds(Object.assign({},c,"area"===c.type?{opacity:.7}:{})),encoding:R(i,["shape"])})],d=qs(c,i,e?e.stack:void 0);let p=i;if(d){const{fieldChannel:t,offset:e}=d;p=Object.assign({},i,{[t]:Object.assign({},i[t],e?{stack:e}:{})})}l&&f.push(Object.assign({},r?{projection:r}:{},{mark:Object.assign({type:"line"},T(c,["clip","interpolate","tension"]),l),encoding:p}));u&&f.push(Object.assign({},r?{projection:r}:{},{mark:Object.assign({type:"point",opacity:1,filled:!0},T(c,["clip"]),u),encoding:p}));return Object.assign({},a,{layer:f})}(t,e):t:Si(t,e)}function Ds(t){const e=Lt(t,["point","line"]);return K(e).length>1?e:e.type}function Fs(t){return!!t.mark}function to(t,e){return e.forEach(e=>{const n=M(["field","type","value","timeUnit","bin","aggregate"].reduce((t,n)=>(void 0!==e[n]&&(t[n]=e[n]),t),{}));t[n]=t[n]||e}),t}function eo(t){if(jn(t)||Vs(t))return function(t){return eo(t.spec)}(t);if(Bs(t))return function(t){let e=[];return t.layer.map(t=>{e=e.concat(eo(t))}),e}(t);if(Fs(t))return function(t){const e=[];return Xr(t.encoding,(t,n)=>{cr(t)&&e.push(t.field)}),e}(t);throw new Error(hn.INVALID_SPEC)}var no=Object.freeze({fieldDefs:function(t){return J(function t(e,n={}){return Bs(e)?e.layer.forEach(e=>{Fs(e)?to(n,Jr(e.encoding)):t(e,n)}):jn(e)?(to(n,Jr(e.facet)),t(e.spec,n)):Vs(e)?t(e.spec,n):$s(e)?(Ys(e)?e.vconcat:e.hconcat).forEach(e=>t(e,n)):to(n,Jr(e.encoding)),n}(t))},isStacked:function(t,e){return e=e||t.config,!!tn(t.mark)&&null!==qs(t.mark,t.encoding,e?e.stack:void 0)},usedFields:eo,normalize:Qs,isConcatSpec:$s,isHConcatSpec:Gs,isVConcatSpec:Ys,isFacetSpec:jn,isLayerSpec:Bs,isRepeatSpec:Vs,isUnitSpec:Fs});function ro(t){return t&&!!t.field&&void 0!==t.equal}function io(t){return t&&!!t.field&&void 0!==t.lt}function so(t){return t&&!!t.field&&void 0!==t.lte}function oo(t){return t&&!!t.field&&void 0!==t.gt}function ao(t){return t&&!!t.field&&void 0!==t.gte}function co(t){return!!(t&&t.field&&s(t.range)&&2===t.range.length)}function uo(t){return t&&!!t.field&&(s(t.oneOf)||s(t.in))}function lo(t){return uo(t)||ro(t)||co(t)||io(t)||oo(t)||so(t)||ao(t)}function fo(t,e){return qr(t,{timeUnit:e,time:!0})}function po(t,e=!0){const{field:n,timeUnit:r}=t,i=r?"time("+Wn(r,n)+")":gr(t,{expr:"datum"});if(ro(t))return i+"==="+fo(t.equal,r);if(io(t)){return`${i}<${fo(t.lt,r)}`}if(oo(t)){return`${i}>${fo(t.gt,r)}`}if(so(t)){return`${i}<=${fo(t.lte,r)}`}if(ao(t)){return`${i}>=${fo(t.gte,r)}`}if(uo(t))return`indexof([${function(t,e){return t.map(t=>fo(t,e))}(t.oneOf,r).join(",")}], ${i}) !== -1`;if(function(t){return t&&!!t.field&&void 0!==t.valid}(t))return t.valid?`${i}!==null&&!isNaN(${i})`:`${i}===null||isNaN(${i})`;if(co(t)){const n=t.range[0],s=t.range[1];if(null!==n&&null!==s&&e)return"inrange("+i+", ["+fo(n,r)+", "+fo(s,r)+"])";const o=[];return null!==n&&o.push(`${i} >= ${fo(n,r)}`),null!==s&&o.push(`${i} <= ${fo(s,r)}`),o.length>0?o.join(" && "):"true"}throw new Error(`Invalid field predicate: ${JSON.stringify(t)}`)}function mo(t){return lo(t)&&t.timeUnit?Object.assign({},t,{timeUnit:Gn(t.timeUnit)}):t}function ho(t){return void 0!==t.filter}function go(t){return t&&void 0!==t.start&&void 0!==t.stop}function bo(t){return void 0!==t.lookup}function vo(t){return void 0!==t.sample}function xo(t){return void 0!==t.window}function yo(t){return void 0!==t.flatten}function So(t){return void 0!==t.calculate}function Oo(t){return!!t.bin}function ko(t){return void 0!==t.impute}function Eo(t){return void 0!==t.timeUnit}function jo(t){return void 0!==t.aggregate}function _o(t){return void 0!==t.stack}function Ao(t){return void 0!==t.fold}function wo(t){return t.map(t=>ho(t)?{filter:w(t.filter,mo)}:t)}var zo=Object.freeze({isFilter:ho,isImputeSequence:go,isLookup:bo,isSample:vo,isWindow:xo,isFlatten:yo,isCalculate:So,isBin:Oo,isImpute:ko,isTimeUnit:Eo,isAggregate:jo,isStack:_o,isFold:Ao,normalizeTransform:wo});const Lo={text:["text"],line:["x","y"],trail:["x","y"],area:["x","y"]},Io={bar:v(["row","column","x","y","size","color","fill","stroke","detail"]),line:v(["row","column","x","y","color","fill","stroke","color","detail"]),trail:v(["row","column","x","y","color","fill","stroke","color","detail","size"]),area:v(["row","column","x","y","color","fill","stroke","detail"]),tick:v(["row","column","x","y","color","fill","stroke","detail"]),circle:v(["row","column","x","y","color","fill","stroke","size","detail"]),square:v(["row","column","x","y","color","fill","stroke","size","detail"]),point:v(["row","column","x","y","color","fill","stroke","size","detail","shape"]),geoshape:v(["row","column","color","fill","stroke","detail","shape"]),text:v(["row","column","size","color","fill","stroke","text"])};var To=Object.freeze({DEFAULT_REQUIRED_CHANNEL_MAP:Lo,DEFAULT_SUPPORTED_CHANNEL_TYPE:Io,getEncodingMappingError:function(t,e=Lo,n=Io){const r=De(t.mark)?t.mark.type:t.mark,i=t.encoding,s=e[r],o=n[r];for(const t in s)if(!(s[t]in i))return'Missing encoding channel "'+s[t]+'" for mark "'+r+'"';for(const t in i)if(!o[t])return'Encoding channel "'+t+'" is not supported by mark type "'+r+'"';return r!==Ce||i.x||i.y?null:"Missing both x and y for bar"}});function Ro(t){return a(t)?{type:t}:t||{}}const Uo=["background","padding"];function Mo(t){return Uo.reduce((e,n)=>(t&&void 0!==t[n]&&(e[n]=t[n]),e),{})}function No(t){return!!t.step}function Po(t){return!s(t)&&("field"in t&&"data"in t)}const Co=X({opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeMiterLimit:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,cursor:1,href:1,tooltip:1,cornerRadius:1});function Ho(t,e,n,r={header:!1}){const i=t.combine(),{orient:o,scale:a,title:c,zindex:u}=i,l=Lt(i,["orient","scale","title","zindex"]);if(K(l).forEach(t=>{const n=Ot[t];n&&n!==e&&"both"!==n&&delete l[t]}),"grid"===e){if(!l.grid)return;if(l.encode){const{grid:t}=l.encode;l.encode=Object.assign({},t?{grid:t}:{}),0===K(l.encode).length&&delete l.encode}return Object.assign({scale:a,orient:o},l,{domain:!1,labels:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:at(u,0)})}{if(!r.header&&t.mainExtracted)return;if(l.encode){for(const e of St)t.hasAxisPart(e)||delete l.encode[e];0===K(l.encode).length&&delete l.encode}const e=function(t,e){return s(t)?t.map(t=>wr(t,e)).join(", "):t}(c,n);return Object.assign({scale:a,orient:o,grid:!1},e?{title:e}:{},l,{zindex:at(u,1)})}}function qo(t){return[].concat(t.type,t.style||[])}function Wo(t,e,n,{skipGeneralMarkConfig:r=!1}={}){return at($o(t,e,n.style),n[e.type][t],r?void 0:n.mark[t])}function $o(t,e,n){const r=qo(e);let i;for(const e of r){const r=n[e],s=t;r&&void 0!==r[s]&&(i=r[s])}return i}function Yo(t,e,n,r){const i=Go(t,e,r);if(Ie(t.bin)){return{signal:Qo(gr(t,{expr:n}),gr(t,{expr:n,binSuffix:"end"}),i,r)}}if("quantitative"===t.type)return{signal:`${Bo(gr(t,{expr:n,binSuffix:"range"}),i)}`};if(Hr(t)){const i=dr(t)&&t.scale&&t.scale.type===Li.UTC;return{signal:Ko(gr(t,{expr:n}),t.timeUnit,e,r.text.shortTimeLabels,r.timeFormat,i,!0)}}return{signal:`''+${gr(t,{expr:n})}`}}function Go(t,e,n){if(!Hr(t))return e||(t.type===Kn?n.numberFormat:void 0)}function Bo(t,e){return`format(${t}, "${e||""}")`}function Vo(t,e,n){return Bo(t,e||n.numberFormat)}function Qo(t,e,n,r){return`${t} === null || isNaN(${t}) ? "null" : ${Vo(t,n,r)} + " - " + ${Vo(e,n,r)}`}function Ko(t,e,n,r,i,s,o=!1){return!e||n?(n=n||i)||o?`${s?"utc":"time"}Format(${t}, '${n}')`:void 0:Yn(e,t,r,s)}function Jo(t,e){return(s(t)?t:[t]).reduce((t,n)=>(t.field.push(gr(n,e)),t.order.push(n.sort||"ascending"),t),{field:[],order:[]})}function Xo(t,e){const n=[...t];return e.forEach(t=>{for(const e of n)if(U(e)===U(t))return;n.push(t)}),n}function Zo(t,e){return t!==e&&e?t?t+", "+e:e:t}function Do(t,e){if(s(t.value)&&s(e.value))return{explicit:t.explicit,value:Xo(t.value,e.value)};if(!s(t.value)&&!s(e.value))return{explicit:t.explicit,value:Zo(t.value,e.value)};throw new Error("It should never reach here")}class Fo{constructor(t,e){this.debugName=e,this._children=[],this._parent=null,t&&(this.parent=t)}clone(){throw new Error("Cannot clone node")}hash(){return void 0===this._hash&&(this._hash=ut()),this._hash}producedFields(){return new Set}dependentFields(){return new Set}get parent(){return this._parent}set parent(t){this._parent=t,t.addChild(this)}get children(){return this._children}numChildren(){return this._children.length}addChild(t,e){this._children.indexOf(t)>-1?console.warn("Attempt to add the same child twice."):void 0!==e?this._children.splice(e,0,t):this._children.push(t)}removeChild(t){const e=this._children.indexOf(t);return this._children.splice(e,1),e}remove(){let t=this._parent.removeChild(this);for(const e of this._children)e._parent=this._parent,this._parent.addChild(e,t++)}insertAsParentOf(t){const e=t.parent;e.removeChild(this),this.parent=e,t.parent=this}swapWithParent(){const t=this._parent,e=t.parent;for(const e of this._children)e.parent=t;this._children=[],t.removeChild(this),t.parent.removeChild(t),this.parent=e,t.parent=this}}class ta extends Fo{constructor(t,e,n,r){super(t,e),this.type=n,this.refCounts=r,this._source=this._name=e,!this.refCounts||this._name in this.refCounts||(this.refCounts[this._name]=0)}clone(){const t=new this.constructor;return t.debugName="clone_"+this.debugName,t._source=this._source,t._name="clone_"+this._name,t.type=this.type,t.refCounts=this.refCounts,t.refCounts[t._name]=0,t}getSource(){return this.refCounts[this._name]++,this._source}isRequired(){return!!this.refCounts[this._name]}setSource(t){this._source=t}}function ea(t){this.type=t}var na,ra,ia,sa,oa;ea.prototype.visit=function(t){var e,n,r;if(t(this))return 1;for(n=0,r=(e=function(t){switch(t.type){case"ArrayExpression":return t.elements;case"BinaryExpression":case"LogicalExpression":return[t.left,t.right];case"CallExpression":var e=t.arguments.slice();return e.unshift(t.callee),e;case"ConditionalExpression":return[t.test,t.consequent,t.alternate];case"MemberExpression":return[t.object,t.property];case"ObjectExpression":return t.properties;case"Property":return[t.key,t.value];case"UnaryExpression":return[t.argument];case"Identifier":case"Literal":case"RawCode":default:return[]}}(this)).length;n<r;++n)if(e[n].visit(t))return 1};var aa=1,ca=2,ua=3,la=4,fa=5,da=6,pa=7,ma=8;(na={})[aa]="Boolean",na[ca]="<end>",na[ua]="Identifier",na[la]="Keyword",na[fa]="Null",na[da]="Numeric",na[pa]="Punctuator",na[ma]="String",na[9]="RegularExpression";var ha="ArrayExpression",ga="BinaryExpression",ba="CallExpression",va="ConditionalExpression",xa="Identifier",ya="Literal",Sa="LogicalExpression",Oa="MemberExpression",ka="ObjectExpression",Ea="Property",ja="UnaryExpression",_a="Unexpected token %0",Aa="Unexpected number",wa="Unexpected string",za="Unexpected identifier",La="Unexpected reserved word",Ia="Unexpected end of input",Ta="Invalid regular expression",Ra="Invalid regular expression: missing /",Ua="Octal literals are not allowed in strict mode.",Ma="Duplicate data property in object literal not allowed in strict mode",Na="ILLEGAL",Pa="Disabled.",Ca=new RegExp("[--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------]"),Ha=new RegExp("[--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------]");function qa(t,e){if(!t)throw new Error("ASSERT: "+e)}function Wa(t){return t>=48&&t<=57}function $a(t){return"0123456789abcdefABCDEF".indexOf(t)>=0}function Ya(t){return"01234567".indexOf(t)>=0}function Ga(t){return 32===t||9===t||11===t||12===t||160===t||t>=5760&&[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(t)>=0}function Ba(t){return 10===t||13===t||8232===t||8233===t}function Va(t){return 36===t||95===t||t>=65&&t<=90||t>=97&&t<=122||92===t||t>=128&&Ca.test(String.fromCharCode(t))}function Qa(t){return 36===t||95===t||t>=65&&t<=90||t>=97&&t<=122||t>=48&&t<=57||92===t||t>=128&&Ha.test(String.fromCharCode(t))}var Ka={if:1,in:1,do:1,var:1,for:1,new:1,try:1,let:1,this:1,else:1,case:1,void:1,with:1,enum:1,while:1,break:1,catch:1,throw:1,const:1,yield:1,class:1,super:1,return:1,typeof:1,delete:1,switch:1,export:1,import:1,public:1,static:1,default:1,finally:1,extends:1,package:1,private:1,function:1,continue:1,debugger:1,interface:1,protected:1,instanceof:1,implements:1};function Ja(){for(var t;ia<sa&&(Ga(t=ra.charCodeAt(ia))||Ba(t));)++ia}function Xa(t){var e,n,r,i=0;for(n="u"===t?4:2,e=0;e<n;++e)ia<sa&&$a(ra[ia])?(r=ra[ia++],i=16*i+"0123456789abcdef".indexOf(r.toLowerCase())):dc({},_a,Na);return String.fromCharCode(i)}function Za(){var t,e,n,r;for(e=0,"}"===(t=ra[ia])&&dc({},_a,Na);ia<sa&&$a(t=ra[ia++]);)e=16*e+"0123456789abcdef".indexOf(t.toLowerCase());return(e>1114111||"}"!==t)&&dc({},_a,Na),e<=65535?String.fromCharCode(e):(n=55296+(e-65536>>10),r=56320+(e-65536&1023),String.fromCharCode(n,r))}function Da(){var t,e;for(t=ra.charCodeAt(ia++),e=String.fromCharCode(t),92===t&&(117!==ra.charCodeAt(ia)&&dc({},_a,Na),++ia,(t=Xa("u"))&&"\\"!==t&&Va(t.charCodeAt(0))||dc({},_a,Na),e=t);ia<sa&&Qa(t=ra.charCodeAt(ia));)++ia,e+=String.fromCharCode(t),92===t&&(e=e.substr(0,e.length-1),117!==ra.charCodeAt(ia)&&dc({},_a,Na),++ia,(t=Xa("u"))&&"\\"!==t&&Qa(t.charCodeAt(0))||dc({},_a,Na),e+=t);return e}function Fa(){var t,e;return t=ia,{type:1===(e=92===ra.charCodeAt(ia)?Da():function(){var t,e;for(t=ia++;ia<sa;){if(92===(e=ra.charCodeAt(ia)))return ia=t,Da();if(!Qa(e))break;++ia}return ra.slice(t,ia)}()).length?ua:Ka.hasOwnProperty(e)?la:"null"===e?fa:"true"===e||"false"===e?aa:ua,value:e,start:t,end:ia}}function tc(){var t,e,n,r,i=ia,s=ra.charCodeAt(ia),o=ra[ia];switch(s){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:return++ia,{type:pa,value:String.fromCharCode(s),start:i,end:ia};default:if(61===(t=ra.charCodeAt(ia+1)))switch(s){case 43:case 45:case 47:case 60:case 62:case 94:case 124:case 37:case 38:case 42:return ia+=2,{type:pa,value:String.fromCharCode(s)+String.fromCharCode(t),start:i,end:ia};case 33:case 61:return ia+=2,61===ra.charCodeAt(ia)&&++ia,{type:pa,value:ra.slice(i,ia),start:i,end:ia}}}return">>>="===(r=ra.substr(ia,4))?{type:pa,value:r,start:i,end:ia+=4}:">>>"===(n=r.substr(0,3))||"<<="===n||">>="===n?{type:pa,value:n,start:i,end:ia+=3}:o===(e=n.substr(0,2))[1]&&"+-<>&|".indexOf(o)>=0||"=>"===e?{type:pa,value:e,start:i,end:ia+=2}:"<>=!+-*%&|^/".indexOf(o)>=0?{type:pa,value:o,start:i,end:++ia}:void dc({},_a,Na)}function ec(){var t,e,n;if(qa(Wa((n=ra[ia]).charCodeAt(0))||"."===n,"Numeric literal must start with a decimal digit or a decimal point"),e=ia,t="","."!==n){if(t=ra[ia++],n=ra[ia],"0"===t){if("x"===n||"X"===n)return++ia,function(t){for(var e="";ia<sa&&$a(ra[ia]);)e+=ra[ia++];return 0===e.length&&dc({},_a,Na),Va(ra.charCodeAt(ia))&&dc({},_a,Na),{type:da,value:parseInt("0x"+e,16),start:t,end:ia}}(e);if(Ya(n))return function(t){for(var e="0"+ra[ia++];ia<sa&&Ya(ra[ia]);)e+=ra[ia++];return(Va(ra.charCodeAt(ia))||Wa(ra.charCodeAt(ia)))&&dc({},_a,Na),{type:da,value:parseInt(e,8),octal:!0,start:t,end:ia}}(e);n&&Wa(n.charCodeAt(0))&&dc({},_a,Na)}for(;Wa(ra.charCodeAt(ia));)t+=ra[ia++];n=ra[ia]}if("."===n){for(t+=ra[ia++];Wa(ra.charCodeAt(ia));)t+=ra[ia++];n=ra[ia]}if("e"===n||"E"===n)if(t+=ra[ia++],"+"!==(n=ra[ia])&&"-"!==n||(t+=ra[ia++]),Wa(ra.charCodeAt(ia)))for(;Wa(ra.charCodeAt(ia));)t+=ra[ia++];else dc({},_a,Na);return Va(ra.charCodeAt(ia))&&dc({},_a,Na),{type:da,value:parseFloat(t),start:e,end:ia}}function nc(){var t,e,n,r;return oa=null,Ja(),t=ia,e=function(){var t,e,n,r;for(qa("/"===(t=ra[ia]),"Regular expression literal must start with a slash"),e=ra[ia++],n=!1,r=!1;ia<sa;)if(e+=t=ra[ia++],"\\"===t)Ba((t=ra[ia++]).charCodeAt(0))&&dc({},Ra),e+=t;else if(Ba(t.charCodeAt(0)))dc({},Ra);else if(n)"]"===t&&(n=!1);else{if("/"===t){r=!0;break}"["===t&&(n=!0)}return r||dc({},Ra),{value:e.substr(1,e.length-2),literal:e}}(),n=function(){var t,e,n;for(e="",n="";ia<sa&&Qa((t=ra[ia]).charCodeAt(0));)++ia,"\\"===t&&ia<sa?dc({},_a,Na):(n+=t,e+=t);return n.search(/[^gimuy]/g)>=0&&dc({},Ta,n),{value:n,literal:e}}(),r=function(t,e){var n=t;e.indexOf("u")>=0&&(n=n.replace(/\\u\{([0-9a-fA-F]+)\}/g,function(t,e){if(parseInt(e,16)<=1114111)return"x";dc({},Ta)}).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"x"));try{return new RegExp(t,e)}catch(t){return null}}(e.value,n.value),{literal:e.literal+n.literal,value:r,regex:{pattern:e.value,flags:n.value},start:t,end:ia}}function rc(){var t;return Ja(),ia>=sa?{type:ca,start:ia,end:ia}:Va(t=ra.charCodeAt(ia))?Fa():40===t||41===t||59===t?tc():39===t||34===t?function(){var t,e,n,r,i="",s=!1;for(qa("'"===(t=ra[ia])||'"'===t,"String literal must starts with a quote"),e=ia,++ia;ia<sa;){if((n=ra[ia++])===t){t="";break}if("\\"===n)if((n=ra[ia++])&&Ba(n.charCodeAt(0)))"\r"===n&&"\n"===ra[ia]&&++ia;else switch(n){case"u":case"x":"{"===ra[ia]?(++ia,i+=Za()):i+=Xa(n);break;case"n":i+="\n";break;case"r":i+="\r";break;case"t":i+="\t";break;case"b":i+="\b";break;case"f":i+="\f";break;case"v":i+="\v";break;default:Ya(n)?(0!==(r="01234567".indexOf(n))&&(s=!0),ia<sa&&Ya(ra[ia])&&(s=!0,r=8*r+"01234567".indexOf(ra[ia++]),"0123".indexOf(n)>=0&&ia<sa&&Ya(ra[ia])&&(r=8*r+"01234567".indexOf(ra[ia++]))),i+=String.fromCharCode(r)):i+=n}else{if(Ba(n.charCodeAt(0)))break;i+=n}}return""!==t&&dc({},_a,Na),{type:ma,value:i,octal:s,start:e,end:ia}}():46===t?Wa(ra.charCodeAt(ia+1))?ec():tc():Wa(t)?ec():tc()}function ic(){var t;return ia=(t=oa).end,oa=rc(),ia=t.end,t}function sc(){var t;t=ia,oa=rc(),ia=t}function oc(t,e,n){var r=new ea("||"===t||"&&"===t?Sa:ga);return r.operator=t,r.left=e,r.right=n,r}function ac(t,e){var n=new ea(ba);return n.callee=t,n.arguments=e,n}function cc(t){var e=new ea(xa);return e.name=t,e}function uc(t){var e=new ea(ya);return e.value=t.value,e.raw=ra.slice(t.start,t.end),t.regex&&("//"===e.raw&&(e.raw="/(?:)/"),e.regex=t.regex),e}function lc(t,e,n){var r=new ea(Oa);return r.computed="["===t,r.object=e,r.property=n,r.computed||(n.member=!0),r}function fc(t,e,n){var r=new ea(Ea);return r.key=e,r.value=n,r.kind=t,r}function dc(t,e){var n,r=Array.prototype.slice.call(arguments,2),i=e.replace(/%(\d)/g,function(t,e){return qa(e<r.length,"Message reference must be in range"),r[e]});throw(n=new Error(i)).index=ia,n.description=i,n}function pc(t){t.type===ca&&dc(t,Ia),t.type===da&&dc(t,Aa),t.type===ma&&dc(t,wa),t.type===ua&&dc(t,za),t.type===la&&dc(t,La),dc(t,_a,t.value)}function mc(t){var e=ic();e.type===pa&&e.value===t||pc(e)}function hc(t){return oa.type===pa&&oa.value===t}function gc(t){return oa.type===la&&oa.value===t}function bc(){var t=[];for(ia=oa.start,mc("[");!hc("]");)hc(",")?(ic(),t.push(null)):(t.push(zc()),hc("]")||mc(","));return ic(),function(t){var e=new ea(ha);return e.elements=t,e}(t)}function vc(){var t;return ia=oa.start,(t=ic()).type===ma||t.type===da?(t.octal&&dc(t,Ua),uc(t)):cc(t.value)}function xc(){var t,e,n;return ia=oa.start,(t=oa).type===ua?(n=vc(),mc(":"),fc("init",n,zc())):t.type!==ca&&t.type!==pa?(e=vc(),mc(":"),fc("init",e,zc())):void pc(t)}function yc(){var t,e,n=[],r={},i=String;for(ia=oa.start,mc("{");!hc("}");)e="$"+((t=xc()).key.type===xa?t.key.name:i(t.key.value)),Object.prototype.hasOwnProperty.call(r,e)?dc({},Ma):r[e]=!0,n.push(t),hc("}")||mc(",");return mc("}"),function(t){var e=new ea(ka);return e.properties=t,e}(n)}var Sc={if:1,this:1};function Oc(){var t,e,n;if(hc("("))return function(){var t;return mc("("),t=Lc(),mc(")"),t}();if(hc("["))return bc();if(hc("{"))return yc();if(t=oa.type,ia=oa.start,t===ua||Sc[oa.value])n=cc(ic().value);else if(t===ma||t===da)oa.octal&&dc(oa,Ua),n=uc(ic());else{if(t===la)throw new Error(Pa);t===aa?((e=ic()).value="true"===e.value,n=uc(e)):t===fa?((e=ic()).value=null,n=uc(e)):hc("/")||hc("/=")?(n=uc(nc()),sc()):pc(ic())}return n}function kc(){var t=[];if(mc("("),!hc(")"))for(;ia<sa&&(t.push(zc()),!hc(")"));)mc(",");return mc(")"),t}function Ec(){var t;return ia=oa.start,function(t){return t.type===ua||t.type===la||t.type===aa||t.type===fa}(t=ic())||pc(t),cc(t.value)}function jc(){var t;return mc("["),t=Lc(),mc("]"),t}function _c(){var t=function(){var t;for(t=Oc();;)if(hc("."))mc("."),t=lc(".",t,Ec());else if(hc("("))t=ac(t,kc());else{if(!hc("["))break;t=lc("[",t,jc())}return t}();if(oa.type===pa&&(hc("++")||hc("--")))throw new Error(Pa);return t}function Ac(){var t,e,n,r,i;if(oa.type!==pa&&oa.type!==la)e=_c();else{if(hc("++")||hc("--"))throw new Error(Pa);if(hc("+")||hc("-")||hc("~")||hc("!"))t=ic(),e=Ac(),n=t.value,r=e,(i=new ea(ja)).operator=n,i.argument=r,i.prefix=!0,e=i;else{if(gc("delete")||gc("void")||gc("typeof"))throw new Error(Pa);e=_c()}}return e}function wc(t){var e=0;if(t.type!==pa&&t.type!==la)return 0;switch(t.value){case"||":e=1;break;case"&&":e=2;break;case"|":e=3;break;case"^":e=4;break;case"&":e=5;break;case"==":case"!=":case"===":case"!==":e=6;break;case"<":case">":case"<=":case">=":case"instanceof":case"in":e=7;break;case"<<":case">>":case">>>":e=8;break;case"+":case"-":e=9;break;case"*":case"/":case"%":e=11}return e}function zc(){var t,e;return t=function(){var t,e,n,r,i,s,o,a,c,u;if(t=oa,c=Ac(),0===(i=wc(r=oa)))return c;for(r.prec=i,ic(),e=[t,oa],s=[c,r,o=Ac()];(i=wc(oa))>0;){for(;s.length>2&&i<=s[s.length-2].prec;)o=s.pop(),a=s.pop().value,c=s.pop(),e.pop(),n=oc(a,c,o),s.push(n);(r=ic()).prec=i,s.push(r),e.push(oa),n=Ac(),s.push(n)}for(n=s[u=s.length-1],e.pop();u>1;)e.pop(),n=oc(s[u-1].value,s[u-2],n),u-=2;return n}(),hc("?")&&(ic(),e=zc(),mc(":"),t=function(t,e,n){var r=new ea(va);return r.test=t,r.consequent=e,r.alternate=n,r}(t,e,zc())),t}function Lc(){var t=zc();if(hc(","))throw new Error(Pa);return t}function Ic(t){ia=0,sa=(ra=t).length,oa=null,sc();var e=Lc();if(oa.type!==ca)throw new Error("Unexpect token after expression.");return e}var Tc={NaN:"NaN",E:"Math.E",LN2:"Math.LN2",LN10:"Math.LN10",LOG2E:"Math.LOG2E",LOG10E:"Math.LOG10E",PI:"Math.PI",SQRT1_2:"Math.SQRT1_2",SQRT2:"Math.SQRT2",MIN_VALUE:"Number.MIN_VALUE",MAX_VALUE:"Number.MAX_VALUE"};function Rc(t,e,n){return t.fields=e||[],t.fname=n,t}function Uc(t){throw Error(t)}var Mc=Array.isArray;function Nc(t){return"string"==typeof t}function Pc(t){return Mc(t)?"["+t.map(Pc)+"]":(e=t)===Object(e)||Nc(t)?JSON.stringify(t).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):t;var e}var Cc=[];(function(t,e){var n=function(t){var e,n,r,i=[],s=null,o=0,a=t.length,c="";function u(){i.push(c+t.substring(e,n)),c="",e=n+1}for(t+="",e=n=0;n<a;++n)if("\\"===(r=t[n]))c+=t.substring(e,n),e=++n;else if(r===s)u(),s=null,o=-1;else{if(s)continue;e===o&&'"'===r?(e=n+1,s=r):e===o&&"'"===r?(e=n+1,s=r):"."!==r||o?"["===r?(n>e&&u(),o=e=n+1):"]"===r&&(o||Uc("Access path missing open bracket: "+t),o>0&&u(),o=0,e=n+1):n>e?u():e=n+1}return o&&Uc("Access path missing closing bracket: "+t),s&&Uc("Access path missing closing quote: "+t),n>e&&(n++,u()),i}(t),r="return _["+n.map(Pc).join("][")+"];";Rc(Function("_",r),[t=1===n.length?n[0]:t],e||t)})("id"),Rc(function(t){return t},Cc,"identity"),Rc(function(){return 0},Cc,"zero"),Rc(function(){return 1},Cc,"one"),Rc(function(){return!0},Cc,"true"),Rc(function(){return!1},Cc,"false");function Hc(t){return"function"==typeof t}function qc(t){for(var e={},n=0,r=t.length;n<r;++n)e[t[n]]=!0;return e}function Wc(t){function e(e,n,r){return function(i){return function(e,n,r,i){var s=t(n[0]);return r&&(s=r+"("+s+")",0===r.lastIndexOf("new ",0)&&(s="("+s+")")),s+"."+e+(i<0?"":0===i?"()":"("+n.slice(1).map(t).join(",")+")")}(e,i,n,r)}}var n="new Date";return{isNaN:"isNaN",isFinite:"isFinite",abs:"Math.abs",acos:"Math.acos",asin:"Math.asin",atan:"Math.atan",atan2:"Math.atan2",ceil:"Math.ceil",cos:"Math.cos",exp:"Math.exp",floor:"Math.floor",log:"Math.log",max:"Math.max",min:"Math.min",pow:"Math.pow",random:"Math.random",round:"Math.round",sin:"Math.sin",sqrt:"Math.sqrt",tan:"Math.tan",clamp:function(e){e.length<3&&Uc("Missing arguments to clamp function."),e.length>3&&Uc("Too many arguments to clamp function.");var n=e.map(t);return"Math.max("+n[1]+", Math.min("+n[2]+","+n[0]+"))"},now:"Date.now",utc:"Date.UTC",datetime:n,date:e("getDate",n,0),day:e("getDay",n,0),year:e("getFullYear",n,0),month:e("getMonth",n,0),hours:e("getHours",n,0),minutes:e("getMinutes",n,0),seconds:e("getSeconds",n,0),milliseconds:e("getMilliseconds",n,0),time:e("getTime",n,0),timezoneoffset:e("getTimezoneOffset",n,0),utcdate:e("getUTCDate",n,0),utcday:e("getUTCDay",n,0),utcyear:e("getUTCFullYear",n,0),utcmonth:e("getUTCMonth",n,0),utchours:e("getUTCHours",n,0),utcminutes:e("getUTCMinutes",n,0),utcseconds:e("getUTCSeconds",n,0),utcmilliseconds:e("getUTCMilliseconds",n,0),length:e("length",null,-1),indexof:e("indexOf",null),lastindexof:e("lastIndexOf",null),slice:e("slice",null),parseFloat:"parseFloat",parseInt:"parseInt",upper:e("toUpperCase","String",0),lower:e("toLowerCase","String",0),substring:e("substring","String"),split:e("split","String"),replace:e("replace","String"),regexp:"RegExp",test:e("test","RegExp"),if:function(e){e.length<3&&Uc("Missing arguments to if function."),e.length>3&&Uc("Too many arguments to if function.");var n=e.map(t);return"("+n[0]+"?"+n[1]+":"+n[2]+")"}}}function $c(t){const e=Ic(t),n=new Set;return e.visit(t=>{"MemberExpression"===t.type&&function t(e){return"MemberExpression"===e.object.type?t(e.object):"datum"===e.object.name}(t)&&n.add(function t(e){let n=[];return"Identifier"===e.type?[e.name]:"Literal"===e.type?[e.value]:("MemberExpression"===e.type&&(n=(n=n.concat(t(e.object))).concat(t(e.property))),n)}(t).slice(1).join("."))}),n}class Yc extends Fo{constructor(t,e){super(t),this.transform=e,this._dependentFields=$c(this.transform.calculate)}clone(){return new Yc(null,L(this.transform))}static parseAllForSortIndex(t,e){return e.forEachFieldDef((e,n)=>{if(dr(e)&&Us(e.sort)){const{field:r,timeUnit:i}=e,s=e.sort,o=s.map((t,e)=>`${po({field:r,timeUnit:i,equal:t})} ? ${e} : `).join("")+s.length;t=new Yc(t,{calculate:o,as:Gc(e,n,{forAs:!0})})}}),t}producedFields(){return new Set([this.transform.as])}dependentFields(){return this._dependentFields}assemble(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}}hash(){return`Calculate ${M(this.transform)}`}}function Gc(t,e,n){return gr(t,Object.assign({prefix:e,suffix:"sort_index"},n||{}))}const Bc=["row","column"],Vc=["header","footer"];function Qc(t,e){const n=t.component.layoutHeaders[e].title,r=t.config?t.config:void 0,i=t.component.layoutHeaders[e].facetFieldDef?t.component.layoutHeaders[e].facetFieldDef:void 0;return{name:`${e}-title`,type:"group",role:`${e}-title`,title:Object.assign({text:n,offset:10},"row"===e?{orient:"left"}:{},{style:"guide-title"},Zc(r,i,Ls,ws))}}function Kc(t,e){const n=t.component.layoutHeaders[e],r=[];for(const i of Vc)if(n[i])for(const s of n[i])r.push(Xc(t,e,i,n,s));return r}function Jc(t,e){const{sort:n}=t;return Rs(n)?{field:gr(n,{expr:"datum"}),order:n.order||"ascending"}:s(n)?{field:Gc(t,e,{expr:"datum"}),order:"ascending"}:{field:gr(t,{expr:"datum"}),order:n||"ascending"}}function Xc(t,e,n,r,i){if(i){let o=null;const{facetFieldDef:a}=r;if(a&&i.labels){const{header:n={}}=a,{format:r,labelAngle:i}=n,c=t.config?t.config:void 0,u=Object.assign({},(90+(s=((s=i)%360+360)%360))%180==0?{}:s<90||270<s?{align:{value:"right"}}:135<=s&&s<225?{align:{value:"left"}}:{});o=Object.assign({text:Yo(a,r,"parent",t.config),offset:10},"row"===e?{orient:"left"}:{},{style:"guide-label"},void 0!==i?{angle:i}:{},function(t){return 45<=(t=(t%360+360)%360)&&t<=135?{baseline:"top"}:{baseline:"middle"}}(i),Zc(c,a,Is,zs),K(u).length>0?{encode:{update:u}}:{})}const c=i.axes,u=c&&c.length>0;if(o||u){const s="row"===e?"height":"width";return Object.assign({name:t.getName(`${e}_${n}`),type:"group",role:`${e}-${n}`},r.facetFieldDef?{from:{data:t.getName(e+"_domain")},sort:Jc(a,e)}:{},o?{title:o}:{},i.sizeSignal?{encode:{update:{[s]:i.sizeSignal}}}:{},u?{axes:c}:{})}}var s;return null}function Zc(t,e,n,r){const i={};for(const s of n)t&&t.header&&t.header[s]&&(i[r[s]]=t.header[s]),e&&e.header&&e.header[s]&&(i[r[s]]=e.header[s]);return i}function Dc(t){return[].concat(Fc(t,"width"),Fc(t,"height"))}function Fc(t,e){const n="width"===e?"x":"y",r=t.component.layoutSize.get(e);if(!r||"merged"===r)return[];const i=t.getSizeSignalRef(e).signal;if("range-step"===r){const e=t.getScaleComponent(n);if(e){const r=e.get("type"),s=e.get("range");if(Vi(r)&&No(s)){const r=t.scaleName(n);if(Ff(t.parent)){if("independent"===t.parent.component.resolve.scale[n])return[tu(r,s)]}return[tu(r,s),{name:i,update:eu(r,e,`domain('${r}').length`)}]}}throw new Error("layout size is range step although there is no rangeStep.")}return[{name:i,value:r}]}function tu(t,e){return{name:t+"_step",value:e.step}}function eu(t,e,n){const r=e.get("type"),i=e.get("padding"),s=at(e.get("paddingOuter"),i);let o=e.get("paddingInner");return`bandspace(${n}, ${o="band"===r?void 0!==o?o:i:1}, ${s}) * ${t}_step`}function nu(t,e,n){return ru=e||su,iu=n||hu,bu(t.trim()).map(vu)}var ru,iu,su="view",ou="[",au="]",cu="{",uu="}",lu=":",fu=",",du="@",pu=">",mu=/[[\]{}]/,hu={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};function gu(t,e,n,r,i){for(var s,o=0,a=t.length;e<a;++e){if(s=t[e],!o&&s===n)return e;i&&i.indexOf(s)>=0?--o:r&&r.indexOf(s)>=0&&++o}return e}function bu(t){for(var e=[],n=0,r=t.length,i=0;i<r;)i=gu(t,i,fu,ou+cu,au+uu),e.push(t.substring(n,i).trim()),n=++i;if(0===e.length)throw"Empty event selector: "+t;return e}function vu(t){return"["===t[0]?function(t){var e,n,r=t.length,i=1;if((i=gu(t,i,au,ou,au))===r)throw"Empty between selector: "+t;if(2!==(e=bu(t.substring(1,i))).length)throw"Between selector must have two elements: "+t;if((t=t.slice(i+1).trim())[0]!==pu)throw"Expected '>' after between selector: "+t;if(e=e.map(vu),(n=vu(t.slice(1).trim())).between)return{between:e,stream:n};n.between=e;return n}(t):function(t){var e,n,r={source:ru},i=[],s=[0,0],o=0,a=0,c=t.length,u=0;if(t[c-1]===uu){if(!((u=t.lastIndexOf(cu))>=0))throw"Unmatched right brace: "+t;try{s=function(t){var e=t.split(fu);if(!t.length||e.length>2)throw t;return e.map(function(e){var n=+e;if(n!=n)throw t;return n})}(t.substring(u+1,c-1))}catch(e){throw"Invalid throttle specification: "+t}t=t.slice(0,u).trim(),c=t.length,u=0}if(!c)throw t;t[0]===du&&(o=++u);(e=gu(t,u,lu))<c&&(i.push(t.substring(a,e).trim()),a=u=++e);if((u=gu(t,u,ou))===c)i.push(t.substring(a,c).trim());else if(i.push(t.substring(a,u).trim()),n=[],(a=++u)===c)throw"Unmatched left bracket: "+t;for(;u<c;){if((u=gu(t,u,au))===c)throw"Unmatched left bracket: "+t;if(n.push(t.substring(a,u).trim()),u<c-1&&t[++u]!==ou)throw"Expected left bracket: "+t;a=++u}if(!(c=i.length)||mu.test(i[c-1]))throw"Invalid event selector: "+t;c>1?(r.type=i[1],o?r.markname=i[0].slice(1):(l=i[0],iu.hasOwnProperty(l)?r.marktype=i[0]:r.source=i[0])):r.type=i[0];var l;"!"===r.type.slice(-1)&&(r.consume=!0,r.type=r.type.slice(0,-1));null!=n&&(r.filter=n);s[0]&&(r.throttle=s[0]);s[1]&&(r.debounce=s[1]);return r}(t)}class xu extends Fo{constructor(t,e){super(t),this.formula=e}clone(){return new xu(null,L(this.formula))}static makeFromEncoding(t,e){const n=e.reduceFieldDef((t,e)=>{if(e.timeUnit){const n=gr(e,{forAs:!0});t[n]={as:n,timeUnit:e.timeUnit,field:e.field}}return t},{});return 0===K(n).length?null:new xu(t,n)}static makeFromTransform(t,e){return new xu(t,{[e.field]:{as:e.as,timeUnit:e.timeUnit,field:e.field}})}merge(t){this.formula=Object.assign({},this.formula,t.formula),t.remove()}producedFields(){return new Set(J(this.formula).map(t=>t.as))}dependentFields(){return new Set(J(this.formula).map(t=>t.field))}hash(){return`TimeUnit ${M(this.formula)}`}assemble(){return J(this.formula).map(t=>({type:"formula",as:t.as,expr:Wn(t.timeUnit,t.field)}))}}const yu="_fields",Su={has:t=>{const e=t;return void 0!==e.fields||void 0!==e.encodings},parse:(t,e,n)=>{const r={},i={},s=n.project||(n.project=[]);n.fields={},e.fields&&s.push(...e.fields.map(t=>({field:t,type:"E"})));for(const o of e.encodings||[]){const e=t.fieldDef(o);if(e){let a=e.field;if(e.timeUnit&&(r[a=t.vgField(o)]={as:a,field:e.field,timeUnit:e.timeUnit}),!i[a]){let r="E";if("interval"===n.type){const e=t.getScaleComponent(o).get("type");Ki(e)&&!Qi(e)&&(r="R")}else e.bin&&(r="R-RE");s.push(i[a]={field:a,channel:o,type:r})}n.fields[o]=a}else mn(hn.cannotProjectOnChannelWithoutField(o))}K(r).length&&(n.timeUnit=new xu(null,r))},signals:(t,e,n)=>{const r=e.name+Yu+yu;return n.filter(t=>t.name===r).length?n:n.concat({name:r,update:`${JSON.stringify(e.project)}`})}},Ou={has:t=>"interval"===t.type&&"global"===t.resolve&&t.bind&&"scales"===t.bind,parse:(t,e,n)=>{const r=D(n.name),i=n.scales=[];for(const e of n.project){const n=e.channel;if(!_e(n))continue;const s=t.getScaleComponent(n),o=s?s.get("type"):void 0;if(s&&Ki(o)&&!Qi(o)){if(s.set("domainRaw",{signal:nt(e.field,r)},!0),i.push(n),t.repeater&&t.repeater.row===t.repeater.column){t.getScaleComponent(n===It?Tt:It).set("domainRaw",{signal:nt(e.field,r)},!0)}}else mn(hn.SCALE_BINDINGS_CONTINUOUS)}},topLevelSignals:(t,e,n)=>{const r=e.scales.filter(t=>!n.filter(n=>n.name===Fu(e,t,"data")).length).map(t=>({channel:t,signal:Fu(e,t,"data")}));if(!t.parent||!r.length)return n;const i=n.filter(t=>t.name===e.name)[0],s=i.update;if(s.indexOf(Vu)>=0)i.update="{"+r.map(t=>`${c(e.fields[t.channel])}: ${t.signal}`).join(", ")+"}";else for(const t of r){const n=`, ${c(e.fields[t.channel])}: ${t.signal}`;s.indexOf(n)<0&&(i.update=s.substring(0,s.length-1)+n+"}")}return n.concat(r.map(t=>({name:t.signal})))},signals:(t,e,n)=>{if(t.parent)for(const t of e.scales){const r=n.filter(n=>n.name===Fu(e,t,"data"))[0];r.push="outer",delete r.value,delete r.update}return n}};function ku(t,e){return`domain(${c(t.scaleName(e))})`}const Eu="_scale_trigger",ju={signals:(t,e)=>{const n=e.name,r=n+Yu+yu,i=Ou.has(e),s=[],o=[],a=[];if(e.translate&&!i){const t=`!event.item || event.item.mark.name !== ${c(n+"_brush")}`;Au(e,(e,n)=>{const r=n.between[0].filter||(n.between[0].filter=[]);r.indexOf(t)<0&&r.push(t)})}for(const n of e.project){const r=n.channel;if(r!==It&&r!==Tt){mn("Interval selections only support x and y encoding channels.");continue}const i=_u(t,e,r),u=Fu(e,r,"data"),l=Fu(e,r,"visual"),f=c(t.scaleName(r)),d=Ki(t.getScaleComponent(r).get("type"))?"+":"";s.push(...i),o.push(u),a.push({scaleName:t.scaleName(r),expr:`(!isArray(${u}) || `+`(${d}invert(${f}, ${l})[0] === ${d}${u}[0] && `+`${d}invert(${f}, ${l})[1] === ${d}${u}[1]))`})}return i||s.push({name:n+Eu,update:a.map(t=>t.expr).join(" && ")+` ? ${n+Eu} : {}`}),s.concat({name:n+Yu,on:[{events:o.map(t=>({signal:t})),update:o.join(" && ")+` ? {unit: ${Zu(t)}, fields: ${r}, `+`values: [${o.join(", ")}]} : null`}]})},modifyExpr:(t,e)=>{return e.name+Yu+", "+("global"===e.resolve?"true":`{unit: ${Zu(t)}}`)},marks:(t,e,n)=>{const r=e.name,{xi:i,yi:s}=tl(e),o=`data(${c(e.name+$u)})`;if(Ou.has(e))return n;const a={x:null!==i?{signal:`${r}_x[0]`}:{value:0},y:null!==s?{signal:`${r}_y[0]`}:{value:0},x2:null!==i?{signal:`${r}_x[1]`}:{field:{group:"width"}},y2:null!==s?{signal:`${r}_y[1]`}:{field:{group:"height"}}};if("global"===e.resolve)for(const e of K(a))a[e]=[Object.assign({test:`${o}.length && ${o}[0].unit === ${Zu(t)}`},a[e]),{value:0}];const u=e.mark,{fill:l,fillOpacity:f}=u,d=Lt(u,["fill","fillOpacity"]),p=K(d).reduce((t,e)=>(t[e]=[{test:[null!==i&&`${r}_x[0] !== ${r}_x[1]`,null!=s&&`${r}_y[0] !== ${r}_y[1]`].filter(t=>t).join(" && "),value:d[e]},{value:null}],t),{});return[{name:r+"_brush_bg",type:"rect",clip:!0,encode:{enter:{fill:{value:l},fillOpacity:{value:f}},update:a}}].concat(n,{name:r+"_brush",type:"rect",clip:!0,encode:{enter:{fill:{value:"transparent"}},update:Object.assign({},a,p)}})}};function _u(t,e,n){const r=Fu(e,n,"visual"),i=Fu(e,n,"data"),s=Ou.has(e),o=c(t.scaleName(n)),a=t.getScaleComponent(n),u=a?a.get("type"):void 0,l=t.getSizeSignalRef(n===It?"width":"height").signal,f=`${n}(unit)`,d=Au(e,(t,e)=>t.concat({events:e.between[0],update:`[${f}, ${f}]`},{events:e,update:`[${r}[0], clamp(${f}, 0, ${l})]`}));return d.push({events:{signal:e.name+Eu},update:Ki(u)&&!Qi(u)?`[scale(${o}, ${i}[0]), scale(${o}, ${i}[1])]`:"[0, 0]"}),s?[{name:i,on:[]}]:[{name:r,value:[],on:d},{name:i,on:[{events:{signal:r},update:`${r}[0] === ${r}[1] ? null : invert(${o}, ${r})`}]}]}function Au(t,e){return t.events.reduce((t,n)=>n.between?e(t,n):(mn(`${n} is not an ordered event stream for interval selections`),t),[])}function wu(t,e){const n=e.name,r=n+Yu+yu,i=e.project,s="(item().isVoronoi ? datum.datum : datum)",o=i.map(e=>{const n=t.fieldDef(e.channel);return n&&n.bin?`[${nt(t.vgField(e.channel,{}),s)}, `+`${nt(t.vgField(e.channel,{binSuffix:"end"}),s)}]`:`${nt(e.field,s)}`}).join(", ");return[{name:n+Yu,value:{},on:[{events:e.events,update:"datum && item().mark.marktype !== 'group' ? "+`{unit: ${Zu(t)}, fields: ${r}, values: [${o}]} : null`,force:!0}]}]}const zu={signals:wu,modifyExpr:(t,e)=>{return e.name+Yu+", "+("global"===e.resolve?"null":`{unit: ${Zu(t)}}`)}},Lu={signals:wu,modifyExpr:(t,e)=>{return e.name+Yu+", "+("global"===e.resolve?"true":`{unit: ${Zu(t)}}`)}},Iu={has:t=>"interval"!==t.type&&t.nearest,marks:(t,e,n)=>{const{x:r,y:i}=tl(e),s=t.mark;if(Xe(s))return mn(hn.nearestNotSupportForContinuous(s)),n;const o={name:t.getName("voronoi"),type:"path",from:{data:t.getName("marks")},encode:{enter:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0}}},transform:[{type:"voronoi",x:{expr:r||!r&&!i?"datum.datum.x || 0":"0"},y:{expr:i||!r&&!i?"datum.datum.y || 0":"0"},size:[t.getSizeSignalRef("width"),t.getSizeSignalRef("height")]}]};let a=0,c=!1;return n.forEach((e,n)=>{const r=e.name||"";r===t.component.mark[0].name?a=n:r.indexOf("voronoi")>=0&&(c=!0)}),c||n.splice(a+1,0,o),n}},Tu="_translate_anchor",Ru="_translate_delta",Uu={has:t=>"interval"===t.type&&t.translate,signals:(t,e,n)=>{const r=e.name,i=Ou.has(e),s=r+Tu,{x:o,y:a}=tl(e);let c=nu(e.translate,"scope");return i||(c=c.map(t=>(t.between[0].markname=r+"_brush",t))),n.push({name:s,value:{},on:[{events:c.map(t=>t.between[0]),update:"{x: x(unit), y: y(unit)"+(null!==o?", extent_x: "+(i?ku(t,It):`slice(${Fu(e,"x","visual")})`):"")+(null!==a?", extent_y: "+(i?ku(t,Tt):`slice(${Fu(e,"y","visual")})`):"")+"}"}]},{name:r+Ru,value:{},on:[{events:c,update:`{x: ${s}.x - x(unit), y: ${s}.y - y(unit)}`}]}),null!==o&&Mu(t,e,It,"width",n),null!==a&&Mu(t,e,Tt,"height",n),n}};function Mu(t,e,n,r,i){const s=e.name,o=Ou.has(e),a=i.filter(t=>t.name===Fu(e,n,o?"data":"visual"))[0],c=s+Tu,u=s+Ru,l=t.getSizeSignalRef(r).signal,f=t.getScaleComponent(n),d=f.get("type"),p=`${c}.extent_${n}`,m=`${o?"log"===d?"panLog":"pow"===d?"panPow":"panLinear":"panLinear"}(${p}, ${`${o&&n===It?"-":""}${u}.${n} / `+(o?`${l}`:`span(${p})`)}`+(o&&"pow"===d?`, ${f.get("exponent")||1}`:"")+")";a.on.push({events:{signal:u},update:o?m:`clampRange(${m}, 0, ${l})`})}const Nu="_zoom_anchor",Pu="_zoom_delta",Cu={has:t=>"interval"===t.type&&t.zoom,signals:(t,e,n)=>{const r=e.name,i=Ou.has(e),s=r+Pu,{x:o,y:a}=tl(e),u=c(t.scaleName(It)),l=c(t.scaleName(Tt));let f=nu(e.zoom,"scope");return i||(f=f.map(t=>(t.markname=r+"_brush",t))),n.push({name:r+Nu,on:[{events:f,update:i?"{"+[u?`x: invert(${u}, x(unit))`:"",l?`y: invert(${l}, y(unit))`:""].filter(t=>!!t).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:s,on:[{events:f,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),null!==o&&Hu(t,e,"x","width",n),null!==a&&Hu(t,e,"y","height",n),n}};function Hu(t,e,n,r,i){const s=e.name,o=Ou.has(e),a=i.filter(t=>t.name===Fu(e,n,o?"data":"visual"))[0],c=t.getSizeSignalRef(r).signal,u=t.getScaleComponent(n),l=u.get("type"),f=o?ku(t,n):a.name,d=s+Pu,p=`${o?"log"===l?"zoomLog":"pow"===l?"zoomPow":"zoomLinear":"zoomLinear"}(${f}, ${`${s}${Nu}.${n}`}, ${d}`+(o&&"pow"===l?`, ${u.get("exponent")||1}`:"")+")";a.on.push({events:{signal:d},update:o?p:`clampRange(${p}, 0, ${c})`})}const qu={project:Su,toggle:{has:t=>"multi"===t.type&&t.toggle,signals:(t,e,n)=>n.concat({name:e.name+"_toggle",value:!1,on:[{events:e.events,update:e.toggle}]}),modifyExpr:(t,e,n)=>{const r=e.name+Yu,i=e.name+"_toggle";return`${i} ? null : ${r}, `+("global"===e.resolve?`${i} ? null : true, `:`${i} ? null : {unit: ${Zu(t)}}, `)+`${i} ? ${r} : null`}},scales:Ou,translate:Uu,zoom:Cu,inputs:{has:t=>"single"===t.type&&"global"===t.resolve&&t.bind&&"scales"!==t.bind,topLevelSignals:(t,e,n)=>{const r=e.name,i=e.project,s=e.bind,o=Iu.has(e)?"(item().isVoronoi ? datum.datum : datum)":"datum";for(const t of i){const i=D(`${r}_${t.field}`);n.filter(t=>t.name===i).length||n.unshift({name:i,value:"",on:[{events:e.events,update:`datum && item().mark.marktype !== 'group' ? ${nt(t.field,o)} : null`}],bind:s[t.field]||s[t.channel]||s})}return n},signals:(t,e,n)=>{const r=e.name,i=e.project,s=n.filter(t=>t.name===r+Yu)[0],o=r+Yu+yu,a=i.map(t=>D(`${r}_${t.field}`)),c=a.map(t=>`${t} !== null`).join(" && ");return a.length&&(s.update=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`),delete s.value,delete s.on,n}},nearest:Iu};function Wu(t,e){for(const n in qu)qu[n].has(t)&&e(qu[n])}const $u="_store",Yu="_tuple",Gu="_modify",Bu="_selection_domain_",Vu="vlSelectionResolve";function Qu(t,e){return Ju(t,(n,r)=>{e=r.marks?r.marks(t,n,e):e,Wu(n,r=>{r.marks&&(e=r.marks(t,n,e))})}),e}function Ku(t,e,n){const r=[];const i=F(e,function(e){const i=D(e),s=t.getSelectionComponent(i,e),o=c(i+$u);if(s.timeUnit){const e=n||t.component.data.raw,r=s.timeUnit.clone();e.parent?r.insertAsParentOf(e):e.parent=r}return"none"!==s.empty&&r.push(o),`vlSelectionTest(${o}, datum`+("global"===s.resolve?")":`, ${c(s.resolve)})`)});return(r.length?"!("+r.map(t=>`length(data(${t}))`).join(" || ")+") || ":"")+`(${i})`}function Ju(t,e){const n=t.component.selection;for(const t in n)if(n.hasOwnProperty(t)){const r=n[t];e(r,Xu(r.type))}}function Xu(t){switch(t){case"single":return Lu;case"multi":return zu;case"interval":return ju}return null}function Zu(t){let e=c(t.name);const n=function(t){let e=t.parent;for(;e&&!Ff(e);)e=e.parent;return e}(t);return n&&(e+=(n.facet.row?` + '_' + (${nt(n.vgField("row"),"facet")})`:"")+(n.facet.column?` + '_' + (${nt(n.vgField("column"),"facet")})`:"")),e}function Du(t){let e=!1;return Ju(t,t=>{e=e||t.project.some(t=>t.field===ls)}),e}function Fu(t,e,n){const r=t._signalNames||(t._signalNames={});if(r[e]&&r[e][n])return r[e][n];r[e]=r[e]||{};const i=D(t.name+"_"+("visual"===n?e:t.fields[e]));let s=i,o=1;for(;r[s];)s=`${i}_${o++}`;return r[s]=r[e][n]=s}function tl(t){let e=null,n=null,r=null,i=null;return t.project.forEach((t,s)=>{t.channel===It?(e=t,n=s):t.channel===Tt&&(r=t,i=s)}),{x:e,xi:n,y:r,yi:i}}function el(t,e,n){return F(e,e=>a(e)?e:function(t){return t&&t.selection}(e)?Ku(t,e.selection,n):po(e))}function nl(t,e){const n=e[t+"Offset"];if(n)return n}function rl(t,e,n,r){return il(t,e,{binSuffix:"start"===n?void 0:"end"},r?{offset:r}:{})}function il(t,e,n,r){const i=Object.assign({},e?{scale:e}:{},{field:gr(t,n)});return r?Object.assign({},i,r):i}function sl(t,e=!0){return{scale:t,band:e}}function ol(t,e,n){return{signal:`scale("${t}", (${gr(e,{expr:"datum"})} + ${void 0!==n?gr(n,{expr:"datum"}):gr(e,{binSuffix:"end",expr:"datum"})}) / 2)`}}function al(t,e,n,r,i,s,o){if(e){if(cr(e)){if(ur(e)){if(Ie(e.bin))return N([It,Tt],t)&&e.type===Kn?s&&s.impute?il(e,r,{binSuffix:"mid"}):ol(r,e):il(e,r,$r(e,t)?{binSuffix:"range"}:{});if(Te(e.bin)){if(cr(n))return ol(r,e,n);{const e=t===It?Rt:Ut;mn(hn.channelRequiredForBinned(e))}}}if(i){const t=i.get("type");if(Vi(t))return"band"===t?il(e,r,{binSuffix:"range"},{band:.5}):il(e,r,{binSuffix:"range"})}return il(e,r,{})}if(fr(e)){const n=e.value;return N(["x","x2"],t)&&"width"===n?{field:{group:"width"}}:N(["y","y2"],t)&&"height"===n?{field:{group:"height"}}:{value:n}}}return"function"==typeof o?o():o}function cl(t,e){const n=[],r={};function i(i,s){const o=he(s);s!==o&&(i=Object.assign({},i,{type:t[o].type}));const a=_r(i,e,{allowDisabling:!1}),u=ul(i,e).signal;r[a]||n.push(`${c(a)}: ${u}`),r[a]=!0}return Xr(t,(t,e)=>{cr(t)?i(t,e):or(t)&&i(t.condition,e)}),n.length?{signal:`{${n.join(", ")}}`}:void 0}function ul(t,e){if(t){if(fr(t))return{value:t.value};if(ur(t))return Yo(t,zr(t),"datum",e)}}function ll(t){return Object.assign({},t,{mult:.5})}function fl(t,e,n,r,i){return()=>{if(a(t)){if(n){const t=r.get("type");if(N([Li.LOG,Li.TIME,Li.UTC],t))"bar"!==i&&"area"!==i||mn(hn.nonZeroScaleUsedWithLengthMark(i,e,{scaleType:t}));else{if(function(t){if(!1!==t.get("zero"))return!0;const e=t.domains;return!!s(e)&&C(e,t=>s(t)&&2===t.length&&t[0]<=0&&t[1]>=0)}(r))return{scale:n,value:0};"bar"!==i&&"area"!==i||mn(hn.nonZeroScaleUsedWithLengthMark(i,e,{zeroFalse:!1===r.explicit.zero}))}}return"zeroOrMin"===t?"x"===e?{value:0}:{field:{group:"height"}}:"x"===e?{field:{group:"width"}}:{value:0}}return t}}function dl(t){return"transparent"!==t&&null!=t}function pl(t){const{markDef:e,encoding:n,config:r}=t,{filled:i,type:s}=e,o={fill:Wo("fill",e,r),stroke:Wo("stroke",e,r),color:Wo("color",e,r)},a=N(["bar","point","circle","square","geoshape"],s)?"transparent":void 0,c=at(e.fill,o.fill,a),u=at(e.stroke,o.stroke),l=i?"fill":"stroke",f=Object.assign({},c?{fill:{value:c}}:{},u?{stroke:{value:u}}:{});return n.fill||n.stroke?(e.color&&mn(hn.droppingColor("property",{fill:"fill"in n,stroke:"stroke"in n})),Object.assign({},vl("fill",t,{defaultValue:at(c,a)}),vl("stroke",t,{defaultValue:u}))):n.color?Object.assign({},f,vl("color",t,{vgChannel:l,defaultValue:at(e[l],e.color,o[l],o.color,i?a:void 0)})):dl(e.fill)||dl(e.stroke)?(e.color&&mn(hn.droppingColor("property",{fill:"fill"in e,stroke:"stroke"in e})),f):e.color?Object.assign({},f,{[l]:{value:e.color}}):dl(o.fill)||dl(o.stroke)?f:o.color?Object.assign({},a?{fill:{value:"transparent"}}:{},{[l]:{value:o.color}}):{}}function ml(t,e){const{fill:n,stroke:r}=pl(t);return Object.assign({},function(t,e){return Co.reduce((n,r)=>(void 0!==t[r]&&"ignore"!==e[r]&&(n[r]={value:t[r]}),n),{})}(t.markDef,e),hl(t,"fill",n),hl(t,"stroke",r),vl("opacity",t),vl("fillOpacity",t),vl("strokeOpacity",t),vl("strokeWidth",t),function(t){const{encoding:e,markDef:n,config:r}=t,i=e.tooltip;return s(i)?{tooltip:cl({tooltip:i},r)}:xl(t,i,"tooltip",i=>{const s=ul(i,t.config);if(s)return s;if(null===i)return;const c=at(n.tooltip,Wo("tooltip",n,r));return a(c)?{value:c}:o(c)?"encoding"===c.content?cl(e,r):{signal:"datum"}:void 0})}(t),yl(t,"href"))}function hl(t,e,n){const{config:r,mark:i}=t;if(r.invalidValues&&n&&!Xe(i)){const r=gl(t,{invalid:!0,channels:je});if(r)return{[e]:[{test:r,value:null},...(o=n,null!=o?s(o)?o:[o]:[])]}}var o;return n?{[e]:n}:{}}function gl(t,{invalid:e=!1,channels:n}){const r=n.reduce((e,n)=>{const r=t.getScaleComponent(n);if(r){const i=r.get("type"),s=t.vgField(n,{expr:"datum"});s&&Ki(i)&&(e[s]=!0)}return e},{}),i=K(r);if(i.length>0){const t=e?"||":"&&";return i.map(n=>{return`${n} ${e?"===":"!=="} null ${t} ${e?"":"!"}isNaN(${n})`}).join(` ${t} `)}}function bl(t){if("filter"===t.config.invalidValues){const e=gl(t,{channels:["x","y"]});if(e)return{defined:{signal:e}}}return{}}function vl(t,e,n={}){const{markDef:r,encoding:i}=e,{vgChannel:s=t}=n,{defaultValue:o=r[s]}=n,a=n.defaultRef||(void 0!==o?{value:o}:void 0),c=i[t];return xl(e,c,s,n=>al(t,n,void 0,e.scaleName(t),e.getScaleComponent(t),null,a))}function xl(t,e,n,r){const i=e&&e.condition,o=r(e);if(i){return{[n]:[...(s(i)?i:[i]).map(e=>{const n=r(e),i=er(e)?Ku(t,e.selection):el(t,e.test);return Object.assign({test:i},n)}),...void 0!==o?[o]:[]]}}return void 0!==o?{[n]:o}:{}}function yl(t,e="text"){const n=t.encoding[e];return xl(t,n,e,e=>ul(e,t.config))}function Sl(t,e,n){const r=n.scaleName(e),i="x"===e?"width":"height";if(n.encoding.size||void 0!==n.markDef.size){if(n.markDef.orient){const s={[e+"c"]:il(t,r,{},{band:.5})};if(Tr(n.encoding.size))return Object.assign({},s,vl("size",n,{vgChannel:i}));if(fr(n.encoding.size))return Object.assign({},s,vl("size",n,{vgChannel:i}));if(void 0!==n.markDef.size)return Object.assign({},s,{[i]:{value:n.markDef.size}})}else mn(hn.cannotApplySizeToNonOrientedMark(n.markDef.type))}return{[e]:il(t,r,{binSuffix:"range"}),[i]:sl(r)}}function Ol(t,e,n,r){const i="x"===t?"xc":"yc",s="x"===t?"width":"height";return Object.assign({},El(t,e,n,i),vl("size",e,{defaultRef:r,vgChannel:s}))}function kl(t,e,n,r,i,s){const o={x:s?i:0,x2:s?0:i,y:s?0:i,y2:s?i:0},a=n===It?Rt:Ut;return Ie(t.bin)?{[a]:rl(t,r,"start",o[`${n}2`]),[n]:rl(t,r,"end",o[n])}:Te(t.bin)&&cr(e)?{[a]:il(t,r,{},{offset:o[`${n}2`]}),[n]:il(e,r,{},{offset:o[n]})}:void mn(hn.channelRequiredForBinned(a))}function El(t,e,n,r){const{encoding:i,mark:s,stack:o}=e,a=i[t],c=i[t===It?Rt:Ut],u=e.scaleName(t),l=e.getScaleComponent(t),f=nl(t,e.markDef);return{[r||t]:a||!i.latitude&&!i.longitude?Object.assign({},function(t,e,n,r,i,s,o){return cr(e)&&s&&t===s.fieldChannel?il(e,r,{suffix:"end"}):al(t,e,n,r,i,s,o)}(t,a,c,u,l,o,fl(n,t,u,l,s)),f?{offset:f}:{}):{field:e.getName(t)}}}function jl(t,e,n){const{encoding:r,mark:i,stack:s}=t,o="x2"===n?"x":"y",a=r[o],c=t.scaleName(o),u=t.getScaleComponent(o),l=nl(n,t.markDef),f=a||!r.latitude&&!r.longitude?Object.assign({},function(t,e,n,r,i,s,o){return cr(e)&&s&&t.charAt(0)===s.fieldChannel.charAt(0)?il(e,r,{suffix:"start"}):al(t,n,void 0,r,i,s,o)}(n,a,r[n],c,u,s,fl(e,o,c,u,i)),l?{offset:l}:{}):{field:t.getName(n)};return{[n]:f}}function _l(t,e){return K(t).reduce((n,r)=>{const i=t[r];return Object.assign({},n,xl(e,i,r,t=>({value:t.value})))},{})}function Al(t,e){if(nd(e)||Ff(e))return"shared";if(ed(e)||td(e))return N(ye,t)?"independent":"shared";throw new Error("invalid model type for resolve")}function wl(t,e){const n=t.scale[e],r=N(ye,e)?"axis":"legend";return"independent"===n?("shared"===t[r][e]&&mn(hn.independentScaleMeansIndependentGuide(e)),"independent"):t[r][e]||"shared"}class zl{constructor(t={},e={}){this.explicit=t,this.implicit=e}clone(){return new zl(L(this.explicit),L(this.implicit))}combine(){return Object.assign({},this.explicit,this.implicit)}get(t){return at(this.explicit[t],this.implicit[t])}getWithExplicit(t){return void 0!==this.explicit[t]?{explicit:!0,value:this.explicit[t]}:void 0!==this.implicit[t]?{explicit:!1,value:this.implicit[t]}:{explicit:!1,value:void 0}}setWithExplicit(t,e){void 0!==e.value&&this.set(t,e.value,e.explicit)}set(t,e,n){return delete this[n?"implicit":"explicit"][t],this[n?"explicit":"implicit"][t]=e,this}copyKeyFromSplit(t,e){void 0!==e.explicit[t]?this.set(t,e.explicit[t],!0):void 0!==e.implicit[t]&&this.set(t,e.implicit[t],!1)}copyKeyFromObject(t,e){void 0!==e[t]&&this.set(t,e[t],!0)}copyAll(t){for(const e of K(t.combine())){const n=t.getWithExplicit(e);this.setWithExplicit(e,n)}}}function Ll(t){return{explicit:!0,value:t}}function Il(t){return{explicit:!1,value:t}}function Tl(t){return(e,n,r,i)=>{const s=t(e.value,n.value);return s>0?e:s<0?n:Rl(e,n,r,i)}}function Rl(t,e,n,r){return t.explicit&&e.explicit&&mn(hn.mergeConflictingProperty(n,r,t.value,e.value)),t}function Ul(t,e,n,r,i=Rl){return void 0===t||void 0===t.value?e:t.explicit&&!e.explicit?t:e.explicit&&!t.explicit?e:U(t.value)===U(e.value)?t:i(t,e,n,r)}class Ml extends zl{}function Nl(t){const{legend:e}=t;return at(e.type,Pl(t))}function Pl({channel:t,timeUnit:e,scaleType:n,alwaysReturn:r}){if(ue(t)){if(N(["quarter","month","day"],e))return"symbol";if(Ji(n))return r?"gradient":void 0}return r?"symbol":void 0}function Cl({legend:t,legendConfig:e,timeUnit:n,channel:r,scaleType:i}){const s=at(t.orient,e.orient,"right"),o=Nl({legend:t,channel:r,timeUnit:n,scaleType:i,alwaysReturn:!0});return at(t.direction,e[o?"gradientDirection":"symbolDirection"],function(t,e){switch(t){case"top":case"bottom":return"horizontal";case"left":case"right":case"none":case void 0:return;default:return"gradient"===e?"horizontal":void 0}}(s,o))}function Hl(t,e,n,r){return{signal:`clamp(${t.getSizeSignalRef(e).signal}, ${n}, ${r})`}}function ql(t,e,n){const r=e.getScaleComponent(n).get("type");return at(t.get("type"),Pl({channel:n,scaleType:r,alwaysReturn:!0}))}function Wl(t){return Yl(t,(t,e)=>Math.max(t,e.value))}function $l(t){return Yl(t,(t,e)=>at(t,e.value))}function Yl(t,e){return ar(t)?(s(t.condition)?t.condition:[t.condition]).reduce(e,t.value):fr(t)?t.value:void 0}var Gl=Object.freeze({symbols:function(t,e,n,r,i){if("symbol"!==ql(i,n,r))return;let o=Object.assign({},function(t,e,n){for(const r of n){const n=Wo(r,e.markDef,e.config);void 0!==n&&(t[r]={value:n})}return t}({},n,rn),pl(n));switch(n.mark){case Ce:case $e:case We:o.shape={value:"square"};break;case Qe:case Ke:o.shape={value:n.mark}}const{markDef:a,encoding:c}=n,u=a.filled,l=Wl(c.opacity)||a.opacity;if(o.fill)if("fill"===r||u&&r===Qt)delete o.fill;else if(o.fill.field)i.get("symbolFillColor")?delete o.fill:(o.fill={value:"black"},o.fillOpacity={value:l||1});else if(s(o.fill)){const t=$l(c.fill||c.color)||a.fill||u&&a.color;t&&(o.fill={value:t})}if(o.stroke)if("stroke"===r||!u&&r===Qt)delete o.stroke;else if(o.stroke.field)delete o.stroke;else if(s(o.stroke)){const t=at($l(c.stroke||c.color),a.stroke,u?a.color:void 0);t&&(o.stroke={value:t})}if(r!==Bt){const t=$l(c.shape)||a.shape;t&&(o.shape={value:t})}return r!==te&&l&&(o.opacity={value:l}),o=Object.assign({},o,e),K(o).length>0?o:void 0},gradient:function(t,e,n,r,i){if("gradient"!==ql(i,n,r))return;let s={};const o=Wl(n.encoding.opacity)||n.markDef.opacity;return o&&(s.opacity={value:o}),s=Object.assign({},s,e),K(s).length>0?s:void 0},labels:function(t,e,n,r,i){const s=n.legend(r),o=n.config;let a={};if(Hr(t)){const i=n.getScaleComponent(r).get("type")===Li.UTC,a=Ko("datum.value",t.timeUnit,s.format,o.legend.shortTimeLabels,o.timeFormat,i);e=Object.assign({},a?{text:{signal:a}}:{},e)}return a=Object.assign({},a,e),K(a).length>0?a:void 0}});function Bl(t){Df(t)?t.component.legends=function(t){const{encoding:e}=t;return[Qt,Kt,Jt,re,Vt,Bt,te,ee,ne].reduce((n,r)=>{const i=e[r];return!t.legend(r)||!t.getScaleComponent(r)||cr(i)&&r===Bt&&i.type===Dn||(n[r]=function(t,e){const n=t.fieldDef(e),r=t.legend(e),i=new Ml({},function(t,e){switch(e){case Qt:const n=t.scaleName(Qt);return t.markDef.filled?{fill:n}:{stroke:n};case Kt:case Jt:case re:case Vt:case Bt:case te:case ee:case ne:return{[e]:t.scaleName(e)}}}(t,e));for(const s of wi){const o=Ql(s,r,e,t);if(void 0!==o){const e=Vl(o,s,r,n);(e||void 0===t.config.legend[s])&&i.set(s,o,e)}}const s=r.encoding||{},o=["labels","legend","title","symbols","gradient"].reduce((r,o)=>{const a=_l(s[o]||{},t),c=Gl[o]?Gl[o](n,a,t,e,i):a;return void 0!==c&&K(c).length>0&&(r[o]={update:c}),r},{});K(o).length>0&&i.set("encode",o,!!r.encoding);return i}(t,r)),n},{})}(t):t.component.legends=function(t){const{legends:e,resolve:n}=t.component;for(const r of t.children)Bl(r),K(r.component.legends).forEach(i=>{n.legend[i]=wl(t.component.resolve,i),"shared"===n.legend[i]&&(e[i]=Kl(e[i],r.component.legends[i]),e[i]||(n.legend[i]="independent",delete e[i]))});return K(e).forEach(e=>{for(const r of t.children)r.component.legends[e]&&"shared"===n.legend[e]&&delete r.component.legends[e]}),e}(t)}function Vl(t,e,n,r){switch(e){case"values":return!!n.values;case"title":if("title"===e&&t===r.title)return!0}return t===n[e]}function Ql(t,e,n,r){const{encoding:i}=r,s=Tr(i[n]),o=r.config.legend,{timeUnit:a}=s,c=r.getScaleComponent(n).get("type");switch(t){case"format":return Go(s,e.format,r.config);case"title":return _r(s,r.config,{allowDisabling:!0})||void 0;case"type":return Nl({legend:e,channel:n,timeUnit:a,scaleType:c,alwaysReturn:!1});case"direction":return Cl({legend:e,legendConfig:o,timeUnit:a,channel:n,scaleType:c});case"labelOverlap":return at(e.labelOverlap,function(t){if(N(["quantile","threshold","log"],t))return"greedy"}(c));case"gradientLength":return at(e.gradientLength,o.gradientLength,function({legend:t,legendConfig:e,model:n,channel:r,scaleType:i}){const{gradientHorizontalMaxLength:s,gradientHorizontalMinLength:o,gradientVerticalMaxLength:a,gradientVerticalMinLength:c}=e;if("horizontal"===Cl({legend:t,legendConfig:e,channel:r,scaleType:i})){const r=at(t.orient,e.orient);return"top"===r||"bottom"===r?Hl(n,"width",o,s):o}return Hl(n,"height",c,a)}({model:r,legend:e,legendConfig:o,channel:n,scaleType:c}));case"values":return function(t,e){const n=t.values;if(n)return Wr(e,n)}(e,s)}return e[t]}function Kl(t,e){if(!t)return e.clone();const n=t.getWithExplicit("orient"),r=e.getWithExplicit("orient");if(n.explicit&&r.explicit&&n.value!==r.value)return;let i=!1;for(const n of zi){const r=Ul(t.getWithExplicit(n),e.getWithExplicit(n),n,"legend",(t,e)=>{switch(n){case"title":return Do(t,e);case"type":return i=!0,Il("symbol")}return Rl(t,e,n,"legend")});t.setWithExplicit(n,r)}return i&&(((t.implicit||{}).encode||{}).gradient&&tt(t.implicit,["encode","gradient"]),((t.explicit||{}).encode||{}).gradient&&tt(t.explicit,["encode","gradient"])),t}function Jl(t){const e=t.component.legends,n={};for(const r of K(e)){const i=t.getScaleComponent(r),s=U(i.domains);if(n[s])for(const t of n[s]){Kl(t,e[r])||n[s].push(e[r])}else n[s]=[e[r].clone()]}return q(J(n)).map(t=>{const e=t.combine();if(e.encode&&e.encode.symbols){const t=e.encode.symbols.update;!t.fill||"transparent"===t.fill.value||t.stroke||e.stroke||(t.stroke={value:"transparent"})}return e})}function Xl(t){return nd(t)||ed(t)||td(t)?function(t){return t.children.reduce((t,e)=>t.concat(e.assembleProjections()),Zl(t))}(t):Zl(t)}function Zl(t){const e=t.component.projection;if(!e||e.merged)return[];const n=e.combine(),{name:r}=n,i=Lt(n,["name"]),s={signal:`[${e.size.map(t=>t.signal).join(", ")}]`},o=e.data.reduce((e,n)=>{const r=function(t){return!!t.signal}(n)?n.signal:`data('${t.lookupDataSource(n)}')`;return N(e,r)||e.push(r),e},[]);if(o.length<=0)throw new Error("Projection's fit didn't find any data sources");return[Object.assign({name:r,size:s,fit:{signal:o.length>1?`[${o.join(", ")}]`:o[0]}},i)]}const Dl=["type","clipAngle","clipExtent","center","rotate","precision","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];class Fl extends zl{constructor(t,e,n,r){super(Object.assign({},e),{name:t}),this.specifiedProjection=e,this.size=n,this.data=r,this.merged=!1}}function tf(t){Df(t)?t.component.projection=function(t){const{specifiedProjection:e,config:n,hasProjection:r}=t;if(r){const r=[];return[[Wt,Ht],[$t,qt]].forEach(e=>{(t.channelHasField(e[0])||t.channelHasField(e[1]))&&r.push({signal:t.getName(`geojson_${r.length}`)})}),t.channelHasField(Bt)&&t.fieldDef(Bt).type===Dn&&r.push({signal:t.getName(`geojson_${r.length}`)}),0===r.length&&r.push(t.requestDataName(js)),new Fl(t.projectionName(!0),Object.assign({},n.projection||{},e||{}),[t.getSizeSignalRef("width"),t.getSizeSignalRef("height")],r)}return}(t):t.component.projection=function(t){if(0===t.children.length)return;let e;const n=H(t.children,t=>{tf(t);const n=t.component.projection;if(n){if(e){const t=function(t,e){const n=H(Dl,n=>!t.explicit.hasOwnProperty(n)&&!e.explicit.hasOwnProperty(n)||!(!t.explicit.hasOwnProperty(n)||!e.explicit.hasOwnProperty(n)||U(t.get(n))!==U(e.get(n))));if(U(t.size)===U(e.size)){if(n)return t;if(U(t.explicit)===U({}))return e;if(U(e.explicit)===U({}))return t}return null}(e,n);return t&&(e=t),!!t}return e=n,!0}return!0});if(e&&n){const n=t.projectionName(!0),r=new Fl(n,e.specifiedProjection,e.size,L(e.data));return t.children.forEach(t=>{t.component.projection&&(r.data=r.data.concat(t.component.projection.data),t.renameProjection(t.component.projection.get("name"),n),t.component.projection.merged=!0)}),r}return}(t)}class ef{constructor(t,e){this.expr=t,this.signalNames=e}static fromName(t){return new ef(t,[t])}map(t){return new ef(t(this.expr),this.signalNames)}}const nf=function(t){var e=(t=t||{}).whitelist?qc(t.whitelist):{},n=t.blacklist?qc(t.blacklist):{},r=t.constants||Tc,i=(t.functions||Wc)(f),s=t.globalvar,o=t.fieldvar,a={},c={},u=0,l=Hc(s)?s:function(t){return s+'["'+t+'"]'};function f(t){if(Nc(t))return t;var e=d[t.type];return null==e&&Uc("Unsupported type: "+t.type),e(t)}var d={Literal:function(t){return t.raw},Identifier:function(t){var i=t.name;return u>0?i:n.hasOwnProperty(i)?Uc("Illegal identifier: "+i):r.hasOwnProperty(i)?r[i]:e.hasOwnProperty(i)?i:(a[i]=1,l(i))},MemberExpression:function(t){var e=!t.computed,n=f(t.object);e&&(u+=1);var r=f(t.property);return n===o&&(c[r]=1),e&&(u-=1),n+(e?"."+r:"["+r+"]")},CallExpression:function(t){"Identifier"!==t.callee.type&&Uc("Illegal callee type: "+t.callee.type);var e=t.callee.name,n=t.arguments,r=i.hasOwnProperty(e)&&i[e];return r||Uc("Unrecognized function: "+e),Hc(r)?r(n):r+"("+n.map(f).join(",")+")"},ArrayExpression:function(t){return"["+t.elements.map(f).join(",")+"]"},BinaryExpression:function(t){return"("+f(t.left)+t.operator+f(t.right)+")"},UnaryExpression:function(t){return"("+t.operator+f(t.argument)+")"},ConditionalExpression:function(t){return"("+f(t.test)+"?"+f(t.consequent)+":"+f(t.alternate)+")"},LogicalExpression:function(t){return"("+f(t.left)+t.operator+f(t.right)+")"},ObjectExpression:function(t){return"{"+t.properties.map(f).join(",")+"}"},Property:function(t){u+=1;var e=f(t.key);return u-=1,e+":"+f(t.value)}};function p(t){var e={code:f(t),globals:Object.keys(a),fields:Object.keys(c)};return a={},c={},e}return p.functions=i,p.constants=r,p}({globalvar:"global"});function rf(t,e){const n=K(e),r=[];for(const i of n){const n=e[i];if(n instanceof ef){for(const t of n.signalNames)r.push(t);t=t.replace(I(i),n.expr)}else t=t.replace(I(i),c(n))}if(r.length>0)return new ef(t,r);try{const n=Ic(t),{code:r}=nf(n);return new Function("global",`return ${r};`)(e)}catch(e){if(0===e.message.indexOf("Unrecognized function"))return new ef(t,[]);throw e}}function sf(t){for(const e of t){for(const t of e.children)if(t.parent!==e)return console.error("Dataflow graph is inconsistent.",parent,t),!1;if(!sf(e.children))return!1}return!0}class of extends Fo{constructor(t){super(null);const e=(t=t||{name:"source"}).format?Object.assign({},R(t.format,["parse"])):{};if(ks(t))this._data={values:t.values};else if(Os(t)){if(this._data={url:t.url},!e.type){let n=/(?:\.([^.]+))?$/.exec(t.url)[1];N(["json","csv","tsv","dsv","topojson"],n)||(n="json"),e.type=n}}else Es(t)&&(this._data={});t.name&&(this._name=t.name),e&&K(e).length>0&&(this._data.format=e)}get data(){return this._data}hasName(){return!!this._name}get dataName(){return this._name}set dataName(t){this._name=t}set parent(t){throw new Error("Source nodes have to be roots.")}remove(){throw new Error("Source nodes are roots and cannot be removed.")}hash(){throw new Error("Cannot hash sources")}assemble(){return Object.assign({name:this._name},this._data,{transform:[]})}}class af{constructor(){this._mutated=!1}setMutated(){this._mutated=!0}get mutatedFlag(){return this._mutated}}class cf extends af{constructor(){super(),this._continue=!1}setContinue(){this._continue=!0}get continueFlag(){return this._continue}get flags(){return{continueFlag:this.continueFlag,mutatedFlag:this.mutatedFlag}}set flags({continueFlag:t,mutatedFlag:e}){t&&this.setContinue(),e&&this.setMutated()}optimizeNextFromLeaves(t){if(t instanceof of)return!1;const e=t.parent,{continueFlag:n}=this.run(t);return n&&this.optimizeNextFromLeaves(e),this.mutatedFlag}}class uf extends af{}class lf extends Fo{constructor(t,e,n){super(t),this.dimensions=e,this.measures=n}clone(){return new lf(null,new Set(this.dimensions),L(this.measures))}get groupBy(){return this.dimensions}static makeFromEncoding(t,e){let n=!1;e.forEachFieldDef(t=>{t.aggregate&&(n=!0)});const r={},i=new Set;return n?(e.forEachFieldDef((t,n)=>{const{aggregate:s,field:o}=t;s?"count"===s?(r["*"]=r["*"]||{},r["*"].count=new Set([gr(t,{forAs:!0})])):(r[o]=r[o]||{},r[o][s]=new Set([gr(t,{forAs:!0})]),_e(n)&&"unaggregated"===e.scaleDomain(n)&&(r[o].min=new Set([gr({field:o,aggregate:"min"},{forAs:!0})]),r[o].max=new Set([gr({field:o,aggregate:"max"},{forAs:!0})]))):function(t,e,n){ur(n)&&Ie(n.bin)?(t.add(gr(n,{})),t.add(gr(n,{binSuffix:"end"})),$r(n,e)&&t.add(gr(n,{binSuffix:"range"}))):t.add(gr(n))}(i,n,t)}),i.size+K(r).length===0?null:new lf(t,i,r)):null}static makeFromTransform(t,e){const n=new Set,r={};for(const t of e.aggregate){const{op:e,field:n,as:i}=t;e&&("count"===e?(r["*"]=r["*"]||{},r["*"].count=new Set([i||gr(t,{forAs:!0})])):(r[n]=r[n]||{},r[n][e]=new Set([i||gr(t,{forAs:!0})])))}for(const t of e.groupby||[])n.add(t);return n.size+K(r).length===0?null:new lf(t,n,r)}merge(t){return G(this.dimensions,t.dimensions)?(function(t,e){for(const n of K(e)){const r=e[n];for(const e of K(r))n in t?t[n][e]=new Set([...t[n][e]||[],...r[e]]):t[n]={[e]:r[e]}}}(this.measures,t.measures),!0):(function(...t){pn.debug.apply(pn,arguments)}("different dimensions, cannot merge"),!1)}addDimensions(t){t.forEach(this.dimensions.add,this.dimensions)}dependentFields(){return new Set([...this.dimensions,...K(this.measures)])}producedFields(){const t=new Set;for(const e of K(this.measures))for(const n of K(this.measures[e])){const r=this.measures[e][n];0===r.size?t.add(`${n}_${e}`):r.forEach(t.add,t)}return t}hash(){return`Aggregate ${M({dimensions:this.dimensions,measures:this.measures})}`}assemble(){const t=[],e=[],n=[];for(const r of K(this.measures))for(const i of K(this.measures[r]))for(const s of this.measures[r][i])n.push(s),t.push(i),e.push(it(r));return{type:"aggregate",groupby:[...this.dimensions],ops:t,fields:e,as:n}}}class ff extends Fo{constructor(t,e,n,r){super(t),this.model=e,this.name=n,this.data=r;for(const t of[Gt,Yt]){const n=e.facet[t];if(n){const{bin:r,sort:i}=n;this[t]=Object.assign({name:e.getName(`${t}_domain`),fields:[gr(n),...Ie(r)?[gr(n,{binSuffix:"end"})]:[]]},Rs(i)?{sortField:i}:s(i)?{sortIndexField:Gc(n,t)}:{})}}this.childModel=e.child}hash(){let t="Facet";return this.column&&(t+=` c:${M(this.column)}`),this.row&&(t+=` r:${M(this.row)}`),t}get fields(){return[...this.column&&this.column.fields||[],...this.row&&this.row.fields||[]]}getSource(){return this.name}getChildIndependentFieldsWithStep(){const t={};for(const e of["x","y"]){const n=this.childModel.component.scales[e];if(n&&!n.merged){const r=n.get("type"),i=n.get("range");if(Vi(r)&&No(i)){const n=Tf(Rf(this.childModel,e));n?t[e]=n:mn("Unknown field for ${channel}.  Cannot calculate view size.")}}}return t}assembleRowColumnData(t,e,n){const r="row"===t?"y":"x",i=[],s=[],o=[];n[r]&&(e?(i.push(`distinct_${n[r]}`),s.push("max")):(i.push(n[r]),s.push("distinct")),o.push(`distinct_${n[r]}`));const{sortField:a,sortIndexField:c}=this[t];if(a){const{op:t,field:e}=a;i.push(e),s.push(t),o.push(gr(a,{forAs:!0}))}else c&&(i.push(c),s.push("max"),o.push(c));return{name:this[t].name,source:e||this.data,transform:[Object.assign({type:"aggregate",groupby:this[t].fields},i.length?{fields:i,ops:s,as:o}:{})]}}assemble(){const t=[];let e=null;const n=this.getChildIndependentFieldsWithStep();if(this.column&&this.row&&(n.x||n.y)){e=`cross_${this.column.name}_${this.row.name}`;const r=[].concat(n.x?[n.x]:[],n.y?[n.y]:[]),i=r.map(()=>"distinct");t.push({name:e,source:this.data,transform:[{type:"aggregate",groupby:[...this.column.fields,...this.row.fields],fields:r,ops:i}]})}for(const r of[Gt,Yt])this[r]&&t.push(this.assembleRowColumnData(r,e,n));return t}}class df extends Fo{clone(){return new df(null,L(this._parse))}constructor(t,e){super(t),this._parse=e}hash(){return`Parse ${M(this._parse)}`}static makeExplicit(t,e,n){let r={};const i=e.data;return i&&i.format&&i.format.parse&&(r=i.format.parse),this.makeWithAncestors(t,r,{},n)}static makeImplicitFromFilterTransform(t,e,n){const r={};return function t(e,n){if(A(e))t(e.not,n);else if(_(e))for(const r of e.and)t(r,n);else if(j(e))for(const r of e.or)t(r,n);else n(e)}(e.filter,t=>{if(lo(t)){let e=null;ro(t)?e=t.equal:co(t)?e=t.range[0]:uo(t)&&(e=(t.oneOf||t.in)[0]),e&&(bn(e)?r[t.field]="date":b(e)?r[t.field]="number":a(e)&&(r[t.field]="string")),t.timeUnit&&(r[t.field]="date")}}),0===K(r).length?null:this.makeWithAncestors(t,{},r,n)}static makeImplicitFromEncoding(t,e,n){const r={};function i(t){Hr(t)?r[t.field]="date":Cr(t)&&gt(t.aggregate)?r[t.field]="number":ot(t.field)>1?t.field in r||(r[t.field]="flatten"):dr(t)&&Rs(t.sort)&&ot(t.sort.field)>1&&(t.sort.field in r||(r[t.sort.field]="flatten"))}return(Df(e)||Ff(e))&&e.forEachFieldDef((t,n)=>{if(ur(t))i(t);else{const r=he(n);if(r===n)throw new Error(`Non-secondary channel ${n} must have type in its field definition ${JSON.stringify(t)}`);{const n=e.fieldDef(r);i(Object.assign({},t,{type:n.type}))}}}),this.makeWithAncestors(t,{},r,n)}static makeWithAncestors(t,e,n,r){for(const t of K(n)){const e=r.getWithExplicit(t);void 0!==e.value&&(e.explicit||e.value===n[t]||"derived"===e.value||"flatten"===n[t]?delete n[t]:mn(hn.differentParse(t,n[t],e.value)))}for(const t of K(e)){const n=r.get(t);void 0!==n&&(n===e[t]?delete e[t]:mn(hn.differentParse(t,e[t],n)))}const i=new zl(e,n);r.copyAll(i);const s={};for(const t of K(i.combine())){const e=i.get(t);null!==e&&(s[t]=e)}return 0===K(s).length||r.parseNothing?null:new df(t,s)}get parse(){return this._parse}merge(t){this._parse=Object.assign({},this._parse,t.parse),t.remove()}assembleFormatParse(){const t={};for(const e of K(this._parse)){const n=this._parse[e];1===ot(e)&&(t[e]=n)}return t}producedFields(){return new Set(K(this._parse))}dependentFields(){return new Set(K(this._parse))}assembleTransforms(t=!1){return K(this._parse).filter(e=>!t||ot(e)>1).map(t=>{const e=function(t,e){const n=nt(t);if("number"===e)return`toNumber(${n})`;if("boolean"===e)return`toBoolean(${n})`;if("string"===e)return`toString(${n})`;if("date"===e)return`toDate(${n})`;if("flatten"===e)return n;if(0===e.indexOf("date:"))return`timeParse(${n},${e.slice(5,e.length)})`;if(0===e.indexOf("utc:"))return`utcParse(${n},${e.slice(4,e.length)})`;return mn(hn.unrecognizedParse(e)),null}(t,this._parse[t]);return e?{type:"formula",expr:e,as:st(t)}:null}).filter(t=>null!==t)}}class pf extends Fo{clone(){return new pf(null,L(this._stack))}constructor(t,e){super(t),this._stack=e}static makeFromTransform(t,e){const{stack:n,groupby:r,as:i,offset:o="zero"}=e,c=[],u=[];if(void 0!==e.sort)for(const t of e.sort)c.push(t.field),u.push(at(t.order,"ascending"));const l={field:c,order:u};let f;return f=function(t){return s(t)&&t.every(t=>a(t))&&t.length>1}(i)?i:a(i)?[i,i+"_end"]:[e.stack+"_start",e.stack+"_end"],new pf(t,{stackField:n,groupby:r,offset:o,sort:l,facetby:[],as:f})}static makeFromEncoding(t,e){const n=e.stack,{encoding:r}=e;if(!n)return null;let i;if(n.groupbyChannel){i=Tr(r[n.groupbyChannel])}const o=function(t){return t.stack.stackBy.reduce((t,e)=>{const n=gr(e.fieldDef);return n&&t.push(n),t},[])}(e),a=e.encoding.order;let c;return c=s(a)||cr(a)?Jo(a):o.reduce((t,e)=>(t.field.push(e),t.order.push("descending"),t),{field:[],order:[]}),new pf(t,{dimensionFieldDef:i,stackField:e.vgField(n.fieldChannel),facetby:[],stackby:o,sort:c,offset:n.offset,impute:n.impute,as:[e.vgField(n.fieldChannel,{suffix:"start",forAs:!0}),e.vgField(n.fieldChannel,{suffix:"end",forAs:!0})]})}get stack(){return this._stack}addDimensions(t){this._stack.facetby=this._stack.facetby.concat(t)}dependentFields(){const t=new Set;t.add(this._stack.stackField),this.getGroupbyFields().forEach(e=>t.add(e)),this._stack.facetby.forEach(e=>t.add(e));const e=this._stack.sort.field;return s(e)?e.forEach(e=>t.add(e)):t.add(e),t}producedFields(){return new Set(this._stack.as)}hash(){return`Stack ${M(this._stack)}`}getGroupbyFields(){const{dimensionFieldDef:t,impute:e,groupby:n}=this._stack;return t?t.bin?e?[gr(t,{binSuffix:"mid"})]:[gr(t,{}),gr(t,{binSuffix:"end"})]:[gr(t)]:n||[]}assemble(){const t=[],{facetby:e,dimensionFieldDef:n,stackField:r,stackby:i,sort:s,offset:o,impute:a,as:c}=this._stack;return a&&n&&(n.bin&&t.push({type:"formula",expr:"("+gr(n,{expr:"datum"})+"+"+gr(n,{expr:"datum",binSuffix:"end"})+")/2",as:gr(n,{binSuffix:"mid",forAs:!0})}),t.push({type:"impute",field:r,groupby:[...i,...e],key:gr(n,{binSuffix:"mid"}),method:"value",value:0})),t.push({type:"stack",groupby:this.getGroupbyFields().concat(e),field:r,sort:s,as:c,offset:o}),t}}class mf extends Fo{constructor(t,e){super(t),this.transform=e}clone(){return new mf(null,L(this.transform))}addDimensions(t){this.transform.groupby=Y(this.transform.groupby.concat(t),t=>t)}dependentFields(){const t=new Set;return this.transform.groupby.forEach(e=>t.add(e)),this.transform.sort.forEach(e=>t.add(e.field)),this.transform.window.map(t=>t.field).filter(t=>void 0!==t).forEach(e=>t.add(e)),t}producedFields(){return new Set(this.transform.window.map(this.getDefaultName))}getDefaultName(t){return t.as||gr(t)}hash(){return`WindowTransform ${M(this.transform)}`}assemble(){const t=[],e=[],n=[],r=[];for(const i of this.transform.window)e.push(i.op),n.push(this.getDefaultName(i)),r.push(void 0===i.param?null:i.param),t.push(void 0===i.field?null:i.field);const i=this.transform.frame,s=this.transform.groupby,o=[],a=[];if(void 0!==this.transform.sort)for(const t of this.transform.sort)o.push(t.field),a.push(t.order||"ascending");const c={field:o,order:a},u=this.transform.ignorePeers,l={type:"window",params:r,as:n,ops:e,fields:t,sort:c};return void 0!==u&&(l.ignorePeers=u),void 0!==s&&(l.groupby=s),void 0!==i&&(l.frame=i),l}}class hf extends cf{run(t){const e=t.parent;if(t instanceof df){if(e instanceof of)return this.flags;if(e.numChildren()>1)return this.setContinue(),this.flags;if(e instanceof df)this.setMutated(),e.merge(t);else{if(Q(e.producedFields(),t.dependentFields()))return this.setContinue(),this.flags;this.setMutated(),t.swapWithParent()}}return this.setContinue(),this.flags}}class gf extends uf{mergeNodes(t,e){const n=e.shift();for(const r of e)t.removeChild(r),r.parent=n,r.remove()}run(t){const e=t.children.map(t=>t.hash()),n={};for(let r=0;r<e.length;r++)void 0===n[e[r]]?n[e[r]]=[t.children[r]]:n[e[r]].push(t.children[r]);for(const e of K(n))n[e].length>1&&(this.setMutated(),this.mergeNodes(t,n[e]));for(const e of t.children)this.run(e);return this.mutatedFlag}}class bf extends cf{run(t){return t instanceof ta||t.numChildren()>0||t instanceof ff?this.flags:(this.setMutated(),t.remove(),this.flags)}}class vf extends cf{constructor(){super(...arguments),this.fields=new Set}run(t){if(this.setContinue(),t instanceof xu){const e=t.producedFields();B(e,this.fields)?(this.setMutated(),t.remove()):this.fields=new Set([...this.fields,...e])}return this.flags}}function xf(t){if(t instanceof ff)if(1!==t.numChildren()||t.children[0]instanceof ta){const n=t.model.component.data.main;!function t(e){if(e instanceof ta&&e.type===js&&1===e.numChildren()){const n=e.children[0];n instanceof ff||(n.swapWithParent(),t(e))}}(n);const r=(e=t,function t(n){if(!(n instanceof ff)){const r=n.clone();if(r instanceof ta){const t=kf+r.getSource();r.setSource(t),e.model.component.data.outputNodes[t]=r}else(r instanceof lf||r instanceof pf||r instanceof mf)&&r.addDimensions(e.fields);return q(n.children.map(t)).forEach(t=>t.parent=r),[r]}return q(n.children.map(t))}),i=q(t.children.map(r));for(const t of i)t.parent=n}else{const e=t.children[0];(e instanceof lf||e instanceof pf||e instanceof mf)&&e.addDimensions(t.fields),e.swapWithParent(),xf(t)}else t.children.map(xf);var e}class yf extends uf{run(t){t instanceof ta&&!t.isRequired()&&(this.setMutated(),t.remove());for(const e of t.children)this.run(e);return this.mutatedFlag}}class Sf extends cf{run(t){const e=t.parent,n=e.children.filter(t=>t instanceof df);if(n.length>1){const t={};for(const e of n){const n=e.parse;for(const e of K(n))void 0===t[e]?t[e]=n[e]:t[e]!==n[e]&&delete t[e]}if(0!==K(t).length){this.setMutated();const r=new df(e,t);for(const i of n){for(const e of K(t))delete i.parse[e];e.removeChild(i),i.parent=r,0===K(i.parse).length&&i.remove()}}}return this.setContinue(),this.flags}}class Of extends cf{run(t){const e=t.parent,n=e.children.filter(t=>t instanceof lf),r={};for(const t of n){const e=M(K(t.groupBy).sort());e in r||(r[e]=[]),r[e].push(t)}for(const t of K(r)){const n=r[t];if(n.length>1){const t=n.pop();for(const r of n)t.merge(r)&&(e.removeChild(r),r.parent=t,r.remove(),this.setMutated())}}return this.setContinue(),this.flags}}const kf="scale_",Ef=5;function jf(t){const e=[];return t.forEach(function t(n){0===n.numChildren()?e.push(n):n.children.forEach(t)}),e}function _f(t){return t}function Af(t,e,n){return e.map(e=>{const n=new t;return n instanceof cf?n.optimizeNextFromLeaves(e):n.run(e)}).some(_f)||n}function wf(t){let e=t.sources,n=!1;return n=Af(yf,e,n),e=e.filter(t=>t.numChildren()>0),n=Af(bf,jf(e),n),e=e.filter(t=>t.numChildren()>0),n=Af(hf,jf(e),n),n=Af(vf,jf(e),n),n=Af(Sf,jf(e),n),n=Af(Of,jf(e),n),n=Af(gf,e,n),t.sources=e,n}function zf(t){Df(t)?function(t){const e=t.specifiedScales,n=t.component.scales;K(n).forEach(r=>{const i=e[r],s=i?i.domain:void 0,o=function(t,e){const n=t.getScaleComponent(e).get("type"),r=function(t,e,n,r){if("unaggregated"===t){const{valid:t,reason:r}=If(e,n);if(!t)return void mn(r)}else if(void 0===t&&r.useUnaggregatedDomain){const{valid:t}=If(e,n);if(t)return"unaggregated"}return t}(t.scaleDomain(e),t.fieldDef(e),n,t.config.scale);r!==t.scaleDomain(e)&&(t.specifiedScales[e]=Object.assign({},t.specifiedScales[e],{domain:r}));if("x"===e&&t.channelHasField("x2"))return t.channelHasField("x")?Lf(n,r,t,"x").concat(Lf(n,r,t,"x2")):Lf(n,r,t,"x2");if("y"===e&&t.channelHasField("y2"))return t.channelHasField("y")?Lf(n,r,t,"y").concat(Lf(n,r,t,"y2")):Lf(n,r,t,"y2");return Lf(n,r,t,e)}(t,r),a=n[r];if(a.domains=o,Fi(s)&&a.set("domainRaw",{signal:Bu+M(s)},!0),t.component.data.isFaceted){let e=t;for(;!Ff(e)&&e.parent;)e=e.parent;const n=e.component.resolve.scale[r];if("shared"===n)for(const t of o)Po(t)&&(t.data=kf+t.data.replace(kf,""))}})}(t):function(t){for(const e of t.children)zf(e);const e=t.component.scales;K(e).forEach(n=>{let r,i=null;for(const e of t.children){const t=e.component.scales[n];if(t){r=void 0===r?t.domains:r.concat(t.domains);const e=t.get("domainRaw");i&&e&&i.signal!==e.signal&&mn("The same selection must be used to override scale domains in a layered view."),i=e}}e[n].domains=r,i&&e[n].set("domainRaw",i,!0)})}(t)}function Lf(t,e,n,r){const i=n.fieldDef(r);if(e&&"unaggregated"!==e&&!Fi(e)){const{type:t,timeUnit:n}=i;return"temporal"===t||n?function(t,e,n){return t.map(t=>({signal:`{data: ${qr(t,{timeUnit:n,type:e})}}`}))}(e,t,n):[e]}const s=n.stack;if(s&&r===s.fieldChannel){if("normalize"===s.offset)return[[0,1]];const t=n.requestDataName(js);return[{data:t,field:n.vgField(r,{suffix:"start"})},{data:t,field:n.vgField(r,{suffix:"end"})}]}const o=_e(r)?function(t,e,n){if(!Vi(n))return;const r=t.fieldDef(e),i=r.sort;if(Us(i))return{op:"min",field:Gc(r,e),order:"ascending"};if(Rs(i))return Object.assign({},i,i.field?{field:it(i.field)}:{});if("descending"===i)return{op:"min",field:t.vgField(e),order:"descending"};if(N(["ascending",void 0],i))return!0;return}(n,r,t):void 0;if("unaggregated"===e){const t=n.requestDataName(js),{field:e}=i;return[{data:t,field:gr({field:e,aggregate:"min"})},{data:t,field:gr({field:e,aggregate:"max"})}]}if(Ie(i.bin)){if(Qi(t)){const t=n.getName(`${Le(i.bin)}_${i.field}_bins`);return[{signal:`sequence(${t}.start, ${t}.stop + ${t}.step, ${t}.step)`}]}if(Vi(t))return[{data:Z(o)?n.requestDataName(js):n.requestDataName(_s),field:n.vgField(r,$r(i,r)?{binSuffix:"range"}:{}),sort:!0!==o&&Rs(o)?o:{field:n.vgField(r,{}),op:"min"}}];if("x"===r||"y"===r){if(Re(i.bin)&&i.bin.extent)return[i.bin.extent];const t=n.requestDataName(js);return[{data:t,field:n.vgField(r,{})},{data:t,field:n.vgField(r,{binSuffix:"end"})}]}return[{data:n.requestDataName(js),field:n.vgField(r,{})}]}return o?[{data:Z(o)?n.requestDataName(js):n.requestDataName(_s),field:n.vgField(r),sort:o}]:[{data:n.requestDataName(js),field:n.vgField(r)}]}function If(t,e){return t.aggregate?xt[t.aggregate]?"quantitative"===t.type&&"log"===e?{valid:!1,reason:hn.unaggregatedDomainWithLogScale(t)}:{valid:!0}:{valid:!1,reason:hn.unaggregateDomainWithNonSharedDomainOp(t.aggregate)}:{valid:!1,reason:hn.unaggregateDomainHasNoEffectForRawField(t)}}function Tf(t){if(Po(t)&&a(t.field))return t.field;if(function(t){return!s(t)&&"fields"in t&&!("data"in t)}(t)){let e;for(const n of t.fields)if(Po(n)&&a(n.field))if(e){if(e!==n.field)return mn("Detected faceted independent scales that union domain of multiple fields from different data sources.  We will use the first field.  The result view size may be incorrect."),e}else e=n.field;return mn("Detected faceted independent scales that union domain of identical fields from different source detected.  We will assume that this is the same field from a different fork of the same data source.  However, if this is not case, the result view size maybe incorrect."),e}if(function(t){return!s(t)&&"fields"in t&&"data"in t}(t)){mn("Detected faceted independent scales that union domain of multiple fields from the same data source.  We will use the first field.  The result view size may be incorrect.");const e=t.fields[0];return a(e)?e:void 0}}function Rf(t,e){return function(t){const e=Y(t.map(t=>Po(t)?Lt(t,["sort"]):t),M),n=Y(t.map(t=>{if(Po(t)){const e=t.sort;return void 0===e||Z(e)||("count"===e.op&&delete e.field,"ascending"===e.order&&delete e.order),e}}).filter(t=>void 0!==t),M);if(1===e.length){const e=t[0];if(Po(e)&&n.length>0){let t=n[0];return n.length>1&&(mn(hn.MORE_THAN_ONE_SORT),t=!0),Object.assign({},e,{sort:t})}return e}const r=Y(n.map(t=>Z(t)?t:"count"===t.op?t:(mn(hn.domainSortDropped(t)),!0)),M);let i;1===r.length?i=r[0]:r.length>1&&(mn(hn.MORE_THAN_ONE_SORT),i=!0);const s=Y(t.map(t=>Po(t)?t.data:null),t=>t);if(1===s.length&&null!==s[0])return Object.assign({data:s[0],fields:e.map(t=>t.field)},i?{sort:i}:{});return Object.assign({fields:e},i?{sort:i}:{})}(t.component.scales[e].domains.map(e=>(Po(e)&&(e.data=t.lookupDataSource(e.data)),e)))}function Uf(t){return K(t.component.scales).reduce((e,n)=>{const r=t.component.scales[n];if(r.merged)return e;const i=r.combine();let{domainRaw:o}=i;const{name:a,type:u,domainRaw:l,range:f}=i,d=Lt(i,["name","type","domainRaw","range"]),p=function(t,e,n,r){return t instanceof ef?Mf(t,n):s(t)?t.map(t=>t instanceof ef?Mf(t,n):t):"x"!==r&&"y"!==r||!No(t)?t:{step:{signal:e+"_step"}}}(i.range,a,t,n);return o&&function(t){return t.signal.indexOf(Bu)>=0}(o)&&(o=function(t,e){const n=JSON.parse(e.signal.replace(Bu,"")),r=D(n.selection),i=n.encoding;let s=n.field,o=t.component.selection&&t.component.selection[r];if(!o){if(o=t.getSelectionComponent(r,n.selection),i||s){if(i&&!s){const t=o.project.filter(t=>t.channel===i);!t.length||t.length>1?(s=o.project[0].field,mn((t.length?"Multiple ":"No ")+`matching ${c(i)} encoding found for selection ${c(n.selection)}. `+`Using "field": ${c(s)}.`)):s=t[0].field}}else s=o.project[0].field,o.project.length>1&&mn('A "field" or "encoding" must be specified when using a selection as a scale domain. '+`Using "field": ${c(s)}.`);return{signal:nt(s,r)}}return mn('Use "bind": "scales" to setup a binding for scales and selections within the same view.'),{signal:"null"}}(t,o)),e.push(Object.assign({name:a,type:u,domain:Rf(t,n)},o?{domainRaw:o}:{},{range:p},d)),e},[])}function Mf(t,e){let n=t.expr;for(const r of t.signalNames){const t=e.getSignalName(r);if(t!==r){const e=I(r);n=n.replace(e,t)}}return{signal:n}}class Nf extends zl{constructor(t,e){super({},{name:t}),this.merged=!1,this.domains=[],this.setWithExplicit("type",e)}}const Pf=["range","rangeStep","scheme"];function Cf(t){return"x"===t?"width":"y"===t?"height":void 0}function Hf(t){const e=t.component.scales;je.forEach(n=>{const r=e[n];if(!r)return;const i=t.getScaleComponent(n),s=t.specifiedScales[n],o=t.fieldDef(n),a=Cf(n);let c=a?!!t.component.layoutSize.get(a):void 0;const u=i.get("type"),l=N(["point","band"],u)||!!s.rangeStep;a&&t.fit&&!c&&l&&(mn(hn.CANNOT_FIX_RANGE_STEP_WITH_FIT),c=!0);const f=function(t){const e=[];for(const n of ye){const r=qf(t,n);void 0!==r&&e.push(r)}return e}(t),d=function(t,e,n,r,i,s,o,a,c,u){const l=a||null===r.rangeStep;for(const n of Pf)if(void 0!==r[n]){const i=is(e,n),s=ss(t,n);if(i)if(s)mn(s);else switch(n){case"range":return Ll(r[n]);case"scheme":return Ll(Wf(r[n]));case"rangeStep":const e=r[n];if(null!==e){if(!a)return Ll({step:e});mn(hn.rangeStepDropped(t))}}else mn(hn.scalePropertyNotWorkWithScaleType(e,n,t))}return Il(function(t,e,n,r,i,s,o,a,c,u){switch(t){case It:case Tt:if(N(["point","band"],e)&&!c)if(t===It&&"text"===s){if(r.scale.textXRangeStep)return{step:r.scale.textXRangeStep}}else if(r.scale.rangeStep)return{step:r.scale.rangeStep};return t===Tt&&Ki(e)?[ef.fromName(o),0]:[0,ef.fromName(o)];case Vt:const l=function(t,e,n){if(e)return 0;switch(t){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(hn.incompatibleChannel("size",t))}(s,i,r),f=function(t,e,n){const r=n.scale;switch(t){case"bar":case"tick":if(void 0!==n.scale.maxBandSize)return n.scale.maxBandSize;const i=Gf(e,n.scale);return rf("min - 1",{min:i});case"line":case"trail":case"rule":return n.scale.maxStrokeWidth;case"text":return n.scale.maxFontSize;case"point":case"square":case"circle":if(n.scale.maxSize)return n.scale.maxSize;const s=Gf(e,r);return rf(`pow(${Yf} * pointStep, 2)`,{pointStep:s})}throw new Error(hn.incompatibleChannel("size",t))}(s,a,r);return Xi(e)?function(t,e,n){const r="(rangeMax - rangeMin) / (cardinality - 1)";return rf(`sequence(rangeMin, rangeMax + ${r}, ${r})`,{rangeMin:t,rangeMax:e,cardinality:n})}(l,f,$f(e,r,u,t)):[l,f];case re:return[r.scale.minStrokeWidth,r.scale.maxStrokeWidth];case Bt:return"symbol";case Qt:case Kt:case Jt:if("ordinal"===e)return"nominal"===n?"category":"ordinal";if(Xi(e)){const n=$f(e,r,u,t);return r.range&&ps(r.range.ordinal)?Object.assign({},r.range.ordinal,{count:n}):{scheme:"blues",count:n}}return Ji(e)?["#f7fbff","#0e427f"]:"rect"===s||"geoshape"===s?"heatmap":"ramp";case te:case ee:case ne:return[r.scale.minOpacity,r.scale.maxOpacity]}throw new Error(`Scale range undefined for channel ${t}`)}(t,e,n,i,s,o,c,u,l,r.domain))}(n,u,o.type,s,t.config,r.get("zero"),t.mark,c,t.getName(a),f);r.setWithExplicit("range",d)})}function qf(t,e){const n=t.getScaleComponent(e);if(!n)return;const r=n.get("type"),i=t.fieldDef(e);if(Vi(r)){const t=n&&n.get("range");if(t&&No(t)&&b(t.step))return t.step}else if(i&&i.bin&&Ie(i.bin)){const n=t.getName(gr(i,{suffix:"bins"})),r=`(${n}.stop - ${n}.start) / ${n}.step`,s=Cf(e),o=t.getName(s);return new ef(`${o} / (${r})`,[o,n])}}function Wf(t){if(Di(t)){const e={scheme:t.name};return t.count&&(e.count=t.count),t.extent&&(e.extent=t.extent),e}return{scheme:t}}function $f(t,e,n,r){switch(t){case"quantile":return e.scale.quantileCount;case"quantize":return e.scale.quantizeCount;case"threshold":return void 0!==n&&s(n)?n.length+1:(mn(hn.domainRequiredForThresholdScale(r)),3)}}const Yf=.95;function Gf(t,e){if(t.length>0){const e=[],n=[];let r=1/0;for(const i of t)if(i instanceof ef){e.push(i.expr);for(const t of i.signalNames)n.push(t);r=void 0}else e.push(i),void 0!==r&&i<r&&(r=i);return void 0!==r?r:new ef(`min(${e.join(", ")})`,n)}return e.rangeStep?e.rangeStep:21}function Bf(t,e){Df(t)?function(t,e){const n=t.component.scales;K(n).forEach(r=>{const i=t.specifiedScales[r],s=n[r],o=t.getScaleComponent(r),a=t.fieldDef(r),c=t.config,u=i[e],l=o.get("type"),f=is(l,e),d=ss(r,e);if(void 0!==u&&(f?d&&mn(d):mn(hn.scalePropertyNotWorkWithScaleType(l,e,r))),f&&void 0===d)if(void 0!==u)s.copyKeyFromObject(e,i);else{const n=function(t,e,n,r,i,s,o,a,c){const u=c.scale;switch(t){case"interpolate":return function(t,e){if(N([Qt,Kt,Jt],t)&&Ji(e))return"hcl";return}(e,r);case"nice":return function(t,e,n){if(n.bin||N([Li.TIME,Li.UTC],t))return;return!!N([It,Tt],e)||void 0}(r,e,n);case"padding":return function(t,e,n,r,i,s){if(N([It,Tt],t)){if(Ji(e)){if(void 0!==n.continuousPadding)return n.continuousPadding;const{type:e,orient:o}=i;if("bar"===e&&!r.bin&&("vertical"===o&&"x"===t||"horizontal"===o&&"y"===t))return s.continuousBandSize}if(e===Li.POINT)return n.pointPadding}return}(e,r,u,n,a,c.bar);case"paddingInner":return function(t,e,n,r){if(void 0!==t)return;if(N([It,Tt],e)){const{bandPaddingInner:t,barBandPaddingInner:e,rectBandPaddingInner:i}=r;return at(t,"bar"===n?e:i)}return}(i,e,a.type,u);case"paddingOuter":return function(t,e,n,r,i,s){if(void 0!==t)return;if(N([It,Tt],e)&&n===Li.BAND){const{bandPaddingOuter:t,barBandPaddingOuter:e,rectBandPaddingOuter:n}=s;return at(t,"bar"===r?e:n,i/2)}return}(i,e,r,a.type,s,u);case"reverse":return function(t,e){if(Ki(t)&&"descending"===e)return!0;return}(r,n.sort);case"zero":return function(t,e,n,r,i){if(n&&"unaggregated"!==n)return!1;if("size"===t&&"quantitative"===e.type&&!Xi(i))return!0;if(!e.bin&&N([It,Tt],t)){const{orient:e,type:n}=r;return!N(["bar","area","line","trail"],n)||!("horizontal"===e&&"y"===t||"vertical"===e&&"x"===t)}return!1}(e,n,o,a,r)}return u[t]}(e,r,a,o.get("type"),o.get("padding"),o.get("paddingInner"),i.domain,t.markDef,c);void 0!==n&&s.set(e,n,!1)}})}(t,e):Qf(t,e)}function Vf(t){Df(t)?Hf(t):Qf(t,"range")}function Qf(t,e){const n=t.component.scales;for(const n of t.children)"range"===e?Vf(n):Bf(n,e);K(n).forEach(r=>{let i;for(const n of t.children){const t=n.component.scales[r];if(t){i=Ul(i,t.getWithExplicit(e),e,"scale",Tl((t,n)=>{switch(e){case"range":return t.step&&n.step?t.step-n.step:0}return 0}))}}n[r].setWithExplicit(e,i)})}function Kf(t,e,n,r,i){const o=function(t,e,n,r,i){switch(e.type){case"nominal":case"ordinal":if(ue(t)||"discrete"===we(t))return"shape"===t&&"ordinal"===e.type&&mn(hn.discreteChannelCannotEncode(t,"ordinal")),"ordinal";if(N(["x","y"],t)){if(N(["rect","bar","rule"],n))return"band";if("bar"===n)return"band"}return"point";case"temporal":return ue(t)?"time":"discrete"===we(t)?(mn(hn.discreteChannelCannotEncode(t,"temporal")),"ordinal"):"time";case"quantitative":if(ue(t)){if(Ie(e.bin))return"bin-ordinal";const{domain:t,range:n}=r||{};return t&&s(t)&&t.length>2&&n&&s(n)&&n.length>2?"linear":"sequential"}return"discrete"===we(t)?(mn(hn.discreteChannelCannotEncode(t,"quantitative")),"ordinal"):Ie(e.bin)&&"x"!==t&&"y"!==t?"bin-linear":"linear";case"geojson":return}throw new Error(hn.invalidFieldType(e.type))}(e,n,r,t),{type:a}=t;return _e(e)?void 0!==a?as(e,a)?os(a,n.type,n.bin)?a:(mn(hn.scaleTypeNotWorkWithFieldDef(a,o)),o):(mn(hn.scaleTypeNotWorkWithChannel(e,a,o)),o):o:null}function Jf(t){Df(t)?t.component.scales=function(t){const{encoding:e,config:n,mark:r}=t;return je.reduce((i,s)=>{let o,a;const c=e[s];if(cr(c)&&r===Ve&&s===Bt&&c.type===Dn)return i;if(cr(c)?(o=c,a=c.scale):or(c)&&(o=c.condition,a=c.condition.scale),o&&null!==a&&!1!==a){const e=Kf(a=a||{},s,o,r,n.scale);i[s]=new Nf(t.scaleName(s+"",!0),{value:e,explicit:a.type===e})}return i},{})}(t):t.component.scales=function(t){const e=t.component.scales={},n={},r=t.component.resolve;for(const e of t.children)Jf(e),K(e.component.scales).forEach(i=>{if(r.scale[i]=r.scale[i]||Al(i,t),"shared"===r.scale[i]){const t=n[i],s=e.component.scales[i].getWithExplicit("type");t?Ui(t.value,s.value)?n[i]=Ul(t,s,"type","scale",Xf):(r.scale[i]="independent",delete n[i]):n[i]=s}});return K(n).forEach(r=>{const i=t.scaleName(r,!0),s=n[r];e[r]=new Nf(i,s);for(const e of t.children){const t=e.component.scales[r];t&&(e.renameScale(t.get("name"),i),t.merged=!0)}}),e}(t)}const Xf=Tl((t,e)=>Ni(t)-Ni(e));class Zf{constructor(){this.nameMap={}}rename(t,e){this.nameMap[t]=e}has(t){return void 0!==this.nameMap[t]}get(t){for(;this.nameMap[t]&&t!==this.nameMap[t];)t=this.nameMap[t];return t}}function Df(t){return t&&"unit"===t.type}function Ff(t){return t&&"facet"===t.type}function td(t){return t&&"repeat"===t.type}function ed(t){return t&&"concat"===t.type}function nd(t){return t&&"layer"===t.type}class rd{constructor(t,e,n,r,i,s){this.children=[],this.correctDataNames=(t=>(t.from&&t.from.data&&(t.from.data=this.lookupDataSource(t.from.data)),t.from&&t.from.facet&&t.from.facet.data&&(t.from.facet.data=this.lookupDataSource(t.from.facet.data)),t)),this.parent=e,this.config=r,this.repeater=i,this.name=t.name||n,this.title=a(t.title)?{text:t.title}:t.title,this.scaleNameMap=e?e.scaleNameMap:new Zf,this.projectionNameMap=e?e.projectionNameMap:new Zf,this.signalNameMap=e?e.signalNameMap:new Zf,this.data=t.data,this.description=t.description,this.transforms=wo(t.transform||[]),this.layout=Fs(t)||Bs(t)?void 0:function(t){const{align:e,center:n,bounds:r,spacing:i}=t||{};return{align:e,bounds:r,center:n,spacing:i}}(t),this.component={data:{sources:e?e.component.data.sources:[],outputNodes:e?e.component.data.outputNodes:{},outputNodeRefCounts:e?e.component.data.outputNodeRefCounts:{},isFaceted:jn(t)||e&&e.component.data.isFaceted&&!t.data},layoutSize:new zl,layoutHeaders:{row:{},column:{}},mark:null,resolve:Object.assign({scale:{},axis:{},legend:{}},s?L(s):{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}get width(){return this.getSizeSignalRef("width")}get height(){return this.getSizeSignalRef("height")}initSize(t){const{width:e,height:n}=t;e&&this.component.layoutSize.set("width",e,!0),n&&this.component.layoutSize.set("height",n,!0)}parse(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSizeSignal(),this.parseSelection(),this.parseProjection(),this.parseData(),this.parseAxisAndHeader(),this.parseLegend(),this.parseMarkGroup()}parseScale(){!function(t){Jf(t),zf(t);for(const e of ns)Bf(t,e);Vf(t)}(this)}parseProjection(){tf(this)}renameTopLevelLayoutSizeSignal(){"width"!==this.getName("width")&&this.renameSignal(this.getName("width"),"width"),"height"!==this.getName("height")&&this.renameSignal(this.getName("height"),"height")}parseLegend(){Bl(this)}assembleGroupStyle(){if("unit"===this.type||"layer"===this.type)return"cell"}assembleLayoutSize(){if("unit"===this.type||"layer"===this.type)return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}}assembleLayout(){if(!this.layout)return;const{align:t,bounds:e,center:n,spacing:r={}}=this.layout;return Object.assign({padding:b(r)?r:{row:r.row||10,column:r.column||10}},this.assembleDefaultLayout(),t?{align:t}:{},e?{bounds:e}:{},n?{center:n}:{})}assembleDefaultLayout(){return{}}assembleHeaderMarks(){const{layoutHeaders:t}=this.component;let e=[];for(const n of Bc)t[n].title&&e.push(Qc(this,n));for(const t of Bc)e=e.concat(Kc(this,t));return e}assembleAxes(){return function(t,e){const{x:n=[],y:r=[]}=t;return[...n.map(t=>Ho(t,"main",e)),...n.map(t=>Ho(t,"grid",e)),...r.map(t=>Ho(t,"main",e)),...r.map(t=>Ho(t,"grid",e))].filter(t=>t)}(this.component.axes,this.config)}assembleLegends(){return Jl(this)}assembleProjections(){return Xl(this)}assembleTitle(){const t=this.title||{},{encoding:e}=t,n=Lt(t,["encoding"]),r=Object.assign({},fs(this.config.title).nonMark,n,e?{encode:{update:e}}:{});if(r.text)return N(["unit","layer"],this.type)||(r.anchor&&"start"!==r.anchor&&mn(hn.cannotSetTitleAnchor(this.type)),r.anchor="start"),N(["middle",void 0],r.anchor)&&void 0===r.frame&&(r.frame="group"),K(r).length>0?r:void 0}assembleGroup(t=[]){const e={};(t=t.concat(this.assembleSelectionSignals())).length>0&&(e.signals=t);const n=this.assembleLayout();n&&(e.layout=n),e.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());const r=!this.parent||Ff(this.parent)?function t(e){return nd(e)||ed(e)||td(e)?e.children.reduce((e,n)=>e.concat(t(n)),Uf(e)):Uf(e)}(this):[];r.length>0&&(e.scales=r);const i=this.assembleAxes();i.length>0&&(e.axes=i);const s=this.assembleLegends();return s.length>0&&(e.legends=s),e}hasDescendantWithFieldOnChannel(t){for(const e of this.children)if(Df(e)){if(e.channelHasField(t))return!0}else if(e.hasDescendantWithFieldOnChannel(t))return!0;return!1}getName(t){return D((this.name?this.name+"_":"")+t)}requestDataName(t){const e=this.getName(t),n=this.component.data.outputNodeRefCounts;return n[e]=(n[e]||0)+1,e}getSizeSignalRef(t){if(Ff(this.parent)){const e="width"===t?"x":"y",n=this.component.scales[e];if(n&&!n.merged){const t=n.get("type"),r=n.get("range");if(Vi(t)&&No(r)){const t=n.get("name"),r=Tf(Rf(this,e));if(r){return{signal:eu(t,n,gr({aggregate:"distinct",field:r},{expr:"datum"}))}}return mn("Unknown field for ${channel}.  Cannot calculate view size."),null}}}return{signal:this.signalNameMap.get(this.getName(t))}}lookupDataSource(t){const e=this.component.data.outputNodes[t];return e?e.getSource():t}getSignalName(t){return this.signalNameMap.get(t)}renameSignal(t,e){this.signalNameMap.rename(t,e)}renameScale(t,e){this.scaleNameMap.rename(t,e)}renameProjection(t,e){this.projectionNameMap.rename(t,e)}scaleName(t,e){return e?this.getName(t):pe(t)&&_e(t)&&this.component.scales[t]||this.scaleNameMap.has(this.getName(t))?this.scaleNameMap.get(this.getName(t)):void 0}projectionName(t){return t?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0}getScaleComponent(t){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale().  Make sure you have called parseScale or use parseUnitModelWithScale().");const e=this.component.scales[t];return e&&!e.merged?e:this.parent?this.parent.getScaleComponent(t):void 0}getSelectionComponent(t,e){let n=this.component.selection[t];if(!n&&this.parent&&(n=this.parent.getSelectionComponent(t,e)),!n)throw new Error(hn.selectionNotFound(e));return n}}class id extends rd{vgField(t,e={}){const n=this.fieldDef(t);if(n)return gr(n,e)}reduceFieldDef(t,e,n){return Zr(this.getMapping(),(e,n,r)=>{const i=Ir(n);return i?t(e,i,r):e},e,n)}forEachFieldDef(t,e){Xr(this.getMapping(),(e,n)=>{const r=Ir(e);r&&t(r,n)},e)}}function sd(t,e,n){let r;r=function(t){return"as"in t}(t)?a(t.as)?[t.as,`${t.as}_end`]:[t.as[0],t.as[1]]:[gr(t,{forAs:!0}),gr(t,{binSuffix:"end",forAs:!0})];const i=Mr(e,void 0)||{},s=function(t,e){return`${Le(t)}_${e}`}(i,t.field),{signal:o,extentSignal:c}=function(t,e){return{signal:t.getName(`${e}_bins`),extentSignal:t.getName(`${e}_extent`)}}(n,s);return{key:s,binComponent:Object.assign({bin:i,field:t.field,as:r},o?{signal:o}:{},c?{extentSignal:c}:{})}}class od extends Fo{constructor(t,e){super(t),this.bins=e}clone(){return new od(null,L(this.bins))}static makeFromEncoding(t,e){const n=e.reduceFieldDef((t,n,r)=>{if(ur(n)&&Ie(n.bin)){const{key:i,binComponent:s}=sd(n,n.bin,e);t[i]=Object.assign({},s,t[i],function(t,e,n,r){if($r(e,n)){const i=Df(t)&&(t.axis(n)||t.legend(n))||{},s=gr(e,{expr:"datum"}),o=gr(e,{expr:"datum",binSuffix:"end"});return{formulaAs:gr(e,{binSuffix:"range",forAs:!0}),formula:Qo(s,o,i.format,r)}}return{}}(e,n,r,e.config))}return t},{});return 0===K(n).length?null:new od(t,n)}static makeFromTransform(t,e,n){const{key:r,binComponent:i}=sd(e,e.bin,n);return new od(t,{[r]:i})}merge(t){this.bins=Object.assign({},this.bins,t.bins),t.remove()}producedFields(){return new Set(q(J(this.bins).map(t=>t.as)))}dependentFields(){return new Set(J(this.bins).map(t=>t.field))}hash(){return`Bin ${M(this.bins)}`}assemble(){return q(J(this.bins).map(t=>{const e=[],n=Object.assign({type:"bin",field:t.field,as:t.as,signal:t.signal},t.bin);return!t.bin.extent&&t.extentSignal&&(e.push({type:"extent",field:t.field,signal:t.extentSignal}),n.extent={signal:t.extentSignal}),e.push(n),t.formula&&e.push({type:"formula",expr:t.formula,as:t.formulaAs}),e}))}}class ad extends Fo{constructor(t,e,n){super(t),this.model=e,this.filter=n,this.expr=el(this.model,this.filter,this),this._dependentFields=$c(this.expr)}clone(){return new ad(null,this.model,L(this.filter))}dependentFields(){return this._dependentFields}assemble(){return{type:"filter",expr:this.expr}}hash(){return`Filter ${this.expr}`}}class cd extends Fo{constructor(t,e){super(t),this.transform=e,this.transform=L(e);const{flatten:n,as:r=[]}=this.transform;this.transform.as=n.map((t,e)=>r[e]||t)}clone(){return new cd(this.parent,L(this.transform))}producedFields(){return new Set(this.transform.as)}hash(){return`FlattenTransform ${M(this.transform)}`}assemble(){const{flatten:t,as:e}=this.transform;return{type:"flatten",fields:t,as:e}}}class ud extends Fo{constructor(t,e){super(t),this.transform=e,this.transform=L(e);const n=this.transform.as||[void 0,void 0];this.transform.as=[n[0]||"key",n[1]||"value"]}clone(){return new ud(null,L(this.transform))}producedFields(){return new Set(this.transform.as)}hash(){return`FoldTransform ${M(this.transform)}`}assemble(){const{fold:t,as:e}=this.transform;return{type:"fold",fields:t,as:e}}}class ld extends Fo{constructor(t,e,n,r){super(t),this.fields=e,this.geojson=n,this.signal=r}clone(){return new ld(null,L(this.fields),this.geojson,this.signal)}static parseAll(t,e){let n=0;if([[Wt,Ht],[$t,qt]].forEach(r=>{const i=r.map(t=>e.channelHasField(t)?e.fieldDef(t).field:void 0);(i[0]||i[1])&&(t=new ld(t,i,null,e.getName(`geojson_${n++}`)))}),e.channelHasField(Bt)){const r=e.fieldDef(Bt);r.type===Dn&&(t=new ld(t,null,r.field,e.getName(`geojson_${n++}`)))}return t}assemble(){return Object.assign({type:"geojson"},this.fields?{fields:this.fields}:{},this.geojson?{geojson:this.geojson}:{},{signal:this.signal})}}class fd extends Fo{constructor(t,e,n,r){super(t),this.projection=e,this.fields=n,this.as=r}clone(){return new fd(null,this.projection,L(this.fields),L(this.as))}static parseAll(t,e){return e.projectionName()?([[Wt,Ht],[$t,qt]].forEach(n=>{const r=n.map(t=>e.channelHasField(t)?e.fieldDef(t).field:void 0),i=n[0]===$t?"2":"";(r[0]||r[1])&&(t=new fd(t,e.projectionName(),r,[e.getName("x"+i),e.getName("y"+i)]))}),t):t}assemble(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}}}class dd extends Fo{clone(){return new dd(null)}constructor(t){super(t)}producedFields(){return new Set([ls])}assemble(){return{type:"identifier",as:ls}}}function pd(t,e,n,r){if(void 0!==t.size)return{value:t.size};const i=Wo("size",t,r,{skipGeneralMarkConfig:!0});if(void 0!==i)return{value:i};if(n){const t=n.get("type");if("point"!==t&&"band"!==t)return{value:r.bar.continuousBandSize};if(void 0!==r.bar.discreteBandSize)return{value:r.bar.discreteBandSize};if(t!==Li.POINT)return sl(e);{const t=n.get("range");if(No(t)&&b(t.step))return{value:t.step-1};mn(hn.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL)}}return{value:at(r.bar.discreteBandSize,r.scale.rangeStep?r.scale.rangeStep-1:void 0,20)}}function md(t,e){const{config:n,markDef:r,width:i,height:s}=t;return Object.assign({},ml(t,{size:"include",orient:"ignore"}),El("x",t,ll(i)),El("y",t,ll(s)),vl("size",t,{defaultValue:Wo("size",r,n)}),function(t,e,n){if(n)return{shape:{value:n}};return vl("shape",t,{defaultValue:Wo("shape",t.markDef,e)})}(t,n,e))}function hd(t){const{config:e,markDef:n}=t,r=n.orient,i=t.getScaleComponent("horizontal"===r?"x":"y");if(void 0!==n.size)return n.size;if(void 0!==e.tick.bandSize)return e.tick.bandSize;{const t=i?i.get("range"):void 0,n=t&&No(t)?t.step:e.scale.rangeStep;if("number"!=typeof n)throw new Error("Function does not handle non-numeric rangeStep");return 3*n/4}}const gd={area:{vgMark:"area",encodeEntry:t=>Object.assign({},ml(t,{size:"ignore",orient:"include"}),El("x",t,"zeroOrMin"),El("y",t,"zeroOrMin"),jl(t,"zeroOrMin","horizontal"===t.markDef.orient?"x2":"y2"),bl(t))},bar:{vgMark:"rect",encodeEntry:t=>Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),function(t){const{config:e,encoding:n,markDef:r,width:i}=t,s=r.orient,o=n.size,a=n.x,c=n.x2,u=t.scaleName(It),l=t.getScaleComponent(It);if(cr(a)&&Te(a.bin))return kl(a,c,It,u,at(r.binSpacing,e.bar.binSpacing),l.get("reverse"));if("horizontal"===s||c)return Object.assign({},El("x",t,"zeroOrMin"),jl(t,"zeroOrMin","x2"));if(cr(a)){const n=l.get("type");if(Ie(a.bin)&&!o&&!Vi(n))return kl(a,void 0,It,t.scaleName("x"),at(r.binSpacing,e.bar.binSpacing),l.get("reverse"));if(n===Li.BAND)return Sl(a,"x",t)}return Ol("x",t,Object.assign({},ll(i)),pd(r,u,l,e))}(t),function(t){const{config:e,encoding:n,height:r,markDef:i}=t,s=i.orient,o=n.size,a=n.y,c=n.y2,u=t.scaleName(Tt),l=t.getScaleComponent(Tt);if(cr(a)&&Te(a.bin))return kl(a,c,Tt,u,at(i.binSpacing,e.bar.binSpacing),l.get("reverse"));if("vertical"===s||c)return Object.assign({},El("y",t,"zeroOrMin"),jl(t,"zeroOrMin","y2"));if(cr(a)){const n=l.get("type");if(Ie(a.bin)&&!o&&!Vi(n))return kl(a,void 0,Tt,t.scaleName("y"),at(i.binSpacing,e.bar.binSpacing),l.get("reverse"));if(n===Li.BAND)return Sl(a,"y",t)}return Ol("y",t,ll(r),pd(i,u,l,e))}(t))},circle:{vgMark:"symbol",encodeEntry:t=>md(t,"circle")},geoshape:{vgMark:"shape",encodeEntry:t=>Object.assign({},ml(t,{size:"ignore",orient:"ignore"})),postEncodingTransform:t=>{const{encoding:e}=t,n=e.shape;return[Object.assign({type:"geoshape",projection:t.projectionName()},n&&cr(n)&&n.type===Dn?{field:gr(n,{expr:"datum"})}:{})]}},line:{vgMark:"line",encodeEntry:t=>{const{width:e,height:n}=t;return Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),El("x",t,ll(e)),El("y",t,ll(n)),vl("size",t,{vgChannel:"strokeWidth"}),bl(t))}},point:{vgMark:"symbol",encodeEntry:t=>md(t)},rect:{vgMark:"rect",encodeEntry:t=>Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),function(t){const e=t.encoding.x,n=t.encoding.x2,r=t.getScaleComponent(It),i=r?r.get("type"):void 0,s=t.scaleName(It);if(cr(e)&&(Ie(e.bin)||Te(e.bin)))return kl(e,n,It,s,0,r.get("reverse"));if(cr(e)&&r&&Vi(i)){if(i===Li.BAND)return Sl(e,"x",t);throw new Error(hn.scaleTypeNotWorkWithMark(Ge,i))}return Object.assign({},El("x",t,"zeroOrMax"),jl(t,"zeroOrMin","x2"))}(t),function(t){const e=t.encoding.y,n=t.encoding.y2,r=t.getScaleComponent(Tt),i=r?r.get("type"):void 0,s=t.scaleName(Tt);if(cr(e)&&(Ie(e.bin)||Te(e.bin)))return kl(e,n,Tt,s,0,r.get("reverse"));if(cr(e)&&r&&Vi(i)){if(i===Li.BAND)return Sl(e,"y",t);throw new Error(hn.scaleTypeNotWorkWithMark(Ge,i))}return Object.assign({},El("y",t,"zeroOrMax"),jl(t,"zeroOrMin","y2"))}(t))},rule:{vgMark:"rule",encodeEntry:t=>{const{markDef:e,width:n,height:r}=t,i=e.orient;return t.encoding.x||t.encoding.y||t.encoding.latitude||t.encoding.longitude?Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),El("x",t,"horizontal"===i?"zeroOrMin":ll(n)),El("y",t,"vertical"===i?"zeroOrMin":ll(r)),"vertical"!==i?jl(t,"zeroOrMax","x2"):{},"horizontal"!==i?jl(t,"zeroOrMax","y2"):{},vl("size",t,{vgChannel:"strokeWidth",defaultValue:e.size})):{}}},square:{vgMark:"symbol",encodeEntry:t=>md(t,"square")},text:{vgMark:"text",encodeEntry:t=>{const{config:e,encoding:n,width:r,height:i,markDef:s}=t,o=at(s.fontSize,s.size,$o("fontSize",s,e.style),$o("size",s,e.style),e[s.type].fontSize,e[s.type].size);return Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),El("x",t,ll(r)),El("y",t,ll(i)),yl(t),vl("size",t,{defaultValue:o,vgChannel:"fontSize"}),function(t,e){if(void 0!==e)return{[t]:{value:e}}}("align",function(t,e,n){if(void 0===(t.align||Wo("align",t,n)))return"center";return}(t.markDef,0,e)))}},tick:{vgMark:"rect",encodeEntry:t=>{const{config:e,markDef:n,width:r,height:i}=t,s=n.orient,o="horizontal"===s?"width":"height",a="horizontal"===s?"height":"width";return Object.assign({},ml(t,{size:"ignore",orient:"ignore"}),El("x",t,ll(r),"xc"),El("y",t,ll(i),"yc"),vl("size",t,{defaultValue:hd(t),vgChannel:o}),{[a]:{value:at(n.thickness,e.tick.thickness)}})}},trail:{vgMark:"trail",encodeEntry:t=>{const{width:e,height:n}=t;return Object.assign({},ml(t,{size:"include",orient:"ignore"}),El("x",t,ll(e)),El("y",t,ll(n)),vl("size",t),bl(t))}}};function bd(t){return N([He,Pe,Ye],t.mark)?function(t){const e=yd(t.mark,t.encoding),n=xd(t,{fromPrefix:e.length>0?vd:""});return e.length>0?[{name:t.getName("pathgroup"),type:"group",from:{facet:{name:vd+t.requestDataName(js),data:t.requestDataName(js),groupby:e}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:n}]:n}(t):xd(t)}const vd="faceted_path_";function xd(t,e={fromPrefix:""}){const n=t.mark,r=at(t.markDef.clip,function(t){const e=t.getScaleComponent("x"),n=t.getScaleComponent("y");return!!(e&&e.get("domainRaw")||n&&n.get("domainRaw"))}(t)),i=qo(t.markDef),o=t.encoding.key,a=function(t){const{encoding:e,stack:n,mark:r,markDef:i}=t,o=e.order;if(s(o)||!fr(o)){if((s(o)||cr(o))&&!n)return Jo(o,{expr:"datum"});if(Xe(r)){const n=e["horizontal"===i.orient?"y":"x"];if(cr(n)){const e=n.sort;return{field:Rs(e)?gr({aggregate:Br(t.encoding)?e.op:void 0,field:e.field},{expr:"datum"}):gr(n,{binSuffix:t.stack&&t.stack.impute?"mid":void 0,expr:"datum"}),order:"descending"}}}}}(t),c=gd[n].postEncodingTransform?gd[n].postEncodingTransform(t):null;return[Object.assign({name:t.getName("marks"),type:gd[n].vgMark},r?{clip:!0}:{},i?{style:i}:{},o?{key:{field:o.field}}:{},a?{sort:a}:{},{from:{data:e.fromPrefix+t.requestDataName(js)},encode:{update:gd[n].encodeEntry(t)}},c?{transform:c}:{})]}function yd(t,e){return K(e).reduce((n,r)=>{switch(r){case"x":case"y":case"order":case"href":case"x2":case"y2":case"xError":case"yError":case"xError2":case"yError2":case"latitude":case"longitude":case"latitude2":case"longitude2":case"text":case"shape":case"tooltip":return n;case"detail":case"key":const i=e[r];return(s(i)||cr(i))&&(s(i)?i:[i]).forEach(t=>{t.aggregate||n.push(gr(t,{}))}),n;case"size":if("trail"===t)return n;case"color":case"fill":case"stroke":case"opacity":case"fillOpacity":case"strokeOpacity":case"strokeWidth":const o=Tr(e[r]);return o&&!o.aggregate&&n.push(gr(o,{})),n;default:throw new Error(`Bug: Channel ${r} unimplemented for line mark`)}},[])}class Sd extends Fo{constructor(t,e){super(t),this.transform=e}clone(){return new Sd(null,L(this.transform))}producedFields(){return new Set([this.transform.impute])}processSequence(t){const{start:e=0,stop:n,step:r}=t;return{signal:`sequence(${[e,n,...r?[r]:[]].join(",")})`}}static makeFromTransform(t,e){return new Sd(t,e)}static makeFromEncoding(t,e){const n=e.encoding,r=n.x,i=n.y;if(cr(r)&&cr(i)){const s=r.impute?r:i.impute?i:void 0;if(void 0===s)return;const o=r.impute?i:i.impute?r:void 0,{method:a,value:c,frame:u,keyvals:l}=s.impute,f=yd(e.mark,n);return new Sd(t,Object.assign({impute:s.field,key:o.field},a?{method:a}:{},void 0!==c?{value:c}:{},u?{frame:u}:{},void 0!==l?{keyvals:l}:{},f.length?{groupby:f}:{}))}return null}hash(){return`Impute ${M(this.transform)}`}assemble(){const{impute:t,key:e,keyvals:n,method:r,groupby:i,value:s,frame:o=[null,null]}=this.transform,a=Object.assign({type:"impute",field:t,key:e},n?{keyvals:go(n)?this.processSequence(n):n}:{},{method:"value"},i?{groupby:i}:{},{value:null});let c;if(r&&"value"!==r){c=[Object.assign({type:"window",as:[`imputed_${t}_value`],ops:[r],fields:[t],frame:o,ignorePeers:!1},i?{groupby:i}:{}),{type:"formula",expr:`datum.${t} === null ? datum.imputed_${t}_value : datum.${t}`,as:t}]}else{c=[{type:"formula",expr:`datum.${t} === null ? ${s} : datum.${t}`,as:t}]}return[a,...c]}}class Od extends zl{constructor(t={},e={},n=!1){super(t,e),this.explicit=t,this.implicit=e,this.parseNothing=n}clone(){const t=super.clone();return t.parseNothing=this.parseNothing,t}}class kd extends Fo{constructor(t,e,n){super(t),this.transform=e,this.secondary=n}clone(){return new kd(null,L(this.transform),this.secondary)}static make(t,e,n,r){const i=e.component.data.sources;let s=Pd(n.from.data,i);s||(s=new of(n.from.data),i.push(s));const o=e.getName(`lookup_${r}`),a=new ta(s,o,"lookup",e.component.data.outputNodeRefCounts);return e.component.data.outputNodes[o]=a,new kd(t,n,a.getSource())}producedFields(){return new Set(this.transform.from.fields||(this.transform.as instanceof Array?this.transform.as:[this.transform.as]))}hash(){return`Lookup ${M({transform:this.transform,secondary:this.secondary})}`}assemble(){let t;if(this.transform.from.fields)t=Object.assign({values:this.transform.from.fields},this.transform.as?{as:this.transform.as instanceof Array?this.transform.as:[this.transform.as]}:{});else{let e=this.transform.as;a(e)||(mn(hn.NO_FIELDS_NEEDS_AS),e="_lookup"),t={as:[e]}}return Object.assign({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},t,this.transform.default?{default:this.transform.default}:{})}}class Ed extends Fo{constructor(t,e){super(t),this.transform=e}clone(){return new Ed(null,L(this.transform))}hash(){return`SampleTransform ${M(this.transform)}`}assemble(){return{type:"sample",size:this.transform.sample}}}function jd(t){let e=0;return function n(r,i){r instanceof of&&!Os(r.data)&&(t.push(i),i={name:null,source:i.name,transform:[]});if(r instanceof df&&(r.parent instanceof of&&!i.source?(i.format=Object.assign({},i.format||{},{parse:r.assembleFormatParse()}),i.transform=i.transform.concat(r.assembleTransforms(!0))):i.transform=i.transform.concat(r.assembleTransforms())),r instanceof ff)return i.name||(i.name=`data_${e++}`),!i.source||i.transform.length>0?(t.push(i),r.data=i.name):r.data=i.source,void r.assemble().forEach(e=>t.push(e));(r instanceof ad||r instanceof Yc||r instanceof fd||r instanceof ld||r instanceof lf||r instanceof kd||r instanceof mf||r instanceof ud||r instanceof cd||r instanceof dd||r instanceof Ed)&&i.transform.push(r.assemble()),(r instanceof od||r instanceof xu||r instanceof Sd||r instanceof pf)&&(i.transform=i.transform.concat(r.assemble())),r instanceof ta&&(i.source&&0===i.transform.length?r.setSource(i.source):r.parent instanceof ta?r.setSource(i.name):(i.name||(i.name=`data_${e++}`),r.setSource(i.name),1===r.numChildren()&&(t.push(i),i={name:null,source:i.name,transform:[]})));switch(r.numChildren()){case 0:r instanceof ta&&(!i.source||i.transform.length>0)&&t.push(i);break;case 1:n(r.children[0],i);break;default:i.name||(i.name=`data_${e++}`);let s=i.name;!i.source||i.transform.length>0?t.push(i):s=i.source,r.children.forEach(t=>{n(t,{name:null,source:s,transform:[]})})}}}function _d(t){wd(t);const e=t.component.layoutSize;e.setWithExplicit("width",zd(t,"width")),e.setWithExplicit("height",zd(t,"height"))}const Ad=_d;function wd(t){for(const e of t.children)e.parseLayoutSize()}function zd(t,e){const n="width"===e?"x":"y",r=t.component.resolve;let i;for(const s of t.children){const t=s.component.layoutSize.getWithExplicit(e),o=r.scale[n];if("independent"===o&&"range-step"===t.value){i=void 0;break}if(i){if("independent"===o&&i.value!==t.value){i=void 0;break}i=Ul(i,t,e,"")}else i=t}if(i){for(const n of t.children)t.renameSignal(n.getName(e),t.getName(e)),n.component.layoutSize.set(e,"merged",!1);return i}return{explicit:!1,value:void 0}}function Ld(t,e){const n="width"===e?"x":"y",r=t.config,i=t.getScaleComponent(n);if(i){const t=i.get("type"),n=i.get("range");return Vi(t)&&No(n)?"range-step":r.view[e]}return t.hasProjection?r.view[e]:"width"===e&&"text"===t.mark?r.scale.textXRangeStep:r.scale.rangeStep||Zi.rangeStep}function Id(t,e){return nr(t.field)?t.field.repeat in e?Object.assign({},t,{field:e[t.field.repeat]}):void mn(hn.noSuchRepeatedValue(t.field.repeat)):t}function Td(t,e){if(void 0!==(t=Id(t,e))){if(null===t)return null;if(ir(t)&&Rs(t.sort)){const n=Id(t.sort,e);t=Object.assign({},t,n?{sort:n}:{})}return t}}function Rd(t,e){if(!cr(t)){if(or(t)){const n=Td(t.condition,e);if(n)return Object.assign({},t,{condition:n});return Lt(t,["condition"])}return t}{const n=Td(t,e);if(n)return n;if(sr(t))return{condition:t.condition}}}function Ud(t,e){const n={};for(const r in t)if(t.hasOwnProperty(r)){const i=t[r];if(s(i))n[r]=i.map(t=>Rd(t,e)).filter(t=>t);else{const t=Rd(i,e);void 0!==t&&(n[r]=t)}}return n}function Md(t,e,n){return gr(e,Object.assign({suffix:`by_${gr(t)}`},n||{}))}class Nd extends id{constructor(t,e,n,r,i){super(t,e,n,i,r,t.resolve),this.type="facet",this.child=Fd(t.spec,this,this.getName("child"),void 0,r,i,!1),this.children=[this.child];const s=function(t,e){return Ud(t,e)}(t.facet,r);this.facet=this.initFacet(s)}initFacet(t){return Zr(t,(t,e,n)=>N([Yt,Gt],n)?void 0===e.field?(mn(hn.emptyFieldDef(e,n)),t):(t[n]=Rr(e,n),t):(mn(hn.incompatibleChannel(n,"facet")),t),{})}channelHasField(t){return!!this.facet[t]}fieldDef(t){return this.facet[t]}parseData(){this.component.data=Cd(this),this.child.parseData()}parseLayoutSize(){wd(this)}parseSelection(){this.child.parseSelection(),this.component.selection=this.child.component.selection}parseMarkGroup(){this.child.parseMarkGroup()}parseAxisAndHeader(){this.child.parseAxisAndHeader(),this.parseHeader("column"),this.parseHeader("row"),this.mergeChildAxis("x"),this.mergeChildAxis("y")}parseHeader(t){if(this.channelHasField(t)){const e=this.facet[t];let n=_r(e,this.config,{allowDisabling:!0});this.child.component.layoutHeaders[t].title&&(n+=" / "+this.child.component.layoutHeaders[t].title,this.child.component.layoutHeaders[t].title=null),this.component.layoutHeaders[t]={title:n,facetFieldDef:e,header:[this.makeHeaderComponent(t,!0)]}}}makeHeaderComponent(t,e){const n="row"===t?"height":"width";return{labels:e,sizeSignal:this.child.component.layoutSize.get(n)?this.child.getSizeSignalRef(n):void 0,axes:[]}}mergeChildAxis(t){const{child:e}=this;if(e.component.axes[t]){const{layoutHeaders:r,resolve:i}=this.component;if(i.axis[t]=wl(i,t),"shared"===i.axis[t]){const i="x"===t?"column":"row",s=r[i];for(const r of e.component.axes[t]){const t="top"===(n=r.get("orient"))||"left"===n?"header":"footer";s[t]=s[t]||[this.makeHeaderComponent(i,!1)];const e=Ho(r,"main",this.config,{header:!0});s[t][0].axes.push(e),r.mainExtracted=!0}}}var n}assembleSelectionTopLevelSignals(t){return this.child.assembleSelectionTopLevelSignals(t)}assembleSelectionSignals(){return this.child.assembleSelectionSignals(),[]}assembleSelectionData(t){return this.child.assembleSelectionData(t)}getHeaderLayoutMixins(){const t={};return["row","column"].forEach(e=>{["header","footer"].forEach(n=>{const r=this.component.layoutHeaders[e],i=r[n];if(i&&i[0]){const i="row"===e?"height":"width",s="header"===n?"headerBand":"footerBand";this.child.component.layoutSize.get(i)||(t[s]=t[s]||{},t[s][e]=.5),r.title&&(t.offset=t.offset||{},t.offset["row"===e?"rowTitle":"columnTitle"]=10)}})}),t}assembleDefaultLayout(){const t=this.channelHasField("column")?this.columnDistinctSignal():1;return Object.assign({},this.getHeaderLayoutMixins(),{columns:t,bounds:"full",align:"all"})}assembleLayoutSignals(){return this.child.assembleLayoutSignals()}columnDistinctSignal(){if(!(this.parent&&this.parent instanceof Nd)){return{signal:`length(data('${this.getName("column_domain")}'))`}}}assembleGroup(t){return this.parent&&this.parent instanceof Nd?Object.assign({},this.channelHasField("column")?{encode:{update:{columns:{field:gr(this.facet.column,{prefix:"distinct"})}}}}:{},super.assembleGroup(t)):super.assembleGroup(t)}getCardinalityAggregateForChild(){const t=[],e=[],n=[];if(this.child instanceof Nd){if(this.child.channelHasField("column")){const r=gr(this.child.facet.column);t.push(r),e.push("distinct"),n.push(`distinct_${r}`)}}else for(const r of["x","y"]){const i=this.child.component.scales[r];if(i&&!i.merged){const s=i.get("type"),o=i.get("range");if(Vi(s)&&No(o)){const i=Tf(Rf(this.child,r));i?(t.push(i),e.push("distinct"),n.push(`distinct_${i}`)):mn("Unknown field for ${channel}.  Cannot calculate view size.")}}}return{fields:t,ops:e,as:n}}assembleFacet(){const{name:t,data:e}=this.component.data.facetRoot,{row:n,column:r}=this.facet,{fields:i,ops:o,as:a}=this.getCardinalityAggregateForChild(),c=[];["row","column"].forEach(t=>{const e=this.facet[t];if(e){c.push(gr(e));const{sort:u}=e;if(Rs(u)){const{field:t,op:s}=u,c=Md(e,u);n&&r?(i.push(c),o.push("max"),a.push(c)):(i.push(t),o.push(s),a.push(c))}else if(s(u)){const n=Gc(e,t);i.push(n),o.push("max"),a.push(n)}}});const u=!!n&&!!r;return Object.assign({name:t,data:e,groupby:c},u||i.length?{aggregate:Object.assign({},u?{cross:u}:{},i.length?{fields:i,ops:o,as:a}:{})}:{})}headerSortFields(t){const{facet:e}=this,n=e[t];return n?Rs(n.sort)?[Md(n,n.sort,{expr:"datum"})]:s(n.sort)?[Gc(n,t,{expr:"datum"})]:[gr(n,{expr:"datum"})]:[]}headerSortOrder(t){const{facet:e}=this,n=e[t];if(n){const{sort:t}=n;return[(Rs(t)?t.order:!s(t)&&t)||"ascending"]}return[]}assembleMarks(){const{child:t}=this,e=function(t){const e=[],n=jd(e);return t.children.forEach(e=>n(e,{source:t.name,name:null,transform:[]})),e}(this.component.data.facetRoot),n=t.assembleLayoutSize(),r=t.assembleTitle(),i=t.assembleGroupStyle();return[Object.assign({name:this.getName("cell"),type:"group"},r?{title:r}:{},i?{style:i}:{},{from:{facet:this.assembleFacet()},sort:{field:[...this.headerSortFields("row"),...this.headerSortFields("column")],order:[...this.headerSortOrder("row"),...this.headerSortOrder("column")]}},e.length>0?{data:e}:{},n?{encode:{update:n}}:{},t.assembleGroup(function(t,e){if(t.component.selection&&K(t.component.selection).length){const n=c(t.getName("cell"));e.unshift({name:"facet",value:{},on:[{events:nu("mousemove","scope"),update:`isTuple(facet) ? facet : group(${n}).datum`}]})}return e}(this,[])))]}getMapping(){return this.facet}}function Pd(t,e){for(const n of e){const e=n.data;if(ks(t)&&ks(e)){const r=t.values,i=e.values;if(z(r,i))return n}else if(Os(t)&&Os(e)){if(t.url===e.url)return n}else if(Es(t)&&t.name===n.dataName)return n}return null}function Cd(t){let e=function(t,e){if(t.data||!t.parent){const n=Pd(t.data,e);if(n)return n.data.format=W({},t.data.format,n.data.format),n;{const n=new of(t.data);return e.push(n),n}}return t.parent.component.data.facetRoot?t.parent.component.data.facetRoot:t.parent.component.data.main}(t,t.component.data.sources);const{outputNodes:n,outputNodeRefCounts:r}=t.component.data,i=t.parent?t.parent.component.data.ancestorParse.clone():new Od;t.data&&t.data.format&&null===t.data.format.parse&&(i.parseNothing=!0),e=df.makeExplicit(e,t,i)||e,Du(t)&&(Df(t)||nd(t))&&(e=new dd(e));const s=t.parent&&nd(t.parent);(Df(t)||Ff(t))&&s&&(e=od.makeFromEncoding(e,t)||e),t.transforms.length>0&&(e=function(t,e,n){let r=0;for(const i of e.transforms){let s,o=void 0;if(So(i))s=t=new Yc(t,i),o="derived";else if(ho(i))s=t=df.makeImplicitFromFilterTransform(t,i,n)||t,t=new ad(t,e,i.filter);else if(Oo(i))s=t=od.makeFromTransform(t,i,e),o="number";else if(Eo(i))s=t=xu.makeFromTransform(t,i),o="date",void 0===n.getWithExplicit(i.field).value&&(t=new df(t,{[i.field]:o}),n.set(i.field,o,!1));else if(jo(i))s=t=lf.makeFromTransform(t,i),o="number",Du(e)&&(t=new dd(t));else if(bo(i))s=t=kd.make(t,e,i,r++),o="derived";else if(xo(i))s=t=new mf(t,i),o="number";else if(_o(i))s=t=pf.makeFromTransform(t,i),o="derived";else if(Ao(i))s=t=new ud(t,i),o="derived";else if(yo(i))s=t=new cd(t,i),o="derived";else if(vo(i))t=new Ed(t,i);else{if(!ko(i)){mn(hn.invalidTransformIgnored(i));continue}s=t=Sd.makeFromTransform(t,i),o="derived"}if(s&&void 0!==o)for(const t of s.producedFields())n.set(t,o,!1)}return t}(e,t,i)),e=df.makeImplicitFromEncoding(e,t,i)||e,Df(t)&&(e=ld.parseAll(e,t),e=fd.parseAll(e,t)),(Df(t)||Ff(t))&&(s||(e=od.makeFromEncoding(e,t)||e),e=xu.makeFromEncoding(e,t)||e,e=Yc.parseAllForSortIndex(e,t));const o=t.getName(_s),a=new ta(e,o,_s,r);if(n[o]=a,e=a,Df(t)){const n=lf.makeFromEncoding(e,t);n&&(e=n,Du(t)&&(e=new dd(e))),e=Sd.makeFromEncoding(e,t)||e,e=pf.makeFromEncoding(e,t)||e}const c=t.getName(js),u=new ta(e,c,js,r);n[c]=u,e=u;let l=null;if(Ff(t)){const r=t.getName("facet");e=function(t,e){const{row:n,column:r}=e;if(n&&r){let e=null;for(const i of[n,r])if(Rs(i.sort)){const{field:n,op:r}=i.sort;t=e=new mf(t,{window:[{op:r,field:n,as:Md(i,i.sort,{forAs:!0})}],groupby:[gr(i)],frame:[null,null]})}return e}return null}(e=Yc.parseAllForSortIndex(e,t),t.facet)||e,l=new ff(e,t,r,u.getSource()),n[r]=l,e=l}return Object.assign({},t.component.data,{outputNodes:n,outputNodeRefCounts:r,raw:a,main:u,facetRoot:l,ancestorParse:i})}class Hd extends rd{constructor(t,e,n,r,i,s){super(t,e,n,r,i,s)}parseData(){this.component.data=Cd(this),this.children.forEach(t=>{t.parseData()})}parseSelection(){this.component.selection={};for(const t of this.children)t.parseSelection(),K(t.component.selection).forEach(e=>{this.component.selection[e]=t.component.selection[e]})}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxisAndHeader(){for(const t of this.children)t.parseAxisAndHeader()}assembleSelectionTopLevelSignals(t){return this.children.reduce((t,e)=>e.assembleSelectionTopLevelSignals(t),t)}assembleSelectionSignals(){return this.children.forEach(t=>t.assembleSelectionSignals()),[]}assembleLayoutSignals(){return this.children.reduce((t,e)=>t.concat(e.assembleLayoutSignals()),Dc(this))}assembleSelectionData(t){return this.children.reduce((t,e)=>e.assembleSelectionData(t),t)}assembleMarks(){return this.children.map(t=>{const e=t.assembleTitle(),n=t.assembleGroupStyle(),r=t.assembleLayoutSize();return Object.assign({type:"group",name:t.getName("group")},e?{title:e}:{},n?{style:n}:{},r?{encode:{update:r}}:{},t.assembleGroup())})}}class qd extends Hd{constructor(t,e,n,r,i){super(t,e,n,i,r,t.resolve),this.type="concat",t.resolve&&t.resolve.axis&&("shared"===t.resolve.axis.x||"shared"===t.resolve.axis.y)&&mn(hn.CONCAT_CANNOT_SHARE_AXIS),this.isVConcat=Ys(t),this.children=(Ys(t)?t.vconcat:t.hconcat).map((t,e)=>Fd(t,this,this.getName("concat_"+e),void 0,r,i,!1))}parseLayoutSize(){!function(t){wd(t);const e=t.component.layoutSize,n=t.isVConcat?"width":"height";e.setWithExplicit(n,zd(t,n))}(this)}parseAxisGroup(){return null}assembleDefaultLayout(){return Object.assign({},this.isVConcat?{columns:1}:{},{bounds:"full",align:"each"})}}class Wd extends zl{constructor(t={},e={},n=!1){super(),this.explicit=t,this.implicit=e,this.mainExtracted=n}clone(){return new Wd(L(this.explicit),L(this.implicit),this.mainExtracted)}hasAxisPart(t){return"axis"===t||("grid"===t||"title"===t?!!this.get(t):!(!1===(e=this.get(t))||null===e));var e}}function $d(t,e,n,r="",i){const s=("band"===i?["axisBand"]:[]).concat(["x"===n?"axisX":"axisY","axis"+r.substr(0,1).toUpperCase()+r.substr(1),"axis"]);for(const n of s)if(e[n]&&void 0!==e[n][t])return e[n][t]}function Yd(t){switch(t){case It:return"bottom";case Tt:return"left"}throw new Error(hn.INVALID_CHANNEL_FOR_AXIS)}const Gd={bottom:"top",top:"bottom",left:"right",right:"left"};function Bd(t,e){if(!t)return e.map(t=>t.clone());{if(t.length!==e.length)return;const n=t.length;for(let r=0;r<n;r++){const n=t[r],i=e[r];if(!!n!=!!i)return;if(n&&i){const e=n.getWithExplicit("orient"),s=i.getWithExplicit("orient");if(e.explicit&&s.explicit&&e.value!==s.value)return;t[r]=Vd(n,i)}}}return t}function Vd(t,e){for(const n of _t){const r=Ul(t.getWithExplicit(n),e.getWithExplicit(n),n,"axis",(t,e)=>{switch(n){case"title":return Do(t,e);case"gridScale":return{explicit:t.explicit,value:at(t.value,e.value)}}return Rl(t,e,n,"axis")});t.setWithExplicit(n,r)}return t}function Qd(t,e){const n="x"===e?"x2":"y2",r=t.fieldDef(e),i=t.fieldDef(n),s=r?r.title:void 0,o=i?i.title:void 0;return s&&o?Zo(s,o):s||(o||(void 0!==s?s:void 0!==o?o:void 0))}function Kd(t,e){const n=e.axis(t),r=new Wd;_t.forEach(i=>{const s=function(t,e,n,r){const i=r.fieldDef(n),s=function(t,e,n,r){if(void 0!==e.labelAngle)return(e.labelAngle%360+360)%360;{const e=$d("labelAngle",t.config,n,Yd(n),t.getScaleComponent(n).get("type"));return void 0!==e?(e%360+360)%360:n===It&&N([Zn,Jn],r.type)?270:void 0}}(r,e,n,i);switch(t){case"scale":return r.scaleName(n);case"gridScale":return function(t,e){const n="x"===e?"y":"x";if(t.getScaleComponent(n))return t.scaleName(n)}(r,n);case"format":return Go(i,e.format,r.config);case"grid":if(Te(r.fieldDef(n).bin))return!1;{const t=r.getScaleComponent(n).get("type");return at(e.grid,function(t,e){return!Vi(t)&&!Ie(e.bin)}(t,i))}case"labelAlign":return at(e.labelAlign,function(t,e){if(void 0!==t)return t=(t%360+360)%360,"top"===e||"bottom"===e?t%180==0?"center":0<t&&t<180?"top"===e?"right":"left":"top"===e?"left":"right":(t+90)%180==0?"center":90<=t&&t<270?"left"===e?"left":"right":"left"===e?"right":"left"}(s,Yd(n)));case"labelAngle":return s;case"labelBaseline":return at(e.labelBaseline,function(t,e){if(void 0!==t)return"top"===e||"bottom"===e?t<=45||315<=t?"top"===e?"bottom":"top":135<=t&&t<=225?"top"===e?"top":"bottom":"middle":t<=45||315<=t||135<=t&&t<=225?"middle":45<=t&&t<=135?"left"===e?"top":"bottom":"left"===e?"bottom":"top"}(s,Yd(n)));case"labelFlush":return at(e.labelFlush,function(t,e){if("x"===e&&N(["quantitative","temporal"],t.type))return!0}(i,n));case"labelOverlap":{const t=r.getScaleComponent(n).get("type");return at(e.labelOverlap,function(t,e){if("nominal"!==t.type)return"log"!==e||"greedy"}(i,t))}case"orient":return at(e.orient,Yd(n));case"tickCount":{const t=r.getScaleComponent(n).get("type"),s=r.scaleName(n),o="x"===n?"width":"y"===n?"height":void 0,a=o?r.getSizeSignalRef(o):void 0;return at(e.tickCount,function({fieldDef:t,scaleType:e,size:n,scaleName:r,specifiedAxis:i={}}){if(!Vi(e)&&"log"!==e&&!N(["month","hours","day","quarter"],t.timeUnit))return i.tickStep?{signal:`(domain('${r}')[1] - domain('${r}')[0]) / ${i.tickStep} + 1`}:Ie(t.bin)?{signal:`ceil(${n.signal}/10)`}:{signal:`ceil(${n.signal}/40)`}}({fieldDef:i,scaleType:t,size:a,scaleName:s,specifiedAxis:e}))}case"title":const o="x"===n?"x2":"y2",a=r.fieldDef(o);return at(e.title,Qd(r,n),Xo([rr(i)],a?[rr(a)]:[]));case"values":return function(t,e,n,r){const i=t.values;if(i)return Wr(n,i);if(n.type===Kn){if(Ie(n.bin)){const t=e.scaleDomain(r);if(t&&"unaggregated"!==t&&!Fi(t))return i;const s=e.getName(gr(n,{suffix:"bins"}));return{signal:`sequence(${s}.start, ${s}.stop + ${s}.step, ${s}.step)`}}if(t.tickStep){const n=e.scaleName(r),i=t.tickStep;return{signal:`sequence(domain('${n}')[0], domain('${n}')[1] + ${i}, ${i})`}}}}(e,r,i,n)}return jt(t)?e[t]:void 0}(i,n,t,e);if(void 0!==s){const o=function(t,e,n,r,i){switch(e){case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(t===Qd(r,i))return!0}return t===n[e]}(s,i,n,e,t),a=$d(i,e.config,t,r.get("orient"),e.getScaleComponent(t).get("type"));o||void 0===a?r.set(i,s,o):"grid"===i&&a&&r.set(i,a,!1)}});const i=n.encoding||{},s=St.reduce((n,s)=>{if(!r.hasAxisPart(s))return n;const o=_l(i[s]||{},e),a="labels"===s?function(t,e,n,r){const i=t.fieldDef(e)||("x"===e?t.fieldDef("x2"):"y"===e?t.fieldDef("y2"):void 0),s=t.axis(e),o=t.config;let a={};if(Hr(i)){const n=t.getScaleComponent(e).get("type")===Li.UTC,r=Ko("datum.value",i.timeUnit,s.format,o.axis.shortTimeLabels,null,n);r&&(a.text={signal:r})}return a=Object.assign({},a,n),0===K(a).length?void 0:a}(e,t,o,r.get("orient")):o;return void 0!==a&&K(a).length>0&&(n[s]={update:a}),n},{});return K(s).length>0&&r.set("encode",s,!!n.encoding||void 0!==n.labelAngle),r}function Jd(t,e,n){const r=De(t)?Object.assign({},t):{type:t},i=r.orient||Wo("orient",r,n);return r.orient=function(t,e,n){switch(t){case qe:case Qe:case Ke:case We:case Ge:return}const{x:r,y:i,x2:s,y2:o}=e;switch(t){case Ce:if(cr(r)&&Te(r.bin))return"vertical";if(cr(i)&&Te(i.bin))return"horizontal";if(o||s){if(n)return n;if(!s&&cr(r)&&r.type===Kn&&!Ie(r.bin))return"horizontal";if(!o&&cr(i)&&i.type===Kn&&!Ie(i.bin))return"vertical"}case Be:if(s&&o)return;case Pe:if(o)return cr(i)&&Te(i.bin)?"horizontal":"vertical";if(s)return cr(r)&&Te(r.bin)?"vertical":"horizontal";if(t===Be){if(e.x&&!e.y)return"vertical";if(e.y&&!e.x)return"horizontal"}case He:case $e:const a=cr(e.x)&&vr(e.x),c=cr(e.y)&&vr(e.y);if(a&&!c)return"tick"!==t?"horizontal":"vertical";if(!a&&c)return"tick"!==t?"vertical":"horizontal";if(a&&c){const r=e.x,i=e.y,s=r.type===Xn,o=i.type===Xn;return s&&!o?"tick"!==t?"vertical":"horizontal":!s&&o?"tick"!==t?"horizontal":"vertical":!r.aggregate&&i.aggregate?"tick"!==t?"vertical":"horizontal":r.aggregate&&!i.aggregate?"tick"!==t?"horizontal":"vertical":n||"vertical"}return n||void 0}return"vertical"}(r.type,e,i),void 0!==i&&i!==r.orient&&mn(hn.orientOverridden(r.orient,i)),void 0===at(r.opacity,Wo("opacity",r,n))&&(r.opacity=function(t,e){if(N([qe,$e,Qe,Ke],t)&&!Br(e))return.7;return}(r.type,e)),void 0===r.filled&&(r.filled=function(t,e){const n=Wo("filled",t,e),r=t.type;return at(n,r!==qe&&r!==He&&r!==Be)}(r,n)),void 0===(r.cursor||Wo("cursor",r,n))&&(r.cursor=function(t,e,n){if(e.href||t.href||Wo("href",t,n))return"pointer";return t.cursor}(r,e,n)),r}class Xd extends id{constructor(t,e,n,r={},i,s,o){super(t,e,n,s,i,void 0),this.fit=o,this.type="unit",this.specifiedScales={},this.specifiedAxes={},this.specifiedLegends={},this.specifiedProjection={},this.selection={},this.children=[],this.initSize(Object.assign({},r,t.width?{width:t.width}:{},t.height?{height:t.height}:{}));const a=De(t.mark)?t.mark.type:t.mark,c=this.encoding=Kr(function(t,e){return Ud(t,e)}(t.encoding||{},i),a);this.markDef=Jd(t.mark,c,s),this.stack=qs(a,c,this.config.stack),this.specifiedScales=this.initScales(a,c),this.specifiedAxes=this.initAxes(c),this.specifiedLegends=this.initLegend(c),this.specifiedProjection=t.projection,this.selection=t.selection}get hasProjection(){const{encoding:t}=this,e=this.mark===Ve,n=t&&ae.some(e=>cr(t[e]));return e||n}scaleDomain(t){const e=this.specifiedScales[t];return e?e.domain:void 0}axis(t){return this.specifiedAxes[t]}legend(t){return this.specifiedLegends[t]}initScales(t,e){return je.reduce((t,n)=>{let r,i;const s=e[n];return cr(s)?(r=s,i=s.scale):or(s)&&(r=s.condition,i=s.condition.scale),r&&(t[n]=i||{}),t},{})}initAxes(t){return[It,Tt].reduce((e,n)=>{const r=t[n];if(cr(r)||n===It&&cr(t.x2)||n===Tt&&cr(t.y2)){const t=cr(r)?r.axis:null;null!==t&&(e[n]=Object.assign({},t))}return e},{})}initLegend(t){return Oe.reduce((e,n)=>{const r=t[n];if(r){const t=cr(r)?r.legend:or(r)?r.condition.legend:null;null!==t&&!1!==t&&(e[n]=Object.assign({},t))}return e},{})}parseData(){this.component.data=Cd(this)}parseLayoutSize(){!function(t){const e=t.component.layoutSize;if(!e.explicit.width){const n=Ld(t,"width");e.set("width",n,!1)}if(!e.explicit.height){const n=Ld(t,"height");e.set("height",n,!1)}}(this)}parseSelection(){this.component.selection=function(t,e){const n={},r=t.config.selection;e&&(e=L(e));for(let i in e){if(!e.hasOwnProperty(i))continue;const s=e[i],o=r[s.type];for(const t in o)"encodings"===t&&s.fields||"fields"===t&&s.encodings||("mark"===t&&(s[t]=Object.assign({},o[t],s[t])),void 0!==s[t]&&!0!==s[t]||(s[t]=o[t]||s[t]));const c=n[i=D(i)]=Object.assign({},s,{name:i,events:a(s.on)?nu(s.on,"scope"):s.on});Wu(c,e=>{e.parse&&e.parse(t,s,c)})}return n}(this,this.selection)}parseMarkGroup(){this.component.mark=bd(this)}parseAxisAndHeader(){var t;this.component.axes=(t=this,ye.reduce((e,n)=>(t.component.scales[n]&&t.axis(n)&&(e[n]=[Kd(n,t)]),e),{}))}assembleSelectionTopLevelSignals(t){return function(t,e){let n=!1;Ju(t,(r,i)=>{const s=r.name,o=c(s+$u);e.filter(t=>t.name===s).length||e.push({name:r.name,update:`${Vu}(${o}`+("global"===r.resolve?")":`, ${c(r.resolve)})`)}),n=!0,i.topLevelSignals&&(e=i.topLevelSignals(t,r,e)),Wu(r,n=>{n.topLevelSignals&&(e=n.topLevelSignals(t,r,e))})}),n&&(e.filter(t=>"unit"===t.name).length||e.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]}));return e}(this,t)}assembleSelectionSignals(){return e=[],Ju(t=this,(n,r)=>{const i=n.name;let s=r.modifyExpr(t,n);e.push(...r.signals(t,n)),Wu(n,r=>{r.signals&&(e=r.signals(t,n,e)),r.modifyExpr&&(s=r.modifyExpr(t,n,s))}),e.push({name:i+Gu,on:[{events:{signal:i+Yu},update:`modify(${c(n.name+$u)}, ${s})`}]})}),e;var t,e}assembleSelectionData(t){return function(t,e){return Ju(t,t=>{e.filter(e=>e.name===t.name+$u).length||e.push({name:t.name+$u})}),e}(this,t)}assembleLayout(){return null}assembleLayoutSignals(){return Dc(this)}assembleMarks(){let t=this.component.mark||[];return this.parent&&nd(this.parent)||(t=Qu(this,t)),t.map(this.correctDataNames)}assembleLayoutSize(){return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}}getMapping(){return this.encoding}toSpec(t,e){const n=L(this.encoding);let r;return r={mark:this.markDef,encoding:n},t||(r.config=L(this.config)),e||(r.data=L(this.data)),r}get mark(){return this.markDef.type}channelHasField(t){return Gr(this.encoding,t)}fieldDef(t){return Tr(this.encoding[t])}}class Zd extends rd{constructor(t,e,n,r,i,s,o){super(t,e,n,s,i,t.resolve),this.type="layer";const a=Object.assign({},r,t.width?{width:t.width}:{},t.height?{height:t.height}:{});this.initSize(a),this.children=t.layer.map((t,e)=>{if(Bs(t))return new Zd(t,this,this.getName("layer_"+e),a,i,s,o);if(Fs(t))return new Xd(t,this,this.getName("layer_"+e),a,i,s,o);throw new Error(hn.INVALID_SPEC)})}parseData(){this.component.data=Cd(this);for(const t of this.children)t.parseData()}parseLayoutSize(){_d(this)}parseSelection(){this.component.selection={};for(const t of this.children)t.parseSelection(),K(t.component.selection).forEach(e=>{this.component.selection[e]=t.component.selection[e]})}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxisAndHeader(){!function(t){const{axes:e,resolve:n}=t.component,r={top:0,bottom:0,right:0,left:0};for(const r of t.children){r.parseAxisAndHeader();for(const i of K(r.component.axes))n.axis[i]=wl(t.component.resolve,i),"shared"===n.axis[i]&&(e[i]=Bd(e[i],r.component.axes[i]),e[i]||(n.axis[i]="independent",delete e[i]))}for(const i of[It,Tt])for(const s of t.children)if(s.component.axes[i]){if("independent"===n.axis[i]){e[i]=(e[i]||[]).concat(s.component.axes[i]);for(const t of s.component.axes[i]){const{value:e,explicit:n}=t.getWithExplicit("orient");if(r[e]>0&&!n){const n=Gd[e];r[e]>r[n]&&t.set("orient",n,!1)}r[e]++}}delete s.component.axes[i]}}(this)}assembleSelectionTopLevelSignals(t){return this.children.reduce((t,e)=>e.assembleSelectionTopLevelSignals(t),t)}assembleSelectionSignals(){return this.children.reduce((t,e)=>t.concat(e.assembleSelectionSignals()),[])}assembleLayoutSignals(){return this.children.reduce((t,e)=>t.concat(e.assembleLayoutSignals()),Dc(this))}assembleSelectionData(t){return this.children.reduce((t,e)=>e.assembleSelectionData(t),t)}assembleTitle(){let t=super.assembleTitle();if(t)return t;for(const e of this.children)if(t=e.assembleTitle())return t}assembleLayout(){return null}assembleMarks(){return function(t,e){for(const n of t.children)Df(n)&&(e=Qu(n,e));return e}(this,q(this.children.map(t=>t.assembleMarks())))}assembleLegends(){return this.children.reduce((t,e)=>t.concat(e.assembleLegends()),Jl(this))}}class Dd extends Hd{constructor(t,e,n,r,i){super(t,e,n,i,r,t.resolve),this.type="repeat",t.resolve&&t.resolve.axis&&("shared"===t.resolve.axis.x||"shared"===t.resolve.axis.y)&&mn(hn.REPEAT_CANNOT_SHARE_AXIS),this.repeat=t.repeat,this.children=this._initChildren(t,this.repeat,r,i)}_initChildren(t,e,n,r){const i=[],s=e.row||[n?n.row:null],o=e.column||[n?n.column:null];for(const e of s)for(const n of o){const s=(e?"_"+e:"")+(n?"_"+n:""),o={row:e,column:n};i.push(Fd(t.spec,this,this.getName("child"+s),void 0,o,r,!1))}return i}parseLayoutSize(){Ad(this)}assembleDefaultLayout(){return{columns:this.repeat&&this.repeat.column?this.repeat.column.length:1,bounds:"full",align:"all"}}}function Fd(t,e,n,r,i,s,o){if(jn(t))return new Nd(t,e,n,i,s);if(Bs(t))return new Zd(t,e,n,r,i,s,o);if(Fs(t))return new Xd(t,e,n,r,i,s,o);if(Vs(t))return new Dd(t,e,n,i,s);if($s(t))return new qd(t,e,n,i,s);throw new Error(hn.INVALID_SPEC)}function tp(t,e){if(jn(t)||Vs(t))return function(t,e){const{spec:n}=t,r=Lt(t,["spec"]);return Object.assign({},r,{spec:tp(n,e)})}(t,e);if(Bs(t))return function(t,e){const{layer:n}=t,r=Lt(t,["layer"]);return Object.assign({},r,{layer:n.map(t=>tp(t,e))})}(t,e);if(Fs(t))return function(t,e){if(t.encoding){const{encoding:n,transform:r}=t,i=Lt(t,["encoding","transform"]),{bins:s,timeUnits:o,aggregate:a,groupby:c,encoding:u}=Vr(n,e);return Object.assign({transform:[...r||[],...s,...o,...a.length?[{aggregate:a,groupby:c}]:[]]},i,{encoding:u})}return t}(t,e);if(Ys(t))return function(t,e){const{vconcat:n}=t,r=Lt(t,["vconcat"]);return Object.assign({},r,{vconcat:n.map(t=>tp(t,e))})}(t,e);if(Gs(t))return function(t,e){const{hconcat:n}=t,r=Lt(t,["hconcat"]);return Object.assign({},r,{hconcat:n.map(t=>tp(t,e))})}(t,e);throw new Error(hn.INVALID_SPEC)}const ep=e;t.aggregate=yt,t.axis=zt,t.bin=Ne,t.channel=ze,t.compositeMark=Oi,t.config=Ss,t.data=As,t.datetime=En,t.encoding=Dr,t.fieldDef=Yr,t.header=Ts,t.legend=Ii,t.mark=ln,t.scale=us,t.sort=Ms,t.spec=no,t.stack=Ws,t.timeUnit=Vn,t.transform=zo,t.type=tr,t.util=lt,t.validate=To,t.version=ep,t.compile=function(t,e={}){var n;e.logger&&(n=e.logger,pn=n),e.fieldTitle&&Er(e.fieldTitle);try{const n=hs(W({},e.config,t.config)),r=Qs(t,n),i=function(t,e,n=!0){const r=Object.assign({type:"pad"},Ro(e),Ro(t));return"fit"===r.type&&(n||(mn(hn.FIT_NON_SINGLE),r.type="pad")),r}(t.autosize,n.autosize,Bs(r)||Fs(r)),s=Fd(r,null,"",void 0,void 0,n,"fit"===i.type);return s.parse(),function(t){sf(t.sources);let e=0,n=0;for(let n=0;n<Ef&&wf(t);n++)e++;t.sources.map(xf);for(let e=0;e<Ef&&wf(t);e++)n++;sf(t.sources),Math.max(e,n)===Ef&&mn(`Maximum optimization runs(${Ef}) reached.`)}(s.component.data),function(t,e,n={},r){const i=t.config?xs(t.config):void 0,s=[].concat(t.assembleSelectionData([]),function(t,e){const n=[],r=jd(n);let i=0;t.sources.forEach(t=>{t.hasName()||(t.dataName=`source_${i++}`);const e=t.assemble();r(t,e)}),n.forEach(t=>{0===t.transform.length&&delete t.transform});let s=0;for(let t=0;t<n.length;t++){const e=n[t];0!==(e.transform||[]).length||e.source||n.splice(s++,0,n.splice(t,1)[0])}for(const e of n)for(const n of e.transform||[])"lookup"===n.type&&(n.from=t.outputNodes[n.from].getSource());for(const t of n)t.name in e&&(t.values=e[t.name]);return n}(t.component.data,n)),o=t.assembleProjections(),a=t.assembleTitle(),c=t.assembleGroupStyle();let u=t.assembleLayoutSignals();return u=u.filter(t=>"width"!==t.name&&"height"!==t.name||void 0===t.value||(e[t.name]=+t.value,!1)),{spec:Object.assign({$schema:"https://vega.github.io/schema/vega/v4.json"},t.description?{description:t.description}:{},e,a?{title:a}:{},c?{style:c}:{},{data:s},o.length>0?{projections:o}:{},t.assembleGroup([...u,...t.assembleSelectionTopLevelSignals([])]),i?{config:i}:{},r?{usermeta:r}:{})}}(s,function(t,e,n){return Object.assign({autosize:1===K(n).length&&n.type?n.type:n},Mo(e),Mo(t))}(t,n,i),t.datasets,t.usermeta)}finally{e.logger&&(pn=fn),e.fieldTitle&&jr()}},t.extractTransforms=tp,Object.defineProperty(t,"__esModule",{value:!0})});